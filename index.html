<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Bathhouse Categorizer</title>

  <!-- Plaid + Supabase -->
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CSV + Excel -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:20px;background:#f4f4f4;}
    h2{text-align:center;margin:6px 0 14px;}
    .panel{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 25px rgba(0,0,0,.08);margin-bottom:15px;}
    button{cursor:pointer;border:none;border-radius:10px;padding:12px;font-weight:600;}
    input,select,textarea{
      padding:12px;border-radius:10px;border:1px solid #ddd;width:100%;
      font-size:16px;box-sizing:border-box;
    }

    .row{display:flex;gap:10px;}
    .row > * { flex: 1; }
    .small{font-size:13px;color:#555;}
    .muted{color:#777;}
    .navBtn{width:48%;background:#444;color:#fff;}
    .category-btn{width:100%;margin-bottom:6px;color:#fff;}
    .cogs{background:#2e7d32;}
    .expense{background:#1565c0;}
    .special{background:#8e24aa;}
    .warn{background:#ff9800;color:#fff;}
    .danger{background:#c62828;color:#fff;}
    .black{background:#000;color:#fff;}
    .viewBtn{background:#1565c0;color:#fff;margin-top:8px;}
    .removeBtn{background:#c62828;color:#fff;margin-top:8px;}

    .progress-bar-container{background:#eee;border-radius:999px;overflow:hidden;height:16px;margin-bottom:8px;}
    .progress-bar{height:100%;background:#2e7d32;width:0%;}
    .totalRow{display:flex;justify-content:space-between;font-size:13px;padding:8px 0;cursor:pointer;border-bottom:1px solid #eee;}
    .totalRow:hover{background:#f5f5f5;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f1f1;font-size:13px;}
    .hr{border-top:1px solid #eee;margin:12px 0;}

    /* Modal */
    .modalOverlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.6);
      display:none;justify-content:center;align-items:center;
      z-index:100000;
      overflow:auto;
      padding: 10px;
      box-sizing: border-box;
    }
    .modalBox{
      background:#fff;width:98%;max-width:1100px;height:90vh;border-radius:16px;
      display:flex;flex-direction:column;overflow:hidden;
    }
    .modalHeader{
      padding:12px 12px 8px;border-bottom:1px solid #eee;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalHeader h3{margin:0;font-size:18px;}
    #modalContent{flex:1;overflow:auto;padding:12px;}
    .modalClose{background:#c62828;color:#fff;width:100%;}
    .modalItem{padding:10px;border-bottom:1px solid #eee;cursor:pointer;}
    .modalItem:hover{background:#f5f5f5;}

    /* Receipt preview */
    .receiptPreview iframe{width:100%;height:85vh;border:none;border-radius:10px;}
    .receiptPreview img{width:100%;max-height:85vh;object-fit:contain;}

    /* Bottom sheet category picker */
    .pickerOverlay{
      position:fixed;left:0;bottom:0;width:100%;
      max-height:55vh;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:0 -4px 20px rgba(0,0,0,.2);
      overflow:auto;z-index:400000;
      padding:12px 12px calc(14px + env(safe-area-inset-bottom, 0px));
      box-sizing:border-box;
      border-top:1px solid #eee;
      backdrop-filter: blur(6px);
    }
    .pickerRow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .infoBtn{
      flex-shrink:0;width:36px;height:36px;border-radius:50%;
      border:none;background:#eee;font-weight:800;
    }

    /* Receipt review layout */
    .receiptGrid{display:flex;gap:12px;height:75vh;}
    .receiptLeft{width:55%;overflow:auto;background:#000;border-radius:12px;}
    .receiptRight{width:45%;overflow:auto;padding-right:6px;}
    .receiptCard{
      background:#fff;border-radius:12px;padding:10px;margin-bottom:8px;border:1px solid #eee;
    }
    .receiptCard.accepted{border:2px solid #2e7d32;opacity:.65;}
    .receiptSticky{
      position:sticky;bottom:0;background:#fff;padding:12px;border-radius:14px;
      box-shadow:0 -4px 20px rgba(0,0,0,.08);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-weight:700;
    }

    /* Tiny helpers */
    .mt8{margin-top:8px;}
    .mb8{margin-bottom:8px;}
  </style>
</head>

<body>
  <h2>Bathhouse Categorizer</h2>

  <!-- AUTH PANEL -->
  <div id="authPanel" class="panel">
    <h3 style="margin-top:0;">Login</h3>
    <input type="email" id="loginEmail" placeholder="Email" class="mb8" />
    <input type="password" id="loginPassword" placeholder="Password" class="mb8" />
    <button class="category-btn cogs" onclick="login()">Login</button>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="panel">
      <div class="row">
        <button class="category-btn warn" onclick="openSearchModal()">üîé Search</button>
        <button id="clearSearchBtn" class="category-btn danger" style="display:none;" onclick="clearSearchFilter()">Clear Search</button>
      </div>

      <div class="row mt8">
        <button class="category-btn expense" onclick="openCreateTransactionModal()">‚ûï Create Transaction</button>
        <button class="category-btn cogs" onclick="connectBank()">üè¶ Connect Bank</button>
      </div>

      <button class="category-btn black mt8" onclick="forcePlaidSync()">üîÑ Sync Bank Now</button>

      <div class="hr"></div>

      <div class="row">
        <div>
          <div class="small muted" style="margin-bottom:6px;">Import CSV</div>
          <input type="file" id="csvFile" accept=".csv" />
        </div>
        <div>
          <div class="small muted" style="margin-bottom:6px;">Year Filter</div>
          <select id="yearFilter" onchange="applyYearFilter()">
            <option value="">All Years</option>
          </select>
        </div>
      </div>

      <div class="progress-bar-container mt8">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div id="positionIndicator" class="small" style="margin-top:4px;"></div>
      <div id="progressText" class="small"></div>

      <div class="row mt8">
        <button class="category-btn danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="panel">
      <h3 id="cardTitle" style="margin-top:0;"></h3>
      <div id="cardMeta" class="small"></div>
      <div id="currentCategory" class="small" style="margin-top:6px;"></div>
      <div id="splitSummary" class="small" style="margin-top:8px;"></div>

      <div class="hr"></div>

      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <button class="navBtn" onclick="goBack()">‚¨Ö Back</button>
        <button class="navBtn" onclick="goNext()">Next ‚û°</button>
      </div>

      <h4 style="margin:8px 0;">Choose Category</h4>
      <div id="categoryButtons"></div>

      <div class="row mt8">
        <button class="category-btn warn" onclick="openSplitHub()">Split Transaction</button>
        <button id="filterToggle" class="category-btn warn" onclick="toggleFilter()">Show Only Uncategorized</button>
      </div>

      <button class="category-btn danger mt8" onclick="resetSplits()">Reset Splits</button>
    </div>

    <div class="panel">
      <h4 style="margin-top:0;">Totals</h4>
      <div id="totals"></div>
      <button class="category-btn expense mt8" onclick="exportExcel()">Export to Excel</button>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay" class="modalOverlay">
    <div class="modalBox">
      <div class="modalHeader">
        <h3 id="modalTitle"></h3>
        <button class="danger" style="padding:10px 12px;" onclick="closeModal()">‚úï</button>
      </div>
      <div id="modalContent"></div>
      <button class="modalClose" onclick="closeModal()">Close</button>
    </div>
  </div>

<script>
/* =========================
   SUPABASE (YOUR EXISTING KEYS)
========================= */
const SUPABASE_URL = "https://xbayklklcdohewvnbglq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiYXlrbGtsY2RvaGV3dm5iZ2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjQ0ODYsImV4cCI6MjA4NzEwMDQ4Nn0.ZPfwZfGGfziSw5CzehkW1S3m40Gf1FOPXeG7Je3Cp7Q";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Edge Function Endpoints (ALL OF YOUR FUNCTIONS) */
const FN = {
  createLinkToken: `${SUPABASE_URL}/functions/v1/create-link-token`,
  exchangeToken: `${SUPABASE_URL}/functions/v1/exchange-token`,
  syncPlaid: `${SUPABASE_URL}/functions/v1/sync-plaid-transactions`,
  syncTransactions: `${SUPABASE_URL}/functions/v1/sync-transactions`,
  askAI: `${SUPABASE_URL}/functions/v1/ask-ai`,
  analyzeReceipt: `${SUPABASE_URL}/functions/v1/analyze-receipt`
};

/* =========================
   UI REFS
========================= */
const appEl = document.getElementById("app");
const authPanel = document.getElementById("authPanel");

const modalOverlay = document.getElementById("modalOverlay");
const modalTitle = document.getElementById("modalTitle");
const modalContent = document.getElementById("modalContent");

const cardTitle = document.getElementById("cardTitle");
const cardMeta = document.getElementById("cardMeta");
const splitSummary = document.getElementById("splitSummary");
const currentCategory = document.getElementById("currentCategory");

const totalsEl = document.getElementById("totals");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const positionIndicator = document.getElementById("positionIndicator");

const clearSearchBtn = document.getElementById("clearSearchBtn");
const yearFilterEl = document.getElementById("yearFilter");
const csvFileEl = document.getElementById("csvFile");

/* =========================
   STATE
========================= */
let data = [];                 // UI-friendly transaction objects
let currentIndex = 0;          // index in data[]
let showOnlyUncategorized = false;
let activeYearFilter = null;
let activeSearchQuery = null;  // { query: string } or null
let aiContext = null;          // { type:'transaction' } or { type:'receipt', itemIndex:number }

/* =========================
   CATEGORIES (UNCHANGED IDEA)
========================= */
const categories = [
  { name:"COGS - Ingredients", class:"cogs", description:`<strong>Definition:</strong><br>Raw materials that physically become part of a finished Bathhouse product.<br><br><strong>Examples:</strong><br>‚Ä¢ Olive oil, coconut oil, shea butter<br>‚Ä¢ Grass-fed tallow<br>‚Ä¢ Essential oils & phthalate-free fragrance oils<br>‚Ä¢ Lye<br>‚Ä¢ Mica, titanium dioxide (in product)<br>‚Ä¢ Goat milk<br>‚Ä¢ Aloe juice (in soap/lotion)<br><br><strong>Does NOT Include:</strong><br>‚Ä¢ Cleaning chemicals<br>‚Ä¢ Soap nuts for cleaning<br>‚Ä¢ Store hand soap<br><br>Ask yourself: Does this physically go inside the product being sold?`},
  { name:"COGS - Packaging", class:"cogs", description:`<strong>Definition:</strong><br>Packaging that becomes part of the product at time of sale.<br><br><strong>Examples:</strong><br>‚Ä¢ Soap boxes<br>‚Ä¢ Shrink wrap<br>‚Ä¢ Product labels<br>‚Ä¢ Ingredient labels<br>‚Ä¢ Jars & pump tops<br>‚Ä¢ Lip balm tubes<br>‚Ä¢ Deodorant tubes<br>‚Ä¢ Inserts inside retail packaging<br><br><strong>Does NOT Include:</strong><br>‚Ä¢ Shipping boxes<br>‚Ä¢ Tissue paper in shipments<br>‚Ä¢ Packing tape<br>‚Ä¢ Shipping labels<br><br>Rule: If it stays attached to the product itself ‚Üí Packaging.`},
  { name:"COGS - Resale Inventory", class:"cogs", description:`Items purchased finished and resold without modification.<br><br>Examples:<br>‚Ä¢ Pumice stones sold as-is<br>‚Ä¢ Sleep masks<br>‚Ä¢ Wholesale accessories`},
  { name:"COGS - Production Supplies", class:"cogs", description:`Consumables used during production but not in final product.<br><br>Examples:<br>‚Ä¢ Gloves<br>‚Ä¢ Mixing sticks<br>‚Ä¢ Alcohol for sanitizing<br>‚Ä¢ Paper towels used in production<br>‚Ä¢ Mold liners`},
  { name:"COGS - Shipping from Suppliers", class:"cogs", description:`Freight-in paid to receive ingredients or inventory.<br><br>Examples:<br>‚Ä¢ Shipping from Wholesale Supplies Plus<br>‚Ä¢ Freight charges on jars<br>‚Ä¢ UPS cost from ingredient vendors`},
  { name:"Shipping Supplies", class:"expense", description:`Materials used to ship orders to customers.<br><br>Examples:<br>‚Ä¢ Shipping boxes<br>‚Ä¢ Tissue paper in shipping box<br>‚Ä¢ Bubble wrap<br>‚Ä¢ Packing tape<br>‚Ä¢ Order stickers<br>‚Ä¢ Shipping label paper<br><br>This is NOT COGS.`},
  { name:"Shipping to Customers", class:"expense", description:`Postage or shipping labels purchased to send orders.<br><br>Examples:<br>‚Ä¢ USPS postage<br>‚Ä¢ UPS postage<br>‚Ä¢ Shopify shipping labels`},
  { name:"Advertising & Marketing", class:"expense", description:`Promotional spending to generate sales.<br><br>Examples:<br>‚Ä¢ Facebook ads<br>‚Ä¢ Google Ads<br>‚Ä¢ Newspaper ads<br>‚Ä¢ Loofah Fest signage<br>‚Ä¢ Canva Pro (if marketing related)`},
  { name:"Commissions & Merchant Fees", class:"expense", description:`Transaction fees charged by payment processors.<br><br>Examples:<br>‚Ä¢ Shopify processing fees<br>‚Ä¢ Square fees<br>‚Ä¢ Faire commission fees`},
  { name:"Software & Subscriptions", class:"expense", description:`Recurring digital tools used to run Bathhouse.<br><br>Examples:<br>‚Ä¢ Shopify subscription<br>‚Ä¢ QuickBooks<br>‚Ä¢ Supabase<br>‚Ä¢ Plaid`},
  { name:"Insurance", class:"expense", description:`Business or product liability insurance.`},
  { name:"Utilities", class:"expense", description:`Electric, water, internet used for business.`},
  { name:"Office Supplies", class:"expense", description:`Office consumables used to operate Bathhouse Trading Company.<br><br>Examples:<br>‚Ä¢ Printer paper<br>‚Ä¢ Receipt paper<br>‚Ä¢ Pens<br>‚Ä¢ File folders<br>‚Ä¢ Storage bins<br>‚Ä¢ Desk organizers<br><br>Does NOT include:<br>‚Ä¢ Product packaging<br>‚Ä¢ Shipping supplies<br>‚Ä¢ Equipment over $2,500 (capital asset)`},
  { name:"Equipment", class:"expense", description:`Business equipment purchases under IRS capitalization threshold.<br><br>Examples:<br>‚Ä¢ Label printer<br>‚Ä¢ Small shelving<br>‚Ä¢ Storage racks<br>‚Ä¢ Small tools<br>‚Ä¢ Washer/dryer (if expensed, not depreciated)<br><br>Note: Larger capital assets may require depreciation.`},
  { name:"Meals", class:"expense", description:`Business meals related to operations.<br><br>Examples:<br>‚Ä¢ Vendor meetings<br>‚Ä¢ Market event meals<br>‚Ä¢ Business planning lunches<br><br>Note: Typically 50% deductible.`},
  { name:"Professional Services", class:"expense", description:`CPA, legal fees, consulting services.`},
  { name:"Fuel", class:"expense", description:`Gas used for markets, supply pickups, or business travel.`},
  { name:"Taxes & Licenses", class:"expense", description:`Business license fees and state filings (not income tax).`},
  { name:"Sales Tax Paid", class:"expense", description:`Sales tax paid on business purchases.<br><br>Examples:<br>‚Ä¢ Sales tax on ingredient purchases<br>‚Ä¢ Sales tax on packaging<br>‚Ä¢ Sales tax on equipment<br><br>This is NOT income tax.`},
  { name:"Interest Expense", class:"expense", description:`Credit card or business loan interest.`},
  { name:"Needs Review", class:"special", description:`If unsure, temporarily park the transaction here.`}
];

/* Optional alias mapping for older category strings */
const categoryAliases = {
  "Software":"Software & Subscriptions",
  "Advertising":"Advertising & Marketing",
  "Gas":"Fuel",
  "Other Interest":"Interest Expense",
  "Office / Admin":"Office Supplies",
  "COGS - Resell Inventory":"COGS - Resale Inventory",
  "NO CATEGORY":"Needs Review",
  "Merchant Processing Fees":"Commissions & Merchant Fees"
};

/* =========================
   AUTH HELPERS
========================= */
async function getAuthHeaders() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) {
    alert("You must be logged in.");
    throw new Error("No session");
  }
  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${session.access_token}`
  };
}

async function login() {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);

  await boot();
}

async function logout() {
  await supabaseClient.auth.signOut();
  data = [];
  currentIndex = 0;
  activeSearchQuery = null;
  activeYearFilter = null;
  showOnlyUncategorized = false;
  authPanel.style.display = "block";
  appEl.style.display = "none";
}

/* =========================
   BOOT + LOAD
========================= */
async function boot() {
  const { data: { session } } = await supabaseClient.auth.getSession();

  if (!session) {
    authPanel.style.display = "block";
    appEl.style.display = "none";
    return;
  }

  authPanel.style.display = "none";
  appEl.style.display = "block";

  renderCategoryButtons();
  await loadTransactions();
}

window.addEventListener("DOMContentLoaded", boot);

async function loadTransactions() {
  const { data: rows, error } = await supabaseClient
    .from("transactions")
    .select("*")
    .order("date", { ascending: true });

  if (error) {
    console.error("Load error:", error);
    alert("Error loading transactions");
    return;
  }

  data = (rows || []).map(r => ({
    id: r.id,
    Title: r.title || r.vendor || "",
    Vendor: r.vendor || "",
    Date: r.date ? String(r.date) : "",
    Amount: typeof r.amount === "number" ? r.amount : (r.amount ? parseFloat(r.amount) : 0),
    Category: r.category || "",
    Splits: r.splits || [],
    receipt_url: r.receipt_url || null,
    Institution: r.institution || "",
    source: r.source || "",
    receipt_analysis: r.receipt_analysis || null
  }));

  populateYearFilter();
  updateTotals();
  updateProgress();
  showCard();
}

/* =========================
   FILTERING / VISIBLE INDEXES
========================= */
function isCategorized(tx) {
  // Categorized if it has a main category OR any splits
  if (tx.Splits && tx.Splits.length) return true;
  return !!(tx.Category && String(tx.Category).trim());
}

function getVisibleIndexes() {
  let list = data.map((_, i) => i);

  if (showOnlyUncategorized) {
    list = list.filter(i => !isCategorized(data[i]));
  }

  if (activeYearFilter) {
    list = list.filter(i => {
      const d = data[i];
      if (!d.Date) return false;
      const year = String(d.Date).slice(0, 4);
      return year === activeYearFilter;
    });
  }

  if (activeSearchQuery && activeSearchQuery.query) {
    const q = activeSearchQuery.query.toLowerCase();
    const qNum = parseFloat(q);
    list = list.filter(i => {
      const d = data[i];
      const v = (d.Vendor || "").toLowerCase();
      const t = (d.Title || "").toLowerCase();
      const matchText = v.includes(q) || t.includes(q) || (d.Institution || "").toLowerCase().includes(q);
      const matchAmt = !isNaN(qNum) && Math.abs((d.Amount || 0) - qNum) < 0.0001;
      return matchText || matchAmt;
    });
  }

  return list;
}

function populateYearFilter() {
  const years = new Set();
  data.forEach(d => {
    if (!d.Date) return;
    const y = String(d.Date).slice(0, 4);
    if (y && !isNaN(parseInt(y, 10))) years.add(y);
  });

  yearFilterEl.innerHTML = `<option value="">All Years</option>`;
  Array.from(years).sort((a, b) => b - a).forEach(y => {
    yearFilterEl.innerHTML += `<option value="${y}">${y}</option>`;
  });
}

function applyYearFilter() {
  const val = yearFilterEl.value;
  activeYearFilter = val || null;
  currentIndex = 0;
  updateTotals();
  updateProgress();
  showCard();
}

function toggleFilter() {
  showOnlyUncategorized = !showOnlyUncategorized;
  const btn = document.getElementById("filterToggle");
  if (btn) btn.innerText = showOnlyUncategorized ? "Show All Transactions" : "Show Only Uncategorized";
  currentIndex = 0;
  updateTotals();
  updateProgress();
  showCard();
}

/* =========================
   NAVIGATION
========================= */
function goNext() {
  const visible = getVisibleIndexes();
  const pos = visible.indexOf(currentIndex);
  if (pos < visible.length - 1) {
    currentIndex = visible[pos + 1];
    showCard();
  }
}
function goBack() {
  const visible = getVisibleIndexes();
  const pos = visible.indexOf(currentIndex);
  if (pos > 0) {
    currentIndex = visible[pos - 1];
    showCard();
  }
}

/* =========================
   CARD RENDER
========================= */
function showCard() {
  if (!data.length) {
    cardTitle.innerText = "No Transactions";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    positionIndicator.innerText = "";
    return;
  }

  const visible = getVisibleIndexes();
  if (!visible.length) {
    cardTitle.innerText = "No Transactions Found";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    positionIndicator.innerText = "";
    return;
  }

  if (!visible.includes(currentIndex)) currentIndex = visible[0];

  const pos = visible.indexOf(currentIndex) + 1;
  positionIndicator.innerText = `Transaction ${pos} of ${visible.length}`;

  const item = data[currentIndex];

  cardTitle.innerText = item.Title || item.Vendor || "Untitled Transaction";

  const receiptLine = item.receipt_url
    ? `
      <div class="pill mt8">üìé Receipt Attached</div>
      <div class="row mt8">
        <button class="viewBtn" onclick="viewReceipt()">View Receipt</button>
        <button class="removeBtn" onclick="removeReceipt()">Remove Attachment</button>
      </div>
    `
    : `<div class="pill mt8">No receipt attached</div>`;

  cardMeta.innerHTML = `
    ${item.Vendor ? `Vendor: ${escapeHtml(item.Vendor)}<br>` : ""}
    ${item.Institution ? `Account: ${escapeHtml(item.Institution)}<br>` : ""}
    ${item.Date ? `Date: ${escapeHtml(item.Date)}<br>` : ""}
    Amount: <strong>$${Number(item.Amount || 0).toFixed(2)}</strong><br>
    ${item.source ? `Source: ${escapeHtml(item.source)}<br>` : ""}
    ${receiptLine}
    <div class="mt8">
      <input type="file" accept="image/*,.pdf" onchange="attachReceipt(event)" />
    </div>

    <div class="row mt8">
      <button class="category-btn black" onclick="askAIForTransaction()">ü§ñ Ask AI</button>
      <button class="category-btn danger" onclick="deleteTransaction()">Delete</button>
    </div>
  `;

  renderSplitSummaryInline(item);

  if (item.Splits && item.Splits.length) {
    currentCategory.innerText = "Split into multiple categories";
  } else {
    currentCategory.innerText = "Current: " + (item.Category || "‚Äî");
  }
}

function renderSplitSummaryInline(item) {
  if (item.Splits && item.Splits.length) {
    let html = "<strong>Split Allocation:</strong><br>";
    item.Splits.forEach(s => {
      html += `${escapeHtml(normalizeCategoryName(s.Category))}: $${Number(s.Amount || 0).toFixed(2)}<br>`;
    });
    splitSummary.innerHTML = html;
  } else {
    splitSummary.innerHTML = "";
  }
}

function normalizeCategoryName(cat) {
  if (!cat) return cat;
  return categoryAliases[cat] || cat;
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   CATEGORY BUTTONS
========================= */
function renderCategoryButtons() {
  const wrap = document.getElementById("categoryButtons");
  wrap.innerHTML = "";

  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.className = "category-btn " + cat.class;

    btn.innerHTML = `
      <span>${escapeHtml(cat.name)}</span>
      <span style="
        margin-left:8px;background:#fff;color:#000;border-radius:50%;
        width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;
        font-size:12px;font-weight:900;cursor:pointer;
      " title="Info">i</span>
    `;

    btn.onclick = () => categorizeTransaction(cat.name);

    // info click
    btn.querySelector("span[title='Info']").onclick = (e) => {
      e.stopPropagation();
      showCategoryInfo(cat.name);
    };

    wrap.appendChild(btn);
  });
}

function showCategoryInfo(name) {
  const cat = categories.find(c => c.name === name);
  if (!cat) return;

  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.background = "rgba(0,0,0,0.55)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "999999";
  overlay.style.padding = "10px";
  overlay.style.boxSizing = "border-box";

  overlay.innerHTML = `
    <div style="
      background:#fff;width:95%;max-width:520px;max-height:80vh;
      border-radius:16px;padding:14px;overflow:auto;box-sizing:border-box;
    ">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
        <h3 style="margin:0;">${escapeHtml(cat.name)}</h3>
        <button class="danger" style="padding:8px 10px;" id="catInfoClose">‚úï</button>
      </div>
      <div style="font-size:14px;line-height:1.5;">
        ${cat.description || "No description available."}
      </div>
    </div>
  `;

  document.body.appendChild(overlay);

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.remove();
  });
  overlay.querySelector("#catInfoClose").onclick = () => overlay.remove();
}

async function categorizeTransaction(name) {
  const item = data[currentIndex];
  item.Category = name;
  item.Splits = [];

  updateTotals();
  updateProgress();
  showCard();

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: name, splits: [] })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving category.");
      return;
    }
  }

  goNext();
}

/* =========================
   TOTALS + PROGRESS
========================= */
function updateTotals() {
  const totalsObj = {};
  categories.forEach(c => totalsObj[c.name] = 0);

  const visible = getVisibleIndexes();

  const add = (cat, amount) => {
    if (!cat || !String(cat).trim()) return;
    cat = normalizeCategoryName(cat);
    if (totalsObj[cat] == null) return;
    totalsObj[cat] += Number(amount || 0);
  };

  visible.forEach(i => {
    const d = data[i];
    if (d.Splits && d.Splits.length) {
      d.Splits.forEach(s => add(s.Category, s.Amount));
    } else {
      add(d.Category, d.Amount);
    }
  });

  totalsEl.innerHTML = "";
  Object.keys(totalsObj).forEach(catName => {
    totalsEl.innerHTML += `
      <div class="totalRow" onclick="showCategoryBreakdown('${catName.replace(/'/g,"\\'")}')">
        <div>${escapeHtml(catName)}</div>
        <div>$${totalsObj[catName].toFixed(2)}</div>
      </div>
    `;
  });
}

function updateProgress() {
  const visible = getVisibleIndexes();
  const total = visible.length;
  const done = visible.filter(i => isCategorized(data[i])).length;
  const pct = total ? Math.round((done / total) * 100) : 0;
  progressBar.style.width = pct + "%";
  progressText.innerText = `${done} of ${total} categorized (${pct}%)`;
}

/* =========================
   SEARCH
========================= */
function openSearchModal() {
  modalTitle.innerText = "Search Transactions";
  modalContent.innerHTML = `
    <input type="text" id="searchInput" placeholder="Search vendor/title/account or amount..." class="mb8" />
    <div id="searchResults"></div>
  `;
  openModal();

  const input = document.getElementById("searchInput");
  input.focus();
  input.addEventListener("input", () => updateSearchResults(input.value));
}

function updateSearchResults(val) {
  const q = String(val || "").trim();
  const results = document.getElementById("searchResults");
  results.innerHTML = "";
  if (!q) return;

  const visible = getVisibleIndexes();
  const qLower = q.toLowerCase();
  const qNum = parseFloat(qLower);

  const hits = [];
  visible.forEach(i => {
    const d = data[i];
    const vendor = (d.Vendor || "").toLowerCase();
    const title = (d.Title || "").toLowerCase();
    const acct = (d.Institution || "").toLowerCase();
    const matchText = vendor.includes(qLower) || title.includes(qLower) || acct.includes(qLower);
    const matchAmt = !isNaN(qNum) && Math.abs((d.Amount || 0) - qNum) < 0.0001;
    if (matchText || matchAmt) hits.push(i);
  });

  if (!hits.length) {
    results.innerHTML = `<div class="small muted">No matches.</div>`;
    return;
  }

  hits.slice(0, 200).forEach(i => {
    const d = data[i];
    results.innerHTML += `
      <div class="modalItem" onclick="jumpToIndex(${i})">
        ${escapeHtml(d.Vendor || d.Title || "Untitled")} ‚Äî $${Number(d.Amount||0).toFixed(2)}
        ${d.Date ? `<div class="small muted">${escapeHtml(d.Date)}</div>` : ""}
      </div>
    `;
  });
}

function jumpToIndex(i) {
  currentIndex = i;
  activeSearchQuery = { query: document.getElementById("searchInput")?.value?.trim() || "" };
  clearSearchBtn.style.display = activeSearchQuery.query ? "block" : "none";
  closeModal();
  updateTotals();
  updateProgress();
  showCard();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function clearSearchFilter() {
  activeSearchQuery = null;
  clearSearchBtn.style.display = "none";
  currentIndex = 0;
  updateTotals();
  updateProgress();
  showCard();
}

/* =========================
   CREATE / DELETE TRANSACTION
========================= */
function openCreateTransactionModal() {
  modalTitle.innerText = "Create Transaction";
  modalContent.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;">
      <label>Vendor</label>
      <input type="text" id="newVendor" placeholder="Vendor name" />

      <label>Date</label>
      <input type="date" id="newDate" />

      <label>Amount</label>
      <input type="number" step="0.01" id="newAmount" placeholder="0.00" />

      <button class="category-btn expense" onclick="saveNewTransaction()">Save Transaction</button>
    </div>
  `;
  openModal();
}

async function saveNewTransaction() {
  const vendor = document.getElementById("newVendor").value.trim();
  const date = document.getElementById("newDate").value;
  const amount = parseFloat(document.getElementById("newAmount").value);

  if (!vendor || !date || isNaN(amount)) return alert("Please complete all fields.");

  const res = await fetch(FN.syncTransactions, {
    method: "POST",
    headers: await getAuthHeaders(),
    body: JSON.stringify({
      title: vendor,
      vendor: vendor,
      date: date,            // YYYY-MM-DD
      amount: amount,
      category: "",
      source: "manual"
    })
  });

  const out = await res.json();
  if (!res.ok) {
    console.error(out);
    alert("Error saving transaction");
    return;
  }

  closeModal();
  await loadTransactions();

  // Jump to newest matching row (best-effort)
  const idx = data.findIndex(d => d.Date === date && Math.abs(d.Amount - amount) < 0.0001 && (d.Vendor || d.Title) === vendor);
  currentIndex = idx >= 0 ? idx : 0;
  showCard();
}

async function deleteTransaction() {
  if (!confirm("Delete this transaction?")) return;

  const item = data[currentIndex];
  if (!item?.id) return;

  const { error } = await supabaseClient.from("transactions").delete().eq("id", item.id);
  if (error) {
    console.error(error);
    alert("Delete failed");
    return;
  }

  data.splice(currentIndex, 1);
  if (currentIndex >= data.length) currentIndex = Math.max(0, data.length - 1);

  updateTotals();
  updateProgress();
  showCard();
}

/* =========================
   CSV IMPORT (with mapping)
========================= */
csvFileEl.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return alert("You must be logged in.");

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async (res) => {
      const rows = res.data || [];
      if (!rows.length) return alert("CSV appears empty.");

      const headers = Object.keys(rows[0] || {});
      openCsvMappingModal(headers, rows.slice(0, 5), rows, session.user.id);
    }
  });
});

function openCsvMappingModal(headers, previewRows, fullRows, userId) {
  modalTitle.innerText = "CSV Import Mapping";

  const options = headers.map(h => `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join("");

  modalContent.innerHTML = `
    <div class="small muted mb8">
      Map your CSV columns to the transactions table fields. Then click Import.
    </div>

    <div style="display:flex;flex-direction:column;gap:10px;">
      <div>
        <label>Date (YYYY-MM-DD preferred)</label>
        <select id="map_date">${options}</select>
      </div>
      <div>
        <label>Vendor</label>
        <select id="map_vendor">${options}</select>
      </div>
      <div>
        <label>Title (optional)</label>
        <select id="map_title">
          <option value="">(none)</option>
          ${options}
        </select>
      </div>
      <div>
        <label>Amount</label>
        <select id="map_amount">${options}</select>
      </div>
      <div>
        <label>Category (optional)</label>
        <select id="map_category">
          <option value="">(none)</option>
          ${options}
        </select>
      </div>
      <div>
        <label>Institution (optional)</label>
        <select id="map_institution">
          <option value="">(none)</option>
          ${options}
        </select>
      </div>

      <div class="hr"></div>

      <div class="small muted">Preview (first 5 rows)</div>
      <div style="overflow:auto;border:1px solid #eee;border-radius:12px;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr>
              ${headers.map(h => `<th style="text-align:left;padding:8px;border-bottom:1px solid #eee;background:#fafafa;">${escapeHtml(h)}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${previewRows.map(r => `
              <tr>
                ${headers.map(h => `<td style="padding:8px;border-bottom:1px solid #f2f2f2;">${escapeHtml(r[h])}</td>`).join("")}
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>

      <button class="category-btn cogs mt8" onclick='importCsvNow(${JSON.stringify({ headers, userId }).replace(/</g,"\\u003c")})'>
        Import CSV
      </button>
    </div>
  `;

  // best-effort auto-select common names
  setSelectBest("map_date", headers, ["date","Date","transaction_date","Transaction Date"]);
  setSelectBest("map_vendor", headers, ["vendor","Vendor","merchant","Merchant","name","Name"]);
  setSelectBest("map_title", headers, ["title","Title","description","Description"]);
  setSelectBest("map_amount", headers, ["amount","Amount","total","Total","net","Net"]);
  setSelectBest("map_category", headers, ["category","Category"]);
  setSelectBest("map_institution", headers, ["institution","Institution","account","Account"]);

  // stash rows globally for import
  window.__CSV_IMPORT_ROWS__ = fullRows;

  openModal();
}

function setSelectBest(selectId, headers, candidates) {
  const el = document.getElementById(selectId);
  if (!el) return;
  for (const c of candidates) {
    if (headers.includes(c)) { el.value = c; return; }
  }
}

async function importCsvNow(meta) {
  const rows = window.__CSV_IMPORT_ROWS__ || [];
  if (!rows.length) return alert("No CSV rows found.");

  const map = {
    date: document.getElementById("map_date").value,
    vendor: document.getElementById("map_vendor").value,
    title: document.getElementById("map_title").value,
    amount: document.getElementById("map_amount").value,
    category: document.getElementById("map_category").value,
    institution: document.getElementById("map_institution").value
  };

  // build insert rows
  const inserts = [];
  for (const r of rows) {
    const rawDate = (r[map.date] ?? "").toString().trim();
    const date = normalizeDateToISO(rawDate); // try to make YYYY-MM-DD
    const vendor = (r[map.vendor] ?? "").toString().trim();
    const title = map.title ? (r[map.title] ?? "").toString().trim() : "";
    const amt = parseFloat((r[map.amount] ?? "").toString().replace(/[^0-9.\-]/g,""));
    const cat = map.category ? (r[map.category] ?? "").toString().trim() : "";
    const inst = map.institution ? (r[map.institution] ?? "").toString().trim() : "";

    if (!vendor || !date || isNaN(amt)) continue;

    inserts.push({
      user_id: meta.userId,
      date: date,
      vendor: vendor,
      title: title || vendor,
      amount: amt,
      category: cat || "",
      splits: [],
      source: "csv",
      institution: inst || null
    });
  }

  if (!inserts.length) return alert("No valid rows to import. Check mapping/date/amount formatting.");

  // chunk insert for safety
  const chunkSize = 500;
  for (let i = 0; i < inserts.length; i += chunkSize) {
    const chunk = inserts.slice(i, i + chunkSize);
    const { error } = await supabaseClient.from("transactions").insert(chunk);
    if (error) {
      console.error(error);
      alert("CSV import failed.");
      return;
    }
  }

  closeModal();
  csvFileEl.value = "";
  await loadTransactions();
  alert(`Imported ${inserts.length} rows.`);
}

function normalizeDateToISO(raw) {
  // Accept:
  // - YYYY-MM-DD
  // - M/D/YYYY or MM/DD/YYYY
  // - M-D-YYYY etc.
  const s = String(raw || "").trim();
  if (!s) return "";

  // Already ISO
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // Common US formats
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    let mm = parseInt(m[1], 10);
    let dd = parseInt(m[2], 10);
    let yy = parseInt(m[3], 10);
    if (yy < 100) yy = 2000 + yy;
    const pad = (n) => String(n).padStart(2, "0");
    return `${yy}-${pad(mm)}-${pad(dd)}`;
  }

  return "";
}

/* =========================
   RECEIPTS (Storage)
========================= */
async function attachReceipt(e) {
  const file = e.target.files[0];
  if (!file) return;

  const item = data[currentIndex];
  if (!item?.id) return alert("Transaction must exist before attaching receipt.");

  const fileExt = file.name.split(".").pop();
  const filePath = `receipts/${item.id}.${fileExt}`;

  const { error: uploadError } = await supabaseClient
    .storage
    .from("receipts")
    .upload(filePath, file, { upsert: true });

  if (uploadError) {
    console.error(uploadError);
    alert("Error uploading receipt.");
    return;
  }

  const { error: updateError } = await supabaseClient
    .from("transactions")
    .update({ receipt_url: filePath })
    .eq("id", item.id);

  if (updateError) {
    console.error(updateError);
    alert("Error saving receipt reference.");
    return;
  }

  item.receipt_url = filePath;
  alert("Receipt saved.");
  showCard();
}

async function viewReceipt() {
  const item = data[currentIndex];
  if (!item?.receipt_url) return alert("No receipt attached.");

  const { data: signedData, error } = await supabaseClient
    .storage
    .from("receipts")
    .createSignedUrl(item.receipt_url, 60);

  if (error || !signedData?.signedUrl) {
    console.error(error);
    alert("Unable to load receipt.");
    return;
  }

  const url = signedData.signedUrl;
  const isPDF = url.toLowerCase().includes(".pdf");

  modalTitle.innerText = "Receipt Preview";
  modalContent.innerHTML = isPDF
    ? `<div class="receiptPreview"><iframe src="${url}"></iframe></div>`
    : `
      <div style="width:100%;height:100%;overflow:auto;display:flex;justify-content:center;align-items:flex-start;background:#000;border-radius:12px;">
        <img src="${url}" style="max-width:100%;height:auto;touch-action:manipulation;">
      </div>
    `;
  openModal();
}

async function removeReceipt() {
  const item = data[currentIndex];
  if (!item?.id || !item.receipt_url) return;

  const { error: storageError } = await supabaseClient
    .storage
    .from("receipts")
    .remove([item.receipt_url]);

  if (storageError) {
    console.error(storageError);
    alert("Error deleting file from storage.");
    return;
  }

  const { error: dbError } = await supabaseClient
    .from("transactions")
    .update({ receipt_url: null })
    .eq("id", item.id);

  if (dbError) {
    console.error(dbError);
    alert("Error clearing receipt reference.");
    return;
  }

  item.receipt_url = null;
  item.receipt_analysis = null;
  alert("Receipt removed.");
  showCard();
}

/* =========================
   SPLITS (HUB + MANUAL + RECEIPT REVIEW)
========================= */
function openSplitHub() {
  const item = data[currentIndex];
  modalTitle.innerText = "Split Transaction";

  const remaining = calculateRemaining(item);

  modalContent.innerHTML = `
    <div class="small muted">
      Use receipt analysis for line-item splits, or add splits manually.
    </div>

    <div class="hr"></div>

    <div class="pill">Total: $${Number(item.Amount||0).toFixed(2)}</div>
    <div class="pill">Allocated: $${(Number(item.Amount||0) - remaining).toFixed(2)}</div>
    <div class="pill">Remaining: <strong style="color:${remainingColor(remaining)}">$${remaining.toFixed(2)}</strong></div>

    <div class="hr"></div>

    <div class="row">
      <button class="category-btn warn" onclick="addManualSplit()">‚ûï Add Split Line</button>
      <button class="category-btn danger" onclick="resetSplits()">Reset Splits</button>
    </div>

    <div class="row mt8">
      <button class="category-btn black" onclick="askAIForSplitHelp()">ü§ñ Ask AI (split help)</button>
      <button class="category-btn expense" onclick="openReceiptReview()">üßæ Receipt Review</button>
    </div>

    <div class="hr"></div>

    <div>
      <strong>Current Splits</strong>
      <div id="splitList" class="mt8"></div>
    </div>
  `;

  renderSplitList();
  openModal();
}

function renderSplitList() {
  const item = data[currentIndex];
  const el = document.getElementById("splitList");
  if (!el) return;

  const splits = item.Splits || [];
  if (!splits.length) {
    el.innerHTML = `<div class="small muted">No splits yet.</div>`;
    return;
  }

  el.innerHTML = splits.map((s, idx) => `
    <div class="receiptCard">
      <div style="font-weight:700;">${escapeHtml(normalizeCategoryName(s.Category || "Needs Review"))}</div>
      <div>$${Number(s.Amount||0).toFixed(2)}</div>
      <div class="row mt8">
        <button class="category-btn expense" onclick="changeSplitCategory(${idx})">Change Category</button>
        <button class="category-btn danger" onclick="removeSplit(${idx})">Remove</button>
      </div>
    </div>
  `).join("");
}

function calculateRemaining(item) {
  const total = Number(item.Amount || 0);
  const allocatedCents = (item.Splits || []).reduce((sum, s) => sum + Math.round(Number(s.Amount || 0) * 100), 0);
  const allocated = allocatedCents / 100;
  return parseFloat((total - allocated).toFixed(2));
}

function remainingColor(rem) {
  if (Math.abs(rem) < 0.01) return "green";
  if (rem < 0) return "red";
  return "orange";
}

async function addManualSplit() {
  const item = data[currentIndex];
  const remaining = calculateRemaining(item);
  if (remaining <= 0) return alert("No remaining amount to split.");

  const amountStr = await promptAmount(remaining);
  if (amountStr === null) return;

  let amt = parseFloat(amountStr);
  if (isNaN(amt) || amt <= 0) return alert("Invalid amount.");

  // clamp to remaining (rounding)
  if (Math.abs(amt - remaining) < 0.01) amt = remaining;
  if (amt > remaining + 0.01) return alert("Amount exceeds remaining.");

  const cat = await pickCategory(amt);
  if (!cat) return;

  await applySplit(cat, amt, { type: "manual" });
  renderSplitList();
  showCard();
  updateTotals();
  updateProgress();

  const rem2 = calculateRemaining(item);
  if (Math.abs(rem2) < 0.01) alert("Split complete.");
}

function promptAmount(remaining) {
  return new Promise(resolve => {
    const box = document.createElement("div");
    box.style.position = "fixed";
    box.style.top = "50%";
    box.style.left = "50%";
    box.style.transform = "translate(-50%,-50%)";
    box.style.background = "#fff";
    box.style.padding = "14px";
    box.style.borderRadius = "14px";
    box.style.boxShadow = "0 6px 24px rgba(0,0,0,.25)";
    box.style.zIndex = "999999";
    box.style.width = "min(92vw, 420px)";

    box.innerHTML = `
      <div style="font-weight:800;margin-bottom:8px;">Split Amount</div>
      <div class="small muted" style="margin-bottom:8px;">Remaining: $${remaining.toFixed(2)}</div>
      <input type="number" step="0.01" id="amtInput" value="${remaining.toFixed(2)}" />
      <div class="row mt8">
        <button class="category-btn cogs" id="amtOk">OK</button>
        <button class="category-btn danger" id="amtCancel">Cancel</button>
      </div>
    `;

    document.body.appendChild(box);
    const inp = box.querySelector("#amtInput");
    inp.focus();

    box.querySelector("#amtOk").onclick = () => {
      const v = inp.value;
      box.remove();
      resolve(v);
    };
    box.querySelector("#amtCancel").onclick = () => {
      box.remove();
      resolve(null);
    };
  });
}

async function applySplit(category, amount, meta = {}) {
  const item = data[currentIndex];
  if (!item.Splits) item.Splits = [];

  item.Splits.push({
    Category: category,
    Amount: amount,
    ...(meta || {})
  });

  item.Category = "SPLIT";

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: "SPLIT", splits: item.Splits })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving split.");
    }
  }
}

async function removeSplit(idx) {
  const item = data[currentIndex];
  item.Splits.splice(idx, 1);
  if (!item.Splits.length) item.Category = "";

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: item.Splits.length ? "SPLIT" : "", splits: item.Splits })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving change.");
    }
  }

  renderSplitList();
  showCard();
  updateTotals();
  updateProgress();
}

async function changeSplitCategory(idx) {
  const item = data[currentIndex];
  const amt = Number(item.Splits[idx].Amount || 0);
  const cat = await pickCategory(amt);
  if (!cat) return;

  item.Splits[idx].Category = cat;

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: "SPLIT", splits: item.Splits })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving change.");
    }
  }

  renderSplitList();
  showCard();
  updateTotals();
  updateProgress();
}

async function resetSplits() {
  const item = data[currentIndex];
  if (!item) return;

  if (!confirm("Reset all splits for this transaction?")) return;

  item.Splits = [];
  item.Category = "";
  item.receipt_analysis = null;

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: "", splits: [], receipt_analysis: null })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error resetting splits.");
    }
  }

  updateTotals();
  updateProgress();
  showCard();

  // If split hub open, refresh list
  if (document.getElementById("splitList")) renderSplitList();
}

/* =========================
   RECEIPT REVIEW (Analyze + Accept/Change/Ask AI)
   Uses analyze-receipt edge function (includes SerpAPI + OpenAI inside it)
========================= */
async function openReceiptReview() {
  const item = data[currentIndex];
  if (!item?.receipt_url) return alert("Attach a receipt first.");

  // If we already have receipt_analysis stored on the row, reuse it.
  if (item.receipt_analysis && item.receipt_analysis.items) {
    renderReceiptReview(item, item.receipt_analysis.items, item.receipt_analysis.tax_amount || 0);
    return;
  }

  modalTitle.innerText = "Receipt Review";
  modalContent.innerHTML = `
    <div style="padding:16px;text-align:center;">
      <div class="small muted">Analyzing receipt‚Ä¶ (this uses your analyze-receipt edge function)</div>
      <div class="mt8">‚è≥</div>
    </div>
  `;

  openModal();

  try {
    const res = await fetch(FN.analyzeReceipt, {
      method: "POST",
      headers: await getAuthHeaders(),
      body: JSON.stringify({
        filePath: item.receipt_url,
        categories: categories.map(c => c.name)
      })
    });

    const out = await res.json();
    if (!res.ok) {
      console.error(out);
      alert("Receipt analysis failed.");
      closeModal();
      return;
    }

    const lineItems = out.line_items || [];
    const taxAmount = out.tax_amount || 0;

    // Save receipt_analysis to DB so it persists
    item.receipt_analysis = { items: lineItems, tax_amount: taxAmount };

    if (item.id) {
      await supabaseClient
        .from("transactions")
        .update({ receipt_analysis: item.receipt_analysis })
        .eq("id", item.id);
    }

    // Apply Sales Tax Paid split automatically (once)
    await ensureSalesTaxApplied(taxAmount);

    renderReceiptReview(item, lineItems, taxAmount);

  } catch (err) {
    console.error(err);
    alert("Receipt analysis failed.");
    closeModal();
  }
}

async function ensureSalesTaxApplied(taxAmount) {
  const item = data[currentIndex];
  if (!item) return;

  const tax = parseFloat(taxAmount);
  if (isNaN(tax) || tax <= 0) return;

  const already = (item.Splits || []).some(s => normalizeCategoryName(s.Category) === "Sales Tax Paid");
  if (already) return;

  // prevent over-allocation if tax is already included in line items
  // If line items sum roughly equals total, don't auto-add tax.
  const li = item.receipt_analysis?.items || [];
  const sumLI = li.reduce((sum, x) => sum + Number(x.amount || 0), 0);
  const total = Number(item.Amount || 0);
  const near = (a,b) => Math.abs(a-b) < 0.05;

  if (near(sumLI, total)) return;

  await applySplit("Sales Tax Paid", tax, { type: "tax" });
}

function renderReceiptReview(item, suggestions, taxAmount) {
  const total = Number(item.Amount || 0);

  const allocated = (item.Splits || []).reduce((sum, s) => sum + Number(s.Amount || 0), 0);
  const remaining = parseFloat((total - allocated).toFixed(2));

  modalTitle.innerText = "Review Receipt";

  modalContent.innerHTML = `
    <div class="receiptGrid">

      <div class="receiptLeft">
        <div style="padding:10px;">
          ${item.receipt_url ? `<img id="receiptImage" style="width:100%;height:auto;">` : `
            <div style="color:#fff;display:flex;align-items:center;justify-content:center;height:100%;">No Receipt</div>
          `}
        </div>
      </div>

      <div class="receiptRight">
        ${suggestions.map((s, i) => {
          const existing = (item.Splits || []).find(sp => sp.item_index === i);
          const accepted = !!existing;

          const cat = accepted ? existing.Category : (s.suggested_category || "Needs Review");
          const amt = Number(s.amount || 0);

          return `
            <div class="receiptCard ${accepted ? "accepted" : ""}">
              <div style="font-weight:800;">${escapeHtml(s.normalized_description || s.raw_description || "Item")}</div>
              <div>$${amt.toFixed(2)}</div>
              <div class="small"><strong>${escapeHtml(normalizeCategoryName(cat) || "Needs Review")}</strong></div>

              <div class="row mt8">
                ${!accepted ? `
                  <button class="category-btn cogs" onclick="acceptReceiptItem('${item.id}', ${i})">Accept</button>
                ` : `
                  <button class="category-btn cogs" onclick="acceptReceiptItem('${item.id}', ${i})">Re-Accept</button>
                `}
                <button class="category-btn expense" onclick="changeReceiptItemCategory('${item.id}', ${i})">Change</button>
                <button class="category-btn black" onclick="askAIForReceiptItem(${i})">Ask AI</button>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>

    <div class="receiptSticky">
      <div>Total: $${total.toFixed(2)}</div>
      <div>Allocated: $${allocated.toFixed(2)}</div>
      <div style="color:${remainingColor(remaining)}">Remaining: $${remaining.toFixed(2)}</div>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button class="category-btn warn" onclick="addManualSplit()">‚ûï Add Split Line</button>
      <button class="category-btn danger" onclick="resetSplits()">Reset Splits</button>
    </div>
  `;

  // Load receipt image
  supabaseClient.storage.from("receipts").createSignedUrl(item.receipt_url, 60)
    .then(({ data }) => {
      const img = document.getElementById("receiptImage");
      if (img && data?.signedUrl) img.src = data.signedUrl;
    });
}

async function acceptReceiptItem(itemId, idx) {
  const item = data.find(d => d.id === itemId);
  if (!item || !item.receipt_analysis) return;

  const suggestion = item.receipt_analysis.items[idx];
  const amt = Number(suggestion.amount || 0);
  if (amt <= 0) return alert("Invalid item amount.");

  if (!item.Splits) item.Splits = [];

  let existing = item.Splits.find(s => s.item_index === idx);

  const finalCategory =
    (existing && existing.Category) ||
    suggestion.suggested_category ||
    "Needs Review";

  // =========================
  // üöÄ SAVE LEARNING (NEW)
  // =========================
  try {
    await supabaseClient.from("product_mappings").upsert({
      raw_description: suggestion.raw_description,
      normalized_description: suggestion.normalized_description,
      category: finalCategory
    });
  } catch (err) {
    console.error("Mapping save failed:", err);
  }

  // =========================
  // EXISTING LOGIC (unchanged)
  // =========================
  if (existing) {
    existing.Amount = amt;
    existing.Category = finalCategory;
  } else {
    const rem = calculateRemaining(item);
    if (amt > rem + 0.01) {
      alert("This item exceeds remaining balance.");
      return;
    }

    item.Splits.push({
      item_index: idx,
      Category: finalCategory,
      Amount: amt,
      type: "receipt"
    });
  }

  item.Category = "SPLIT";

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: "SPLIT", splits: item.Splits })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving receipt split.");
      return;
    }
  }

  updateTotals();
  updateProgress();
  renderSplitSummaryInline(item);
  renderReceiptReview(item, item.receipt_analysis.items, item.receipt_analysis.tax_amount || 0);
}

async function changeReceiptItemCategory(itemId, idx) {
  const item = data.find(d => d.id === itemId);
  if (!item || !item.receipt_analysis) return;

  aiContext = { type: "receipt", itemIndex: idx, itemId };
  const amt = Number(item.receipt_analysis.items[idx]?.amount || 0);

  const cat = await pickCategory(amt);
  if (!cat) { aiContext = null; return; }

  await applyReceiptCategory(cat);
}

function askAIForReceiptItem(idx) {
  aiContext = { type: "receipt", itemIndex: idx };

  modalTitle.innerText = "ü§ñ AI Categorization (Receipt Item)";
  modalContent.innerHTML = `
    <div style="padding:10px;">
      <div style="margin-bottom:10px;"><strong>How will this item be used?</strong></div>
      <textarea id="aiUserInput" style="width:100%;height:120px;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;font-size:16px;"></textarea>
      <button class="category-btn black" onclick="submitAIRequest()">Ask AI</button>
    </div>
  `;
  openModal(1000000);
}

function askAIForTransaction() {
  aiContext = { type: "transaction" };

  modalTitle.innerText = "ü§ñ AI Categorization";
  modalContent.innerHTML = `
    <div style="padding:10px;">
      <div style="margin-bottom:10px;"><strong>What was this purchase for?</strong></div>
      <textarea id="aiUserInput" placeholder="Example: packaging supplies, ingredients, resale items, tools..." style="width:100%;height:110px;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;font-size:16px;"></textarea>
      <button class="category-btn black" onclick="submitAIRequest()">Ask AI</button>
    </div>
  `;
  openModal();
}

function askAIForSplitHelp() {
  aiContext = { type: "split_help" };
  modalTitle.innerText = "ü§ñ AI Help (Splits)";
  modalContent.innerHTML = `
    <div style="padding:10px;">
      <div style="margin-bottom:10px;"><strong>Describe what‚Äôs happening with this split:</strong></div>
      <textarea id="aiUserInput" placeholder="Example: 'Sam's Club receipt has packaging, ingredients, and office supplies...'" style="width:100%;height:120px;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;font-size:16px;"></textarea>
      <button class="category-btn black" onclick="submitAIRequest()">Ask AI</button>
    </div>
  `;
  openModal();
}

async function submitAIRequest() {
  const input = document.getElementById("aiUserInput").value.trim();
  if (!input) return alert("Please enter a quick description.");

  modalContent.innerHTML = `
    <div style="padding:20px;text-align:center;">
      ü§ñ Thinking...
    </div>
  `;

  try {
    const res = await fetch(FN.askAI, {
      method: "POST",
      headers: await getAuthHeaders(),
      body: JSON.stringify({
        userInput: input,
        categories: categories.map(c => c.name)
      })
    });

    const out = await res.json();
    if (!res.ok) throw new Error(out.error || "AI failed");

    modalContent.innerHTML = `
      <div style="padding:10px;">
        <div style="font-size:16px;margin-bottom:10px;">
          <strong>Suggested Category:</strong><br>
          <span style="color:#2e7d32;font-size:18px;font-weight:900;">
            ${escapeHtml(out.category)}
          </span>
        </div>

        <div style="margin-bottom:15px;">
          <strong>Reasoning:</strong><br>
          ${escapeHtml(out.reasoning)}<br><br>
          Confidence: <strong>${escapeHtml(out.confidence)}</strong>
        </div>

        <button class="category-btn cogs" onclick="applyAISuggestion('${out.category.replace(/'/g,"\\'")}')">‚úÖ Accept Suggestion</button>
        <button class="category-btn warn mt8" onclick="submitAIRequest()">Try Again</button>
      </div>
    `;
  } catch (err) {
    console.error(err);
    alert("AI failed.");
    closeModal();
  }
}

async function applyAISuggestion(category) {
  // Receipt item mode
  if (aiContext && aiContext.type === "receipt") {
    await applyReceiptCategory(category);
    return;
  }

  // Transaction mode
  const item = data[currentIndex];
  if (!item) return;

  item.Category = category;
  item.Splits = [];

  updateTotals();
  updateProgress();
  showCard();

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category, splits: [] })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving category.");
      return;
    }
  }

  closeModal();
  goNext();
}

async function applyReceiptCategory(category) {
  const item = data[currentIndex];
  if (!item || !item.receipt_analysis) return;

  const idx = aiContext.itemIndex;
  const suggestion = item.receipt_analysis.items[idx];
  const amt = Number(suggestion.amount || 0);
  if (!item.Splits) item.Splits = [];

  let existing = item.Splits.find(s => s.item_index === idx);
  if (existing) {
    existing.Category = category;
  } else {
    const rem = calculateRemaining(item);
    if (amt > rem + 0.01) {
      alert("This item exceeds remaining balance.");
      aiContext = null;
      closeModal();
      return;
    }
    item.Splits.push({ item_index: idx, Category: category, Amount: amt, type: "receipt" });
  }

  item.Category = "SPLIT";

  if (item.id) {
    const { error } = await supabaseClient
      .from("transactions")
      .update({ category: "SPLIT", splits: item.Splits })
      .eq("id", item.id);

    if (error) {
      console.error(error);
      alert("Error saving change.");
    }
  }

  aiContext = null;

  updateTotals();
  updateProgress();
  renderSplitSummaryInline(item);

  // Return to receipt review
  renderReceiptReview(item, item.receipt_analysis.items, item.receipt_analysis.tax_amount || 0);
}

/* =========================
   CATEGORY PICKER (BOTTOM SHEET)
========================= */
function pickCategory(amount) {
  return new Promise(resolve => {
    const overlay = document.createElement("div");
    overlay.className = "pickerOverlay";

    let html = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
        <h3 style="margin:0;">Select Category</h3>
        <button class="danger" style="padding:8px 10px;" id="pickerBack">‚Üê Back</button>
      </div>
      <div class="small muted mb8"><strong>Amount:</strong> $${Number(amount||0).toFixed(2)}</div>
    `;

    categories.forEach(c => {
      html += `
        <div class="pickerRow">
          <button class="category-btn ${c.class}" style="flex:1;min-width:0;text-align:left;" data-cat="${escapeHtml(c.name)}">
            ${escapeHtml(c.name)}
          </button>
          <button class="infoBtn" data-info="${escapeHtml(c.name)}">i</button>
        </div>
      `;
    });

    overlay.innerHTML = html;
    document.body.appendChild(overlay);

    // Category clicks
    overlay.querySelectorAll("button[data-cat]").forEach(btn => {
      btn.onclick = () => {
        const name = btn.getAttribute("data-cat");
        overlay.remove();
        resolve(name);
      };
    });

    // Info clicks
    overlay.querySelectorAll("button[data-info]").forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const name = btn.getAttribute("data-info");
        showCategoryInfo(name);
      };
    });

    overlay.querySelector("#pickerBack").onclick = () => {
      overlay.remove();
      resolve(null);
    };
  });
}

/* =========================
   CATEGORY BREAKDOWN MODAL
========================= */
function showCategoryBreakdown(categoryName) {
  modalTitle.innerText = categoryName + " Transactions";
  const visible = getVisibleIndexes();

  let html = "";
  visible.forEach(i => {
    const d = data[i];

    // main category
    const mainCat = normalizeCategoryName(d.Category);
    if (mainCat === categoryName) {
      html += `
        <div class="modalItem" onclick="jumpToBreakdown(${i})">
          ${escapeHtml(d.Title || d.Vendor || "Untitled")} ‚Äî $${Number(d.Amount||0).toFixed(2)}
          ${d.Date ? `<div class="small muted">${escapeHtml(d.Date)}</div>` : ""}
        </div>
      `;
    }

    // splits
    (d.Splits || []).forEach(s => {
      const sc = normalizeCategoryName(s.Category);
      if (sc === categoryName) {
        html += `
          <div class="modalItem" onclick="jumpToBreakdown(${i})">
            ${escapeHtml(d.Title || d.Vendor || "Untitled")} (Split) ‚Äî $${Number(s.Amount||0).toFixed(2)}
            ${d.Date ? `<div class="small muted">${escapeHtml(d.Date)}</div>` : ""}
          </div>
        `;
      }
    });
  });

  if (!html) html = `<div class="small muted">No transactions in this category.</div>`;

  modalContent.innerHTML = html;
  openModal();
}

function jumpToBreakdown(i) {
  // clear search so the user can see it
  activeSearchQuery = null;
  clearSearchBtn.style.display = "none";

  // clear uncategorized-only view if needed
  if (showOnlyUncategorized && isCategorized(data[i])) {
    showOnlyUncategorized = false;
    const btn = document.getElementById("filterToggle");
    if (btn) btn.innerText = "Show Only Uncategorized";
  }

  currentIndex = i;
  closeModal();
  showCard();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* =========================
   EXPORT
========================= */
function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(data.map(d => ({
    id: d.id,
    vendor: d.Vendor,
    title: d.Title,
    amount: d.Amount,
    date: d.Date,
    category: d.Category,
    splits: JSON.stringify(d.Splits || []),
    institution: d.Institution,
    source: d.source,
    receipt_url: d.receipt_url
  })));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Categorized");
  XLSX.writeFile(wb, "Categorized.xlsx");
}

/* =========================
   PLAID (Connect + Sync) - Uses your edge functions
========================= */
async function connectBank() {
  try {
    const linkRes = await fetch(FN.createLinkToken, {
      method: "POST",
      headers: await getAuthHeaders()
    });
    const linkData = await linkRes.json();

    if (!linkRes.ok || !linkData.link_token) {
      console.error(linkData);
      alert("Failed to create link token.");
      return;
    }

    const handler = Plaid.create({
      token: linkData.link_token,

      onSuccess: async (public_token) => {
        // Exchange token
        const exRes = await fetch(FN.exchangeToken, {
          method: "POST",
          headers: await getAuthHeaders(),
          body: JSON.stringify({ public_token })
        });
        const exData = await exRes.json();

        if (!exRes.ok) {
          console.error(exData);
          alert("Token exchange failed.");
          return;
        }

        // Sync transactions
        const syncRes = await fetch(FN.syncPlaid, {
          method: "POST",
          headers: await getAuthHeaders()
        });
        const syncData = await syncRes.json();

        if (!syncRes.ok) {
          console.error(syncData);
          alert("Transaction sync failed.");
          return;
        }

        await loadTransactions();
        alert("Bank connected and transactions imported!");
      },

      onExit: (err) => {
        if (err) console.log("Plaid exit error:", err);
      }
    });

    handler.open();

  } catch (err) {
    console.error(err);
    alert("Bank connect failed.");
  }
}

async function forcePlaidSync() {
  try {
    const res = await fetch(FN.syncPlaid, {
      method: "POST",
      headers: await getAuthHeaders()
    });

    const out = await res.json();
    if (!res.ok) {
      console.error(out);
      alert("Sync failed");
      return;
    }

    await loadTransactions();
    alert(`Sync complete. Inserted: ${out.inserted ?? "?"}`);
  } catch (err) {
    console.error(err);
    alert("Error triggering sync");
  }
}

/* =========================
   MODAL CONTROLS
========================= */
function openModal(zIndex = 100000) {
  modalOverlay.style.display = "flex";
  modalOverlay.style.zIndex = zIndex;
}
function closeModal() {
  modalOverlay.style.display = "none";
  modalOverlay.style.zIndex = 100000;
  modalContent.innerHTML = "";
  modalTitle.innerText = "";
}
modalOverlay.addEventListener("click", (e) => {
  if (e.target === modalOverlay) closeModal();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeModal();
});
</script>
</body>
</html>