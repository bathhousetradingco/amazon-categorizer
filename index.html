48

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input, select { padding:10px; border-radius:10px; border:1px solid #ddd; width:100%;}
.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:6px 0; cursor:pointer; border-bottom:1px solid #eee;}
.totalRow:hover { background:#f5f5f5; }

.modalOverlay {
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.6);
display:none;
justify-content:center;
align-items:center;
z-index:9999;
}

.modalBox {
background:white;
width:90%;
max-width:800px;
max-height:85%;
overflow:auto;
border-radius:14px;
padding:20px;
position:relative;
}

.modalCloseX {
position:absolute;
top:10px;
right:15px;
font-size:20px;
cursor:pointer;
font-weight:bold;
}

.modalClose {
background:#c62828;
color:white;
margin-top:10px;
width:100%;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">
<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<hr>
<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">⬅ Back</button>
<button class="navBtn" onclick="goNext()">Next ➡</button>
</div>
<h4>Choose Category</h4>
<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Search Transaction</h4>
Vendor:<br>
<input type="text" id="searchVendor" onfocus="openVendorModal()" readonly><br><br>
Amount:<br>
<input type="number" id="searchAmount" step="0.01"><br><br>
<button onclick="applySearch()">Search</button>
<button onclick="clearSearch()">Clear Search</button>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<!-- CATEGORY MODAL -->
<div id="modalOverlay" class="modalOverlay" onclick="outsideClick(event)">
<div class="modalBox">
<div class="modalCloseX" onclick="closeModal()">✕</div>
<h3 id="modalTitle"></h3>
<div id="modalContent"></div>
<button class="modalClose" onclick="closeModal()">Close</button>
</div>
</div>

<!-- VENDOR MODAL -->
<div id="vendorModal" class="modalOverlay" onclick="outsideVendorClick(event)">
<div class="modalBox">
<div class="modalCloseX" onclick="closeVendorModal()">✕</div>
<h3>Select Vendor</h3>
<input type="text" id="vendorSearchInput" placeholder="Type to filter..." oninput="filterVendorList()"><br><br>
<div id="vendorList"></div>
<button class="modalClose" onclick="closeVendorModal()">Close</button>
</div>
</div>

<script>

/* ================== DATA ================== */

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;

let vendorFilter="";
let amountFilter=null;

/* ================== CSV ================== */

document.getElementById("csvFile").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;

Papa.parse(file,{
header:false,
skipEmptyLines:true,
complete:res=>{
headers = res.data[0];
rawRows = res.data.slice(1);
showMapping();
}
});
});

/* ================== MAPPING ================== */

function showMapping(){
mappingPanel.style.display="block";
mappingPanel.innerHTML=`
<h4>Map Columns</h4>
Title:<br>${dropdown("mapTitle")}<br><br>
Amount:<br>${dropdown("mapAmount")}<br><br>
Vendor:<br>${dropdown("mapVendor")}<br><br>
Date:<br>${dropdown("mapDate")}<br><br>
Existing Category (optional):<br>${dropdown("mapCategory",true)}<br><br>
<button onclick="confirmMapping()">Confirm Mapping</button>
`;
}

function dropdown(id,allowEmpty=false){
let html=`<select id="${id}">`;
if(allowEmpty) html+=`<option value="">--None--</option>`;
headers.forEach((h,i)=>{
html+=`<option value="${i}">${h}</option>`;
});
html+=`</select>`;
return html;
}

function confirmMapping(){
const t=parseInt(mapTitle.value);
const a=parseInt(mapAmount.value);
const v=parseInt(mapVendor.value);
const d=parseInt(mapDate.value);
const c=mapCategory.value !== "" ? parseInt(mapCategory.value) : null;

data = rawRows.map(row=>({
Title: row[t] || "",
Amount: parseFloat(row[a]) || 0,
Vendor: row[v] || "",
Date: row[d] || "",
Category: c !== null ? (row[c] || "") : ""
}));

mappingPanel.style.display="none";
app.style.display="block";

updateTotals();
showCard();
}

/* ================== TOTALS ================== */

function updateTotals(){
let totalsObj={};

data.forEach(d=>{
if(!d.Category)return;
if(!totalsObj[d.Category]) totalsObj[d.Category]=0;
totalsObj[d.Category]+=d.Amount;
});

totals.innerHTML="";
Object.keys(totalsObj).forEach(k=>{
const row=document.createElement("div");
row.className="totalRow";
row.innerHTML=`<div>${k}</div><div>$${totalsObj[k].toFixed(2)}</div>`;
row.onclick=()=>showCategoryBreakdown(k);
totals.appendChild(row);
});
}

function showCategoryBreakdown(category){
let total=0;
let html="";

data.forEach((d,i)=>{
if(d.Category===category){
total+=d.Amount;
html+=`
<div style="border-bottom:1px solid #eee; padding:6px 0;">
<strong>${d.Title}</strong><br>
Vendor: ${d.Vendor}<br>
Date: ${d.Date}<br>
Amount: $${d.Amount.toFixed(2)}
</div>`;
}
});

modalTitle.innerText = category + " — Total: $" + total.toFixed(2);
modalContent.innerHTML = html || "No transactions found.";
modalOverlay.style.display="flex";
}

function closeModal(){
modalOverlay.style.display="none";
}

function outsideClick(e){
if(e.target.id==="modalOverlay") closeModal();
}

/* ================== VENDOR MODAL ================== */

function openVendorModal(){
vendorModal.style.display="flex";
populateVendorList();
}

function closeVendorModal(){
vendorModal.style.display="none";
}

function outsideVendorClick(e){
if(e.target.id==="vendorModal") closeVendorModal();
}

function populateVendorList(){
const unique=[...new Set(data.map(d=>d.Vendor).filter(v=>v))];
const list=document.getElementById("vendorList");
list.innerHTML="";
unique.forEach(v=>{
const div=document.createElement("div");
div.style.padding="8px";
div.style.cursor="pointer";
div.innerText=v;
div.onclick=()=>{
document.getElementById("searchVendor").value=v;
vendorFilter=v.toLowerCase();
closeVendorModal();
};
list.appendChild(div);
});
}

function filterVendorList(){
const input=document.getElementById("vendorSearchInput").value.toLowerCase();
const divs=document.querySelectorAll("#vendorList div");
divs.forEach(d=>{
d.style.display=d.innerText.toLowerCase().includes(input)?"block":"none";
});
}

/* ================== SEARCH ================== */

function applySearch(){
amountFilter=parseFloat(document.getElementById("searchAmount").value);
if(isNaN(amountFilter)) amountFilter=null;
showCard();
}

function clearSearch(){
vendorFilter="";
amountFilter=null;
document.getElementById("searchVendor").value="";
document.getElementById("searchAmount").value="";
showCard();
}

/* ================== NAVIGATION ================== */

function showCard(){
if(!data.length)return;
const item=data[currentIndex];
cardTitle.innerText=item.Title;
cardMeta.innerHTML=`Vendor: ${item.Vendor}<br>Date: ${item.Date}<br>Amount: $${item.Amount.toFixed(2)}`;
}

function goNext(){ if(currentIndex<data.length-1){currentIndex++;showCard();}}
function goBack(){ if(currentIndex>0){currentIndex--;showCard();}}

/* ================== ESC CLOSE ================== */

document.addEventListener("keydown",function(e){
if(e.key==="Escape"){
closeModal();
closeVendorModal();
}
});

/* ================== EXPORT ================== */

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

</script>
</body>
</html>
