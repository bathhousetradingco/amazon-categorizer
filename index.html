24

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:20px;
  background:#f4f4f4;
}
h2 { text-align:center; }
.panel {
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.08);
  margin-bottom:15px;
}
button {
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:12px;
  font-weight:600;
}
input[type="number"], input[type="text"]{
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
}
.navBtn { width:48%; background:#444; color:white; }
.category-btn { width:100%; margin-bottom:6px; color:white; }
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px; }
.progress-bar { height:100%; background:#2e7d32; width:0%; }
.small { font-size:13px; color:#555; }
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0; }
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">
<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">⬅ Back</button>
<button class="navBtn" onclick="goNext()">Next ➡</button>
</div>

<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>
<button onclick="clearProgress()" style="background:#c62828;color:white;margin-top:10px;">Reset Saved Progress</button>

</div>

<script>

const STORAGE_KEY = "bathhouse_categorizer_v15";

let rawRows = [];
let data = [];
let headers = [];
let currentIndex = 0;
let filterUncategorized = false;

const categories = [
{name:"COGS - Ingredients",class:"cogs"},
{name:"COGS - Packaging",class:"cogs"},
{name:"COGS - Resale Inventory",class:"cogs"},
{name:"COGS - Production Supplies",class:"cogs"},
{name:"COGS - Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Needs Review",class:"special"}
];

document.getElementById("csvFile").addEventListener("change", function(e){

  localStorage.removeItem(STORAGE_KEY);

  const file = e.target.files[0];
  if(!file) return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:function(res){
      rawRows = res.data;
      headers = Object.keys(rawRows[0]);
      showMapping();
    }
  });

});

function showMapping(){
  const panel = document.getElementById("mappingPanel");
  panel.style.display = "block";

  panel.innerHTML = `
    <h4>Map Columns</h4>
    Title:<br>${dropdown("mapTitle")}<br><br>
    Amount:<br>${dropdown("mapAmount")}<br><br>
    Vendor:<br>${dropdown("mapVendor",true)}<br><br>
    Date:<br>${dropdown("mapDate",true)}<br><br>
    Existing Category:<br>${dropdown("mapExistingCategory",true)}<br><br>
    <button onclick="confirmMapping()">Confirm</button>
  `;
}

function dropdown(id, allowEmpty=false){
  let html = `<select id="${id}">`;
  if(allowEmpty) html += `<option value="">--None--</option>`;
  headers.forEach(h => html += `<option value="${h}">${h}</option>`);
  html += `</select>`;
  return html;
}

function confirmMapping(){

  const t = mapTitle.value;
  const a = mapAmount.value;
  const v = mapVendor.value;
  const d = mapDate.value;
  const c = mapExistingCategory.value;

  data = rawRows.map(r => ({
    Title: r[t] || "",
    Amount: parseFloat(String(r[a] || "").replace(/[$,]/g,"")) || 0,
    Vendor: v ? r[v] : "",
    Date: d ? r[d] : "",
    Category: c ? r[c] : "",
    Splits: []
  }));

  mappingPanel.style.display="none";
  app.style.display="block";

  renderCategories();
  jumpToNextVisible();
  updateTotals();
  updateProgress();
  saveProgress();
}

function renderCategories(){

  const div = document.getElementById("categoryButtons");
  div.innerHTML = "";

  // Toggle Filter Button
  const toggle = document.createElement("button");
  toggle.className = "category-btn special";
  toggle.style.background = filterUncategorized ? "#4caf50" : "#777";
  toggle.innerText = filterUncategorized
    ? "Showing: Not Categorized Only"
    : "Show: Not Categorized Only";
  toggle.onclick = toggleFilter;
  div.appendChild(toggle);

  // Category Buttons
  categories.forEach(c => {
    const btn = document.createElement("button");
    btn.className = "category-btn " + c.class;
    btn.innerText = c.name;
    btn.onclick = () => categorize(c.name);
    div.appendChild(btn);
  });

  // Split Button
  const splitBtn = document.createElement("button");
  splitBtn.className = "category-btn expense";
  splitBtn.style.background="#ff9800";
  splitBtn.innerText = "Split Transaction";
  splitBtn.onclick = showSplitUI;
  div.appendChild(splitBtn);
}

function toggleFilter(){
  filterUncategorized = !filterUncategorized;
  currentIndex = 0;
  renderCategories();
  jumpToNextVisible();
  saveProgress();
}

function jumpToNextVisible(){

  while(currentIndex < data.length){

    if(!filterUncategorized){
      showCard();
      return;
    }

    if(!data[currentIndex].Category){
      showCard();
      return;
    }

    currentIndex++;
  }

  alert("No more uncategorized items.");
}

function categorize(name){
  const item = data[currentIndex];
  item.Category = name;
  item.Splits = [];
  nextItem();
}

function nextItem(){
  if(currentIndex < data.length-1){
    currentIndex++;
    jumpToNextVisible();
  }
  updateTotals();
  updateProgress();
  saveProgress();
}

function goBack(){
  if(currentIndex > 0){
    currentIndex--;
    if(filterUncategorized){
      while(currentIndex > 0 && data[currentIndex].Category){
        currentIndex--;
      }
    }
    showCard();
  }
}

function goNext(){
  if(currentIndex < data.length-1){
    currentIndex++;
    jumpToNextVisible();
  }
}

function showCard(){

  const item = data[currentIndex];

  document.getElementById("cardTitle").innerText = item.Title;

  document.getElementById("cardMeta").innerHTML =
    (item.Vendor ? `Vendor: ${item.Vendor}<br>` : "") +
    (item.Date ? `Date: ${item.Date}<br>` : "") +
    `Amount: $${item.Amount.toFixed(2)}`;

  document.getElementById("currentCategory").innerText =
    item.Splits.length
      ? "Split into multiple categories"
      : "Current: " + (item.Category || "—");
}

function showSplitUI(){

  const item = data[currentIndex];

  let html = `
  <div style="margin-top:10px;">
  <strong>Total: $${item.Amount.toFixed(2)}</strong><br>
  <div id="remainingBalance" style="font-weight:bold;margin:6px 0;">
    Remaining: $${item.Amount.toFixed(2)}
  </div>
  `;

  categories.forEach((c,i)=>{
    html += `
      <div style="margin-bottom:6px;">
        ${c.name}<br>
        <input type="number"
          step="0.01"
          id="split_${i}"
          placeholder="0.00"
          oninput="updateRemaining()">
      </div>
    `;
  });

  html += `<button onclick="saveSplit()">Save Split</button></div>`;

  document.getElementById("cardMeta").innerHTML += html;
}

function updateRemaining(){

  const item = data[currentIndex];
  let totalEntered = 0;

  categories.forEach((c,i)=>{
    totalEntered += parseFloat(document.getElementById("split_"+i).value) || 0;
  });

  const remaining = item.Amount - totalEntered;
  const display = document.getElementById("remainingBalance");

  display.innerText = "Remaining: $" + remaining.toFixed(2);

  if(Math.abs(remaining) < 0.01){
    display.style.color = "green";
  }
  else if(remaining < 0){
    display.style.color = "red";
  }
  else{
    display.style.color = "orange";
  }
}

function saveSplit(){

  const item = data[currentIndex];
  let total = 0;
  let splits = [];

  categories.forEach((c,i)=>{
    const val = parseFloat(document.getElementById("split_"+i).value) || 0;
    if(val > 0){
      splits.push({Category:c.name, Amount:val});
      total += val;
    }
  });

  if(Math.abs(total - item.Amount) > 0.01){
    alert("Split must equal original amount.");
    return;
  }

  item.Splits = splits;
  item.Category = "SPLIT";

  nextItem();
}

function updateTotals(){

  let totals = {};
  categories.forEach(c => totals[c.name] = 0);

  data.forEach(d=>{
    if(d.Splits.length){
      d.Splits.forEach(s=>{
        totals[s.Category] += s.Amount;
      });
    }
    else if(d.Category && totals[d.Category] != null){
      totals[d.Category] += d.Amount;
    }
  });

  const totalsDiv = document.getElementById("totals");
  totalsDiv.innerHTML = "";

  Object.keys(totals).forEach(k=>{
    totalsDiv.innerHTML += `
    <div class="totalRow">
      <div>${k}</div>
      <div>$${totals[k].toFixed(2)}</div>
    </div>`;
  });
}

function updateProgress(){
  const total = data.length;
  const done = data.filter(d => d.Category).length;
  const percent = total ? Math.round((done/total)*100) : 0;

  document.getElementById("progressBar").style.width = percent+"%";
  document.getElementById("progressText").innerText =
    `${done} of ${total} categorized (${percent}%)`;
}

function saveProgress(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    data,
    currentIndex,
    filterUncategorized
  }));
}

function loadProgress(){

  const saved = localStorage.getItem(STORAGE_KEY);
  if(!saved) return;

  const parsed = JSON.parse(saved);

  data = parsed.data || [];
  currentIndex = parsed.currentIndex || 0;
  filterUncategorized = parsed.filterUncategorized || false;

  if(data.length){
    document.getElementById("app").style.display="block";
    renderCategories();
    jumpToNextVisible();
    updateTotals();
    updateProgress();
  }
}

function clearProgress(){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

function exportExcel(){

  let exportData = [];

  data.forEach(d=>{
    if(d.Splits.length){
      d.Splits.forEach(s=>{
        exportData.push({
          Title:d.Title,
          Vendor:d.Vendor,
          Date:d.Date,
          Category:s.Category,
          Amount:s.Amount
        });
      });
    } else {
      exportData.push(d);
    }
  });

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Categorized");
  XLSX.writeFile(wb, "Categorized.xlsx");
}

window.onload = loadProgress;

</script>
</body>
</html>
