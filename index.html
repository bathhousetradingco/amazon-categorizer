<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4; }
h2 { text-align:center; }

.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px; }

button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600; }

.navBtn { width:48%; background:#444; color:white; }

.category-row { display:flex; align-items:center; margin-bottom:6px; }

.category-btn { flex:1; color:white; }

.info-btn {
  width:40px;
  margin-left:6px;
  background:#ddd;
  font-weight:bold;
}

.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}

.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px; }
.progress-bar { height:100%; background:#2e7d32; width:0%; }

.small { font-size:13px; color:#555; }

.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0; }

/* Modal */
.modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.6);
}

.modal-content {
  background:white;
  margin:15% auto;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:14px;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">

<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" id="backBtn">⬅ Back</button>
<button class="navBtn" id="nextBtn">Next ➡</button>
</div>

<div id="categoryButtons"></div>

</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>
<button onclick="clearProgress()" style="background:#c62828;color:white;margin-top:10px;">Reset Saved Progress</button>

</div>

<div id="infoModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
    <button id="closeModalBtn" style="margin-top:15px;background:#444;color:white;width:100%;">Close</button>
  </div>
</div>

<script>

const STORAGE_KEY = "bathhouse_categorizer_v5";

let rawRows=[], data=[], headers=[];
let currentIndex=0;

const categories = [
{ name:"COGS – Ingredients", class:"cogs", info:"Oils, butters, lye, fragrance, wax, colorants, extracts."},
{ name:"COGS – Packaging", class:"cogs", info:"Soap boxes, lotion jars, labels, tissue paper, shipping boxes."},
{ name:"COGS – Resale Inventory", class:"cogs", info:"Finished goods bought and resold."},
{ name:"COGS – Production Supplies", class:"cogs", info:"Gloves, mold liners, disposable production supplies."},
{ name:"COGS – Shipping from Suppliers", class:"cogs", info:"UPS or freight from vendors."},
{ name:"Equipment", class:"expense", info:"Molds, mixers, shelving, machinery."},
{ name:"Advertising & Marketing", class:"expense", info:"Facebook ads, event banners, promo items."},
{ name:"Website & Software", class:"expense", info:"Shopify, TaxJar, Canva, domains."},
{ name:"Merchant Processing Fees", class:"expense", info:"Stripe or Shopify payment fees."},
{ name:"Insurance", class:"expense", info:"Product liability, general liability."},
{ name:"Utilities", class:"expense", info:"Electric, water, internet."},
{ name:"Professional Services", class:"expense", info:"CPA, bookkeeping, legal."},
{ name:"Needs Review", class:"special", info:"Flag for Steven review."}
];

document.getElementById("csvFile").addEventListener("change",function(e){
localStorage.removeItem(STORAGE_KEY);
const file=e.target.files[0];
if(!file)return;
Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(res){
rawRows=res.data;
headers=Object.keys(rawRows[0]||{});
showMapping();
}});
});

function showMapping(){
const panel=document.getElementById("mappingPanel");
panel.style.display="block";
panel.innerHTML="<h4>Map Columns</h4>"+
"Title:<br>"+dropdown("mapTitle")+"<br><br>"+
"Amount:<br>"+dropdown("mapAmount")+"<br><br>"+
"<button onclick='confirmMapping()'>Confirm</button>";
}

function dropdown(id){
let html="<select id='"+id+"'>";
headers.forEach(function(h){ html+="<option value='"+h+"'>"+h+"</option>";});
return html+"</select>";
}

function confirmMapping(){
const t=document.getElementById("mapTitle").value;
const a=document.getElementById("mapAmount").value;

data=rawRows.map(function(r){
return {
Title:r[t]||"",
Amount:parseFloat(String(r[a]).replace(/[$,]/g,""))||0,
Category:""
};
});

document.getElementById("mappingPanel").style.display="none";
document.getElementById("app").style.display="block";

renderCategories();
showCard();
saveProgress();
}

function renderCategories(){
const div=document.getElementById("categoryButtons");
div.innerHTML="";
categories.forEach(function(c){
const row=document.createElement("div");
row.className="category-row";

const btn=document.createElement("button");
btn.className="category-btn "+c.class;
btn.innerText=c.name;
btn.onclick=function(){categorize(c.name);};

const info=document.createElement("button");
info.className="info-btn";
info.innerText="ⓘ";
info.onclick=function(){showInfo(c);};

row.appendChild(btn);
row.appendChild(info);
div.appendChild(row);
});
}

function showInfo(cat){
document.getElementById("modalTitle").innerText=cat.name;
document.getElementById("modalBody").innerText=cat.info;
document.getElementById("infoModal").style.display="block";
}

document.getElementById("closeModalBtn").addEventListener("click",function(){
document.getElementById("infoModal").style.display="none";
});

document.getElementById("infoModal").addEventListener("click",function(){
document.getElementById("infoModal").style.display="none";
});

function categorize(name){
data[currentIndex].Category=name;
if(currentIndex<data.length-1) currentIndex++;
showCard();
saveProgress();
}

document.getElementById("backBtn").onclick=function(){
if(currentIndex>0){currentIndex--;showCard();saveProgress();}
};

document.getElementById("nextBtn").onclick=function(){
if(currentIndex<data.length-1){currentIndex++;showCard();saveProgress();}
};

function showCard(){
if(!data.length)return;
const item=data[currentIndex];
document.getElementById("cardTitle").innerText=item.Title;
document.getElementById("cardMeta").innerText="Amount: $"+item.Amount.toFixed(2);
document.getElementById("currentCategory").innerText="Current: "+(item.Category||"—");
}

function saveProgress(){
localStorage.setItem(STORAGE_KEY,JSON.stringify({data:data,currentIndex:currentIndex}));
}

function loadProgress(){
const saved=localStorage.getItem(STORAGE_KEY);
if(!saved)return;
const parsed=JSON.parse(saved);
data=parsed.data||[];
currentIndex=parsed.currentIndex||0;
if(data.length){
document.getElementById("app").style.display="block";
renderCategories();
showCard();
}
}

function clearProgress(){
localStorage.removeItem(STORAGE_KEY);
location.reload();
}

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

window.onload=loadProgress;

</script>
</body>
</html>