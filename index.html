<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:20px;
  background:#f4f4f4;
}
h2 { text-align:center; }
.panel {
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.08);
  margin-bottom:15px;
}
button {
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  font-weight:600;
}
.navBtn { width:48%; background:#444; color:white; }
.category-row { display:flex; align-items:center; margin-bottom:6px; }
.category-btn { flex:1; color:white; }
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container {
  background:#eee; border-radius:999px; overflow:hidden;
  height:16px; margin-bottom:8px;
}
.progress-bar { height:100%; background:#2e7d32; width:0%; }
.small { font-size:13px; color:#555; }
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0; }
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">
<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<div id="suggestionBox" class="small" style="margin-top:10px;"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">⬅ Back</button>
<button class="navBtn" onclick="goNext()">Next ➡</button>
</div>

<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>
<button onclick="clearProgress()" style="background:#c62828;color:white;margin-top:10px;">Reset Saved Progress</button>

</div>

<script>

const STORAGE_KEY = "bathhouse_v8";
const LEARN_KEY = "bathhouse_learning_v1";

let rawRows=[], data=[], headers=[];
let currentIndex=0;
let learning = JSON.parse(localStorage.getItem(LEARN_KEY)) || { keywords:{} };

/* ---------------- CATEGORY LIST ---------------- */

const categories = [
{name:"COGS – Ingredients",class:"cogs"},
{name:"COGS – Packaging",class:"cogs"},
{name:"COGS – Production Supplies",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Needs Review",class:"special"}
];

/* ---------------- CATEGORY LOGIC ---------------- */

const categoryDefinitions = {
  "COGS – Ingredients":{
    businessLogic:"Raw materials used to create finished Bathhouse products.",
    taxLogic:"Ingredients are COGS because they become part of inventory sold.",
    keywords:["oil","butter","lye","fragrance","mica","extract","wax"]
  },
  "COGS – Packaging":{
    businessLogic:"Packaging used to contain or present finished goods.",
    taxLogic:"Packaging is COGS because it accompanies products sold.",
    keywords:["box","jar","bottle","label","mailer","tissue","lid"]
  },
  "COGS – Production Supplies":{
    businessLogic:"Consumables used during production but not sold.",
    taxLogic:"Production supplies are included in COGS because they directly support manufacturing.",
    keywords:["gloves","alcohol","liner","paper towel"]
  },
  "Equipment":{
    businessLogic:"Durable tools or assets used repeatedly in operations.",
    taxLogic:"Equipment is not COGS because it does not become part of finished goods and has ongoing use.",
    keywords:["mold","mixer","printer","shelving","machine"]
  },
  "Website & Software":{
    businessLogic:"Digital tools used to operate the business.",
    taxLogic:"Software is an operating expense rather than inventory cost.",
    keywords:["shopify","quickbooks","canva","taxjar"]
  }
};

/* ---------------- FILE LOAD ---------------- */

document.getElementById("csvFile").addEventListener("change",function(e){
  const file=e.target.files[0];
  if(!file)return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:function(res){
      rawRows=res.data;
      headers=Object.keys(rawRows[0]||{});
      showMapping();
    }
  });
});

/* ---------------- MAPPING ---------------- */

function showMapping(){
  const panel=document.getElementById("mappingPanel");
  panel.style.display="block";

  panel.innerHTML=`
  <h4>Map Columns</h4>
  Title:<br>${dropdown("mapTitle")}<br><br>
  Amount:<br>${dropdown("mapAmount")}<br><br>
  Vendor (optional):<br>${dropdown("mapVendor",true)}<br><br>
  Date (optional):<br>${dropdown("mapDate",true)}<br><br>
  <button onclick="confirmMapping()">Confirm</button>
  `;
}

function dropdown(id,allowEmpty=false){
  let html=`<select id="${id}">`;
  if(allowEmpty) html+=`<option value="">--None--</option>`;
  headers.forEach(h=>html+=`<option value="${h}">${h}</option>`);
  return html+="</select>";
}

function confirmMapping(){
  const t=document.getElementById("mapTitle").value;
  const a=document.getElementById("mapAmount").value;
  const v=document.getElementById("mapVendor").value;
  const d=document.getElementById("mapDate").value;

  data=rawRows.map(r=>({
    Title:r[t]||"",
    Amount:parseFloat(String(r[a]).replace(/[$,]/g,""))||0,
    Vendor:v?r[v]||"":"",
    Date:d?r[d]||"",
    Category:""
  }));

  applySuggestions();
  renderCategories();

  document.getElementById("mappingPanel").style.display="none";
  document.getElementById("app").style.display="block";

  showCard();
}

/* ---------------- SUGGESTION ENGINE ---------------- */

function normalize(text){
  return text.toLowerCase().replace(/[^\w\s]/g,"");
}

function generateSuggestion(title,vendor){
  const text=normalize(title+" "+vendor);
  let best="Needs Review";
  let score=0;
  let reasons=[];

  Object.keys(categoryDefinitions).forEach(cat=>{
    let localScore=0;
    categoryDefinitions[cat].keywords.forEach(k=>{
      if(text.includes(k)){
        localScore+=10;
        reasons.push(`Matched keyword "${k}".`);
      }
    });
    if(localScore>score){
      score=localScore;
      best=cat;
    }
  });

  let confidence=score>=30?"High":score>=15?"Medium":"Low";
  return {category:best,confidence,reasons};
}

function applySuggestions(){
  data.forEach(d=>{
    d.Suggestion=generateSuggestion(d.Title,d.Vendor);
  });
}

/* ---------------- UI ---------------- */

function renderCategories(){
  const div=document.getElementById("categoryButtons");
  div.innerHTML="";
  categories.forEach(c=>{
    const btn=document.createElement("button");
    btn.className="category-btn "+c.class;
    btn.innerText=c.name;
    btn.onclick=()=>categorize(c.name);
    div.appendChild(btn);
  });
}

function showCard(){
  if(!data.length)return;
  const item=data[currentIndex];

  document.getElementById("cardTitle").innerText=item.Title;
  document.getElementById("cardMeta").innerHTML=
    (item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
    `Amount: $${item.Amount.toFixed(2)}`;

  document.getElementById("currentCategory").innerText=
    "Current: "+(item.Category||"—");

  renderSuggestion(item);
}

function renderSuggestion(item){
  const s=item.Suggestion;
  if(!s)return;

  const def=categoryDefinitions[s.category];
  let explanation=def?
    `<b>Why this fits:</b><br><br>
    ${def.businessLogic}<br><br>
    ${def.taxLogic}<br><br>
    <b>Pattern reasoning:</b><br>${s.reasons.join("<br>")}`
    :"Manual review recommended.";

  document.getElementById("suggestionBox").innerHTML=`
    <div style="border:1px solid #ddd;padding:10px;border-radius:10px;">
      <b>Suggested:</b> ${s.category} (${s.confidence})
      <br><br>
      <button onclick="acceptSuggestion()">Accept Suggestion</button>
      <button onclick="toggleExplanation()">▶ Show detailed reasoning</button>
      <div id="explanationPanel" style="display:none;margin-top:10px;font-size:13px;">
        ${explanation}
      </div>
    </div>
  `;
}

function toggleExplanation(){
  const p=document.getElementById("explanationPanel");
  p.style.display=p.style.display==="none"?"block":"none";
}

function acceptSuggestion(){
  data[currentIndex].Category=data[currentIndex].Suggestion.category;
  showCard();
}

function categorize(name){
  data[currentIndex].Category=name;
  if(currentIndex<data.length-1)currentIndex++;
  showCard();
}

function goBack(){ if(currentIndex>0){currentIndex--;showCard();} }
function goNext(){ if(currentIndex<data.length-1){currentIndex++;showCard();} }

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Categorized");
  XLSX.writeFile(wb,"Categorized.xlsx");
}

function clearProgress(){
  location.reload();
}

</script>
</body>
</html>