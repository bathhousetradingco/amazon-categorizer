
<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input, select {
padding:10px;
border-radius:10px;
border:1px solid #ddd;
width:100%;
font-size:16px;
}

.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:6px 0; cursor:pointer; border-bottom:1px solid #eee;}
.totalRow:hover { background:#f5f5f5; }
.splitBox { background:#fafafa; padding:10px; border-radius:10px;}
.viewBtn { background:#1565c0; color:white; margin-top:6px;}
.removeBtn { background:#c62828; color:white; margin-top:6px;}
.modalOverlay {
position:fixed;
top:0; left:0;
width:100%; height:100%;
background:rgba(0,0,0,.6);
display:none;
justify-content:center;
align-items:center;
z-index:9999;
}
.modalBox {
background:white;
width:95%;
max-width:1100px;
max-height:90%;
overflow:auto;
border-radius:14px;
padding:20px;
}
.modalClose {
background:#c62828;
color:white;
margin-top:10px;
width:100%;
}
.modalItem {
padding:8px;
border-bottom:1px solid #eee;
cursor:pointer;
}
.modalItem:hover { background:#f5f5f5; }
.filterBtn {
background:#ff9800;
color:white;
margin-top:8px;
}
.receiptPreview img {
max-width:100%;
height:auto;
}
.receiptPreview iframe {
width:100%;
height:75vh;
border:none;
}
.splitSideBySide {
display:flex;
gap:20px;
}
.splitLeft {
flex:1;
border-right:1px solid #eee;
padding-right:10px;
}
.splitRight {
flex:1;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">

<button id="searchBtn" class="category-btn" style="background:#ff9800; margin-bottom:8px;" onclick="openSearchModal()">ðŸ”Ž Search</button>
<button id="clearSearchBtn" class="category-btn" style="background:#c62828; margin-bottom:8px; display:none;" onclick="clearSearchFilter()">Clear Search Filter</button>
<button id="createTransactionBtn"
class="category-btn"
style="background:#1565c0; margin-bottom:8px;"
onclick="openCreateTransactionModal()">
âž• Create Transaction
</button>

<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>

</div>


<div class="panel">
<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<div id="splitSummary"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">â¬… Back</button>
<button class="navBtn" onclick="goNext()">Next âž¡</button>
</div>

<h4>Choose Category</h4>
<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<div id="modalOverlay" class="modalOverlay">
<div class="modalBox">
<h3 id="modalTitle"></h3>
<div id="modalContent"></div>
<button class="modalClose" onclick="closeModal()">Close</button>
</div>
</div>

<script>

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;
let showOnlyUncategorized=false;
let activeSearchFilter=null;
/* ================= LOAD FROM SUPABASE ================= */

async function loadTransactions() {
  const { data: rows, error } = await supabaseClient
    .from("transactions")
    .select("*")
    .order("created_at", { ascending: true });

  if (error) {
    console.error("Load error:", error);
    return;
  }

  if (rows) {
    data = rows.map(r => ({
      id: r.id,
      Title: r.title,
      Vendor: r.vendor,
      Date: r.date,
      Amount: r.amount,
      Category: r.category || "",
      Splits: r.splits || [],
      receipt_url: r.receipt_url,
      Receipt: null
    }));

    if (data.length > 0) {
      app.style.display = "block";
      renderCategories();
      updateTotals();
      updateProgress();
      showCard();
    }
  }
}



/* ================= SUPABASE ================= */

const SUPABASE_URL = "https://xbayklklcdohewvnbglq.supabase.co";

const SUPABASE_ANON_KEY = "sb_publishable_p1RKnO_H5YlnxG7W41lLJw_kIMAd1Jx";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
  /* Auto-load on startup */
loadTransactions();
const categories=[
{name:"COGS - Ingredients",class:"cogs"},
{name:"COGS - Packaging",class:"cogs"},
{name:"COGS - Resale Inventory",class:"cogs"},
{name:"COGS - Production Supplies",class:"cogs"},
{name:"COGS - Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Fuel",class:"expense"},
{name:"Needs Review",class:"special"}
];

/* ================= SEARCH ================= */

function openSearchModal(){
modalTitle.innerText="Search Transactions";
modalContent.innerHTML=`
<input type="text" id="searchInput" placeholder="Search vendor or amount..." style="margin-bottom:10px;">
<div id="searchResults"></div>
`;
document.getElementById("searchInput").addEventListener("input",updateSearchResults);
openModal();
setTimeout(() => {
document.getElementById("searchInput").focus();
}, 50);
}

function updateSearchResults(){
const query=document.getElementById("searchInput").value.trim().toLowerCase();
const resultsDiv=document.getElementById("searchResults");
resultsDiv.innerHTML="";
if(!query) return;

const numeric=parseFloat(query);

data.forEach((d,i)=>{
let vendorMatch=d.Vendor && d.Vendor.toLowerCase().includes(query);
let amountMatch=!isNaN(numeric) && d.Amount===numeric;

if(vendorMatch || amountMatch){
resultsDiv.innerHTML+=`
<div class="modalItem" onclick="applySearchFilter(${i})">
${d.Vendor || d.Title} â€” $${d.Amount.toFixed(2)}
</div>`;
}
});
}

function applySearchFilter(index){
const item=data[index];
activeSearchFilter={
vendor:item.Vendor,
amount:item.Amount
};
currentIndex=index;
document.getElementById("clearSearchBtn").style.display="block";
closeModal();
showCard();
}

function clearSearchFilter(){
activeSearchFilter=null;
document.getElementById("clearSearchBtn").style.display="none";
showCard();
}

/* ================= CREATE TRANSACTION ================= */

function openCreateTransactionModal(){

modalTitle.innerText = "Create Transaction";

modalContent.innerHTML = `
<div style="display:flex; flex-direction:column; gap:12px;">

<label>Vendor</label>
<input type="text" id="newVendor">

<label>Date</label>
<input type="date" id="newDate">

<label>Amount</label>
<input type="number" step="0.01" id="newAmount">

<button class="category-btn expense" onclick="saveNewTransaction()">
Save Transaction
</button>

</div>
`;

openModal();
}

async function saveNewTransaction(){


const vendor = document.getElementById("newVendor").value.trim();
const rawDate = document.getElementById("newDate").value;

let formattedDate = "";
if(rawDate){
const parts = rawDate.split("-");
formattedDate = `${parts[1]}/${parts[2]}/${parts[0].slice(-2)}`;
}
const amount = parseFloat(document.getElementById("newAmount").value);

if(!vendor || !formattedDate || isNaN(amount)){
alert("Please complete all fields.");
return;
}

const newTransaction = {
Title: vendor,
Vendor: vendor,
Date: formattedDate,
Amount: amount,
Category: "",
Splits: [],
Receipt: null
};

const { data: inserted, error } = await supabaseClient
  .from("transactions")
  .insert([{
    title: vendor,
    vendor: vendor,
    date: formattedDate,
    amount: amount,
    category: "",
    splits: []
  }])
  .select()
  .single();

if (error) {
  alert("Error saving to database");
  console.error(error);
  return;
}

newTransaction.id = inserted.id;
data.push(newTransaction);


closeModal();

updateTotals();
updateProgress();

// Jump to new transaction
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";
// Ensure Uncategorized filter doesn't hide new item
if(showOnlyUncategorized){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}
currentIndex = data.length - 1;
showCard();
}

async function deleteTransaction(){

if(!confirm("Are you sure you want to delete this transaction?")) return;

const id = data[currentIndex].id;

if (id) {
  await supabaseClient
    .from("transactions")
    .delete()
    .eq("id", id);
}

data.splice(currentIndex,1);


if(currentIndex >= data.length){
currentIndex = data.length - 1;
}

updateTotals();
updateProgress();

if(data.length === 0){
cardTitle.innerText = "No Transactions";
cardMeta.innerHTML = "";
splitSummary.innerHTML = "";
currentCategory.innerText = "";
return;
}

showCard();
}

  
/* CSV */

document.getElementById("csvFile").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;

Papa.parse(file,{
header:false,
skipEmptyLines:true,
complete:res=>{
headers = res.data[0].map(h=>String(h).trim());
rawRows = res.data.slice(1);
showMapping();
}
});
});

/* Mapping */

function showMapping(){
mappingPanel.style.display="block";
mappingPanel.innerHTML=`
<h4>Map Columns</h4>
Title:<br>${dropdown("mapTitle")}<br><br>
Amount:<br>${dropdown("mapAmount")}<br><br>
Vendor:<br>${dropdown("mapVendor")}<br><br>
Date:<br>${dropdown("mapDate")}<br><br>
Existing Category (optional):<br>${dropdown("mapCategory",true)}<br><br>
<button onclick="confirmMapping()">Confirm Mapping</button>
`;
}

function dropdown(id,allowEmpty=false){
let html=`<select id="${id}">`;
if(allowEmpty) html+=`<option value="">--None--</option>`;
headers.forEach((h,i)=>{
html+=`<option value="${i}">${h}</option>`;
});
html+=`</select>`;
return html;
}

async function confirmMapping(){

  const t = parseInt(document.getElementById("mapTitle").value);
  const a = parseInt(document.getElementById("mapAmount").value);
  const v = parseInt(document.getElementById("mapVendor").value);
  const d = parseInt(document.getElementById("mapDate").value);
  const c = document.getElementById("mapCategory").value !== "" 
    ? parseInt(document.getElementById("mapCategory").value) 
    : null;

  const rowsToInsert = rawRows.map(row => ({
    title: row[t] || "",
    amount: parseFloat(String(row[a]||"").replace(/[$,]/g,"")) || 0,
    vendor: row[v] || "",
    date: row[d] || "",
    category: c !== null ? row[c] || "" : "",
    splits: []
  }));

  const { error } = await supabaseClient
    .from("transactions")
    .insert(rowsToInsert);

  if(error){
    console.error(error);
    alert("Error importing CSV to database");
    return;
  }

  mappingPanel.style.display = "none";
  app.style.display = "block";

  await loadTransactions();

}




/* Receipt */

async function attachReceipt(e){

const file = e.target.files[0];
if(!file) return;

const item = data[currentIndex];
if(!item.id){
  alert("Transaction must be saved before attaching receipt.");
  return;
}

const fileExt = file.name.split('.').pop();
const filePath = `${item.id}.${fileExt}`;

const { error: uploadError } = await supabaseClient
  .storage
  .from("receipts")
  .upload(filePath, file, {
    upsert: true
  });

if(uploadError){
  console.error("Upload error:", uploadError);
  alert("Error uploading receipt.");
  return;
}

const { data: publicUrlData } = supabaseClient
  .storage
  .from("receipts")
  .getPublicUrl(filePath);

const publicUrl = publicUrlData.publicUrl;

const { error: updateError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: filePath })
  .eq("id", item.id);

if(updateError){
  console.error("DB update error:", updateError);
  alert("Error saving receipt reference.");
  return;
}

item.receipt_url = filePath;

alert("Receipt saved successfully.");
}

async function viewReceipt(){

const item = data[currentIndex];
if(!item.id) return;

if(!item.receipt_url){
  alert("No receipt attached.");
  return;
}

const { data: signedData, error } = await supabaseClient
  .storage
  .from("receipts")
  .createSignedUrl(item.receipt_url, 60);

if(error){
  console.error(error);
  alert("Unable to load receipt.");
  return;
}

modalTitle.innerText = "Receipt Preview";

modalContent.innerHTML = `
<div class="receiptPreview">
<iframe src="${signedData.signedUrl}"></iframe>
</div>
`;

openModal();
}
async function removeReceipt(){

const item = data[currentIndex];
if(!item.id || !item.receipt_url) return;

const { error: storageError } = await supabaseClient
  .storage
  .from("receipts")
  .remove([item.receipt_url]);

if(storageError){
  console.error("Storage delete error:", storageError);
  alert("Error deleting file from storage.");
  return;
}

const { error: dbError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: null })
  .eq("id", item.id);

if(dbError){
  console.error("DB update error:", dbError);
  alert("Error clearing receipt reference.");
  return;
}

item.receipt_url = null;

showCard();
alert("Receipt removed successfully.");
}

/* Filter */

function toggleFilter(){
showOnlyUncategorized=!showOnlyUncategorized;
filterToggle.innerText=showOnlyUncategorized?"Show All Transactions":"Show Only Uncategorized";
updateProgress();
showCard();
}

function getVisibleIndexes(){

let baseList;

if(!showOnlyUncategorized){
baseList = data.map((_,i)=>i);
}else{
baseList = data.map((d,i)=>!d.Category?i:null).filter(i=>i!==null);
}

if(!activeSearchFilter) return baseList;

return baseList.filter(i=>{
const d=data[i];

const vendorMatch =
activeSearchFilter.vendor &&
d.Vendor === activeSearchFilter.vendor;

const amountMatch =
activeSearchFilter.amount != null &&
d.Amount === activeSearchFilter.amount;

return vendorMatch || amountMatch;
});
}


/* Navigation */

function goNext(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos<visible.length-1){
currentIndex=visible[pos+1];
showCard();
}
}

function goBack(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos>0){
currentIndex=visible[pos-1];
showCard();
}
}

/* Category Buttons */

function renderCategories(){
const div=document.getElementById("categoryButtons");
div.innerHTML="";
categories.forEach(cat=>{
const btn=document.createElement("button");
btn.className="category-btn "+cat.class;
btn.innerText=cat.name;
btn.onclick=()=>categorize(cat.name);
div.appendChild(btn);
});
const splitBtn=document.createElement("button");
splitBtn.className="category-btn";
splitBtn.style.background="#ff9800";
splitBtn.innerText="Split Transaction";
splitBtn.onclick=openSplitModal;
div.appendChild(splitBtn);

const filterBtn=document.createElement("button");
filterBtn.id="filterToggle";
filterBtn.className="category-btn filterBtn";
filterBtn.innerText="Show Only Uncategorized";
filterBtn.onclick=toggleFilter;
div.appendChild(filterBtn);
}

async function categorize(name){

const item = data[currentIndex];

item.Category = name;
item.Splits = [];

updateTotals();
updateProgress();

if(item.id){
  const { error } = await supabaseClient
    .from("transactions")
    .update({
      category: name,
      splits: []
    })
    .eq("id", item.id);

  if(error){
    console.error("Category save error:", error);
    alert("Error saving category to database.");
    return;
  }
}

goNext();
}


/* Split Modal with Side by Side */

async function openSplitModal(){
const item=data[currentIndex];
modalTitle.innerText="Split Transaction";

let html = receiptHTML;
if(item.receipt_url){

  const { data: signedData, error } = await supabaseClient
    .storage
    .from("receipts")
    .createSignedUrl(item.receipt_url, 60);

  if(!error && signedData?.signedUrl){

    receiptHTML = `
      <div class="splitSideBySide">
        <div class="splitLeft">
          <strong>Receipt Preview</strong><br><br>
          <iframe src="${signedData.signedUrl}" style="width:100%; height:70vh; border:none;"></iframe>
        </div>
        <div class="splitRight">
    `;

  }
}
  let receiptHTML = "";

html+=`<div class="splitBox">
<strong>Total: $${item.Amount.toFixed(2)}</strong><br>
<div id="remainingBalance">Remaining: $${item.Amount.toFixed(2)}</div><br>`;

categories.forEach((c,i)=>{
html+=`${c.name}<br>
<input type="number" step="0.01" id="split_${i}" oninput="updateRemaining()"><br><br>`;
});

html+=`<button onclick="saveSplit()">Save Split</button>
</div>`;

if(item.receipt_url){
  html += `</div></div>`;
}


modalContent.innerHTML=html;
openModal();
}

function updateRemaining(){
const item=data[currentIndex];
let total=0;
categories.forEach((c,i)=>{
total+=parseFloat(document.getElementById("split_"+i).value)||0;
});
const remaining=item.Amount-total;
const el=document.getElementById("remainingBalance");
el.innerText="Remaining: $"+remaining.toFixed(2);
el.style.color=Math.abs(remaining)<0.01?"green":remaining<0?"red":"orange";
}

async function saveSplit(){

const item = data[currentIndex];

let total = 0;
let splits = [];

categories.forEach((c,i)=>{
  const val = parseFloat(document.getElementById("split_"+i).value) || 0;
  if(val > 0){
    splits.push({Category: c.name, Amount: val});
    total += val;
  }
});

if(Math.abs(total - item.Amount) > 0.01){
  alert("Split must equal total.");
  return;
}

item.Splits = splits;
item.Category = "SPLIT";

updateTotals();
updateProgress();

if(item.id){
  const { error } = await supabaseClient
    .from("transactions")
    .update({
      category: "SPLIT",
      splits: splits
    })
    .eq("id", item.id);

  if(error){
    console.error("Split save error:", error);
    alert("Error saving split to database.");
    return;
  }
}

closeModal();
goNext();
}


/* Category Breakdown Modal */

function showCategoryBreakdown(categoryName){
modalTitle.innerText=categoryName+" Transactions";
let html="";

data.forEach((d,i)=>{
if(d.Category===categoryName){
html+=`<div class="modalItem" onclick="jumpToItem(${i})">
${d.Title} â€” $${d.Amount.toFixed(2)}
</div>`;
}
if(d.Splits.length){
d.Splits.forEach(s=>{
if(s.Category===categoryName){
html+=`<div class="modalItem" onclick="jumpToItem(${i})">
${d.Title} (Split) â€” $${s.Amount.toFixed(2)}
</div>`;
}
});
}
});

if(!html) html="No transactions in this category.";
modalContent.innerHTML=html;
openModal();
}

function jumpToItem(index){

// Clear search filter so the item is visible
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";

// Ensure we are not restricted by Uncategorized filter
if(showOnlyUncategorized && data[index].Category){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}

currentIndex = index;
closeModal();
showCard();

// Scroll to top for clarity (optional but helpful UX)
window.scrollTo({ top: 0, behavior: "smooth" });
}


/* Modal Controls */

function openModal(){
modalOverlay.style.display="flex";
}

function closeModal(){
modalOverlay.style.display="none";
modalContent.innerHTML="";
}

modalOverlay.addEventListener("click",function(e){
if(e.target===modalOverlay) closeModal();
});

document.addEventListener("keydown",function(e){
if(e.key==="Escape") closeModal();
});

/* Show Card */

function showCard(){
if(!data.length)return;

if(showOnlyUncategorized){
const visible = getVisibleIndexes();

if(visible.length === 0){
cardTitle.innerText = "No Uncategorized Transactions";
cardMeta.innerHTML = "";
splitSummary.innerHTML = "";
currentCategory.innerText = "";
return;
}

if(!visible.includes(currentIndex)){
currentIndex = visible[0];
}
}


const item=data[currentIndex];
cardTitle.innerText=item.Title;

cardMeta.innerHTML=
(item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
(item.Date?`Date: ${item.Date}<br>`:"")+
`Amount: $${item.Amount.toFixed(2)}<br>`+
(item.receipt_url?`ðŸ“Ž Receipt Attached<br>
<button class="viewBtn" onclick="viewReceipt()">View Receipt</button>
<button class="removeBtn" onclick="removeReceipt()">Remove Attachment</button><br>`:"")+
`<br><input type="file" accept="image/*,.pdf" onchange="attachReceipt(event)">
<br><button class="removeBtn" onclick="deleteTransaction()">Delete Transaction</button>`;



if(item.Splits.length){
let splitHTML="<strong>Split Allocation:</strong><br>";
item.Splits.forEach(s=>{
splitHTML+=`${s.Category}: $${s.Amount.toFixed(2)}<br>`;
});
splitSummary.innerHTML=splitHTML;
}else{
splitSummary.innerHTML="";
}

currentCategory.innerText=item.Splits.length?"Split into multiple categories":"Current: "+(item.Category||"â€”");
}

/* Totals */

function updateTotals(){
let totalsObj={};
categories.forEach(c=>totalsObj[c.name]=0);

data.forEach(d=>{
if(d.Splits.length){
d.Splits.forEach(s=>{
if(totalsObj[s.Category]!=null){
totalsObj[s.Category]+=s.Amount;
}
});
}else if(d.Category && totalsObj[d.Category]!=null){
totalsObj[d.Category]+=d.Amount;
}
});

totals.innerHTML="";
Object.keys(totalsObj).forEach(k=>{
totals.innerHTML+=`<div class="totalRow" onclick="showCategoryBreakdown('${k}')">
<div>${k}</div>
<div>$${totalsObj[k].toFixed(2)}</div>
</div>`;
});
}

/* Progress */

function updateProgress(){
const total=data.length;
const done=data.filter(d=>d.Category).length;
const percent=total?Math.round((done/total)*100):0;
progressBar.style.width=percent+"%";
progressText.innerText=`${done} of ${total} categorized (${percent}%)`;
}

/* Export */

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

</script>
</body>
</html>
