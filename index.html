<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4; }
h2 { text-align:center; }

.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px; }

button { cursor:pointer; }

.category-btn {
  width:100%;
  padding:16px;
  border:none;
  border-radius:12px;
  color:white;
  font-weight:600;
  margin-bottom:6px;
  font-size:16px;
}

.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}

.nav-btn{
  width:48%;
  padding:12px;
  border:none;
  border-radius:12px;
  margin-top:8px;
  font-weight:600;
}

.back{background:#999;color:white;}
.forward{background:#444;color:white;}

.progress-bar-container {
  background:#eee;
  border-radius:999px;
  overflow:hidden;
  height:16px;
  margin-bottom:8px;
}

.progress-bar {
  height:100%;
  background:#2e7d32;
  width:0%;
}

.small { font-size:13px; color:#555; }
#cardTitle { font-size:18px; font-weight:bold; margin-bottom:6px; }

.hidden { display:none; }
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">

<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>

<hr>

<div id="categoryButtons"></div>

<div style="display:flex; justify-content:space-between;">
<button class="nav-btn back" onclick="goBack()">⬅ Back</button>
<button class="nav-btn forward" onclick="goForward()">Forward ➡</button>
</div>

</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<script>

let rawRows=[], data=[], headers=[];
let currentIndex=0;

// ===== AUTO SAVE =====
function saveProgress(){
localStorage.setItem("bathhouseData",JSON.stringify(data));
localStorage.setItem("bathhouseIndex",currentIndex);
}

function loadProgress(){
const savedData=localStorage.getItem("bathhouseData");
const savedIndex=localStorage.getItem("bathhouseIndex");

if(savedData){
data=JSON.parse(savedData);
currentIndex=parseInt(savedIndex||0);
document.getElementById("app").style.display="block";
renderCategories();
showCard();
updateProgress();
}
}

window.onload=loadProgress;

// ===== CATEGORIES =====
const categories=[
{name:"COGS – Ingredients",class:"cogs"},
{name:"COGS – Packaging",class:"cogs"},
{name:"COGS – Resale Inventory",class:"cogs"},
{name:"COGS – Production Supplies",class:"cogs"},
{name:"COGS – Shipping from Suppliers",class:"cogs"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Shipping to Customers",class:"expense"},
{name:"Equipment",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Rent / Storage",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Office / Admin",class:"expense"},
{name:"Taxes & Licenses",class:"expense"},
{name:"Did Not Receive",class:"special"},
{name:"Needs Review",class:"special"}
];

// ===== FILE LOAD =====
document.getElementById("csvFile").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;

Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>{
rawRows=res.data;
headers=Object.keys(rawRows[0]||{});
data=rawRows.map(r=>({
Title:r.Title||"",
Amount:parseFloat(String(r.Amount||"0").replace(/[$,]/g,""))||0,
Vendor:r.Vendor||"",
Date:r.Date||"",
Category:""
}));

currentIndex=0;
document.getElementById("app").style.display="block";
renderCategories();
showCard();
updateProgress();
saveProgress();
}});
});

// ===== RENDER CATEGORY BUTTONS =====
function renderCategories(){
const container=document.getElementById("categoryButtons");
container.innerHTML="";
categories.forEach(cat=>{
const btn=document.createElement("button");
btn.className=`category-btn ${cat.class}`;
btn.innerText=cat.name;
btn.onclick=()=>categorize(cat.name);
container.appendChild(btn);
});
}

// ===== SHOW CARD =====
function showCard(){
if(!data.length){return;}

if(currentIndex>=data.length){
document.getElementById("cardTitle").innerText="All items categorized!";
document.getElementById("cardMeta").innerText="";
document.getElementById("currentCategory").innerText="";
return;
}

const item=data[currentIndex];
document.getElementById("cardTitle").innerText=item.Title;
document.getElementById("cardMeta").innerHTML=
(item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
(item.Date?`Date: ${item.Date}<br>`:"")+
`Amount: $${item.Amount.toFixed(2)}`;

document.getElementById("currentCategory").innerText=
"Current: "+(item.Category||"—");
}

// ===== CATEGORY SELECT =====
function categorize(name){
if(currentIndex>=data.length)return;

data[currentIndex].Category=name;
currentIndex++;
saveProgress();
showCard();
updateProgress();
}

// ===== NAVIGATION =====
function goBack(){
if(currentIndex>0){
currentIndex--;
showCard();
updateProgress();
saveProgress();
}
}

function goForward(){
if(currentIndex<data.length-1){
currentIndex++;
showCard();
updateProgress();
saveProgress();
}
}

// ===== PROGRESS BAR =====
function updateProgress(){
const total=data.length;
const done=data.filter(d=>d.Category).length;
const percent=total?Math.round((done/total)*100):0;
document.getElementById("progressBar").style.width=percent+"%";
document.getElementById("progressText").innerText=
`${done} of ${total} categorized (${percent}%)`;
}

// ===== EXPORT =====
function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

</script>
</body>
</html>