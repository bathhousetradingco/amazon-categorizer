<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input, select {
padding:12px;
border-radius:10px;
border:1px solid #ddd;
width:100%;
font-size:16px;
}

.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:6px 0; cursor:pointer; border-bottom:1px solid #eee;}
.totalRow:hover { background:#f5f5f5; }
.splitBox { background:#fafafa; padding:10px; border-radius:10px;}
.viewBtn { background:#1565c0; color:white; margin-top:6px;}
.removeBtn { background:#c62828; color:white; margin-top:6px;}

.modalOverlay {
position:fixed;
top:0; left:0;
width:100%; height:100%;
background:rgba(0,0,0,.6);
display:none;
justify-content:center;
align-items:center;
z-index:9999;
overflow:auto;
}

.modalBox {
  background:white;
  width:95%;
  max-width:1200px;
  height:90vh;
  display:flex;
  flex-direction:column;
  overflow:hidden; /* üëà important */
}
#modalContent {
  flex:1;
  overflow:auto;
  min-height:0; /* üëà CRITICAL fix for flex scrolling */
}

.modalClose {
background:#c62828;
color:white;
margin-top:10px;
width:100%;
}

.modalItem {
padding:8px;
border-bottom:1px solid #eee;
cursor:pointer;
}
.modalItem:hover { background:#f5f5f5; }

.filterBtn {
background:#ff9800;
color:white;
margin-top:8px;
}

/* RECEIPT VIEW */
.receiptPreview iframe {
  width:100%;
  height:85vh;
  border:none;
  border-radius:10px;
}

.receiptPreview img {
  width:100%;
  max-height:85vh;
  object-fit:contain;
}

/* SPLIT LAYOUT */
.splitSideBySide {
  display:flex;
  gap:12px;
  height:80vh;
}

.splitLeft {
  width:65%;
  overflow-y:auto;
  background:#fff;
  border-radius:12px;
  padding:4px;
}

.splitLeft iframe,
.splitLeft img {
  width:100%;
  height:auto;
  min-height:700px;
  border:none;
}

.splitRight {
  width:35%;
  overflow-y:auto;
  padding-left:6px;
}

</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">

<button id="searchBtn" class="category-btn" style="background:#ff9800; margin-bottom:8px;" onclick="openSearchModal()">üîé Search</button>

<button id="clearSearchBtn" class="category-btn" style="background:#c62828; margin-bottom:8px; display:none;" onclick="clearSearchFilter()">Clear Search Filter</button>

<button id="createTransactionBtn"
class="category-btn"
style="background:#1565c0; margin-bottom:8px;"
onclick="openCreateTransactionModal()">
‚ûï Create Transaction
</button>

<button class="category-btn" style="background:#2e7d32; margin-bottom:8px;" onclick="connectBank()">
üè¶ Connect Bank
</button>

<select id="yearFilter" onchange="applyYearFilter()" style="margin-bottom:8px;">
  <option value="">All Years</option>
</select>

<div class="progress-bar-container">
  <div id="progressBar" class="progress-bar"></div>
</div>
<div id="positionIndicator" class="small" style="margin-top:4px;"></div>
<div id="progressText" class="small"></div>


<div class="panel">
<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<div id="splitSummary"></div>

<button onclick="resetSplits()" style="
  background:#c62828;
  color:white;
  padding:10px 14px;
  border-radius:10px;
  margin-top:10px;
  width:100%;
">
  Reset Splits
</button>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">‚¨Ö Back</button>
<button class="navBtn" onclick="goNext()">Next ‚û°</button>
</div>

<h4>Choose Category</h4>
<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<div id="modalOverlay" class="modalOverlay">
<div class="modalBox">
<h3 id="modalTitle"></h3>
<div id="modalContent"></div>
<button class="modalClose" onclick="closeModal()">Close</button>
</div>
</div>

<script>

const app = document.getElementById("app");
const modalOverlay = document.getElementById("modalOverlay");
const modalContent = document.getElementById("modalContent");
const modalTitle = document.getElementById("modalTitle");
const cardTitle = document.getElementById("cardTitle");
const cardMeta = document.getElementById("cardMeta");
const splitSummary = document.getElementById("splitSummary");
const currentCategory = document.getElementById("currentCategory");
const totals = document.getElementById("totals");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

/* ALL YOUR ORIGINAL JS REMAINS UNCHANGED BELOW */

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;
let showOnlyUncategorized=false;
let activeSearchFilter=null;
let activeYearFilter = null;
/* ================= LOAD FROM SUPABASE ================= */

async function loadTransactions() {
  const { data: rows, error } = await supabaseClient
    .from("transactions")
    .select("*")
    .order("date", { ascending: true }); // safer than created_at

  if (error) {
    console.error("Load error:", error);
    return;
  }

  console.log("Rows from Supabase:", rows);

  data = rows.map(r => ({
    id: r.id,
    Title: r.title,
    Vendor: r.vendor,
    Date: r.date,
    Amount: r.amount,
    Category: r.category || "",
    Splits: r.splits || [],
    receipt_url: r.receipt_url
  }));

  app.style.display = "block";

  renderCategories();
  populateYearFilter();
  updateTotals();
  updateProgress();

  if (data.length > 0) {
    showCard();
  }
}


/* ================= SUPABASE ================= */

const SUPABASE_URL = "https://xbayklklcdohewvnbglq.supabase.co";

const SUPABASE_ANON_KEY = "sb_publishable_p1RKnO_H5YlnxG7W41lLJw_kIMAd1Jx";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
  /* Auto-load on startup */
/* Auto-load on startup */
window.addEventListener("DOMContentLoaded", loadTransactions);
const categories=[
{
name:"COGS - Ingredients",
class:"cogs",
description:`
<strong>Definition:</strong><br>
Raw materials that physically become part of a finished Bathhouse product.<br><br>

<strong>Examples:</strong><br>
‚Ä¢ Olive oil, coconut oil, shea butter<br>
‚Ä¢ Grass-fed tallow<br>
‚Ä¢ Essential oils & phthalate-free fragrance oils<br>
‚Ä¢ Lye<br>
‚Ä¢ Mica, titanium dioxide (in product)<br>
‚Ä¢ Goat milk<br>
‚Ä¢ Aloe juice (in soap/lotion)<br><br>

<strong>Does NOT Include:</strong><br>
‚Ä¢ Cleaning chemicals<br>
‚Ä¢ Soap nuts for cleaning<br>
‚Ä¢ Store hand soap<br><br>

Ask yourself: Does this physically go inside the product being sold?
`
},
{
name:"COGS - Packaging",
class:"cogs",
description:`
<strong>Definition:</strong><br>
Packaging that becomes part of the product at time of sale.<br><br>

<strong>Examples:</strong><br>
‚Ä¢ Soap boxes<br>
‚Ä¢ Shrink wrap<br>
‚Ä¢ Product labels<br>
‚Ä¢ Ingredient labels<br>
‚Ä¢ Jars & pump tops<br>
‚Ä¢ Lip balm tubes<br>
‚Ä¢ Deodorant tubes<br>
‚Ä¢ Inserts inside retail packaging<br><br>

<strong>Does NOT Include:</strong><br>
‚Ä¢ Shipping boxes<br>
‚Ä¢ Tissue paper in shipments<br>
‚Ä¢ Packing tape<br>
‚Ä¢ Shipping labels<br><br>

Rule: If it stays attached to the product itself ‚Üí Packaging.
`
},
{
name:"COGS - Resale Inventory",
class:"cogs",
description:`
Items purchased finished and resold without modification.<br><br>

Examples:<br>
‚Ä¢ Pumice stones sold as-is<br>
‚Ä¢ Sleep masks<br>
‚Ä¢ Wholesale accessories<br>
`
},
{
name:"COGS - Production Supplies",
class:"cogs",
description:`
Consumables used during production but not in final product.<br><br>

Examples:<br>
‚Ä¢ Gloves<br>
‚Ä¢ Mixing sticks<br>
‚Ä¢ Alcohol for sanitizing<br>
‚Ä¢ Paper towels used in production<br>
‚Ä¢ Mold liners<br>
`
},
{
name:"COGS - Shipping from Suppliers",
class:"cogs",
description:`
Freight-in paid to receive ingredients or inventory.<br><br>

Examples:<br>
‚Ä¢ Shipping from Wholesale Supplies Plus<br>
‚Ä¢ Freight charges on jars<br>
‚Ä¢ UPS cost from ingredient vendors<br>
`
},
{
name:"Shipping Supplies",
class:"expense",
description:`
Materials used to ship orders to customers.<br><br>

Examples:<br>
‚Ä¢ Shipping boxes<br>
‚Ä¢ Tissue paper in shipping box<br>
‚Ä¢ Bubble wrap<br>
‚Ä¢ Packing tape<br>
‚Ä¢ Order stickers<br>
‚Ä¢ Shipping label paper<br><br>

This is NOT COGS.
`
},
{
name:"Shipping to Customers",
class:"expense",
description:`
Postage or shipping labels purchased to send orders.<br><br>

Examples:<br>
‚Ä¢ USPS postage<br>
‚Ä¢ UPS postage<br>
‚Ä¢ Shopify shipping labels<br>
`
},
{
name:"Advertising & Marketing",
class:"expense",
description:`
Promotional spending to generate sales.<br><br>

Examples:<br>
‚Ä¢ Facebook ads<br>
‚Ä¢ Google Ads<br>
‚Ä¢ Newspaper ads<br>
‚Ä¢ Loofah Fest signage<br>
‚Ä¢ Canva Pro (if marketing related)<br>
`
},
{
name:"Commissions & Merchant Fees",
class:"expense",
description:`
Transaction fees charged by payment processors.<br><br>

Examples:<br>
‚Ä¢ Shopify processing fees<br>
‚Ä¢ Square fees<br>
‚Ä¢ Faire commission fees<br>
`
},
{
name:"Software & Subscriptions",
class:"expense",
description:`
Recurring digital tools used to run Bathhouse.<br><br>

Examples:<br>
‚Ä¢ Shopify subscription<br>
‚Ä¢ QuickBooks<br>
‚Ä¢ Supabase<br>
‚Ä¢ Plaid<br>
`
},
{
name:"Insurance",
class:"expense",
description:`Business or product liability insurance.`
},
{
name:"Utilities",
class:"expense",
description:`Electric, water, internet used for business.`
},
  {
  name:"Office Supplies",
  class:"expense",
  description:`
Office consumables used to operate Bathhouse Trading Company.

Examples:
‚Ä¢ Printer paper
‚Ä¢ Receipt paper
‚Ä¢ Pens
‚Ä¢ File folders
‚Ä¢ Storage bins
‚Ä¢ Desk organizers

Does NOT include:
‚Ä¢ Product packaging
‚Ä¢ Shipping supplies
‚Ä¢ Equipment over $2,500 (capital asset)
`
},
  {
name:"Equipment",
class:"expense",
description:`
Business equipment purchases under IRS capitalization threshold.

Examples:
‚Ä¢ Label printer
‚Ä¢ Small shelving
‚Ä¢ Storage racks
‚Ä¢ Small tools
‚Ä¢ Washer/dryer (if expensed, not depreciated)

Note: Larger capital assets may require depreciation.
`
},
  {
name:"Meals",
class:"expense",
description:`
Business meals related to operations.

Examples:
‚Ä¢ Vendor meetings
‚Ä¢ Market event meals
‚Ä¢ Business planning lunches

Note: Typically 50% deductible.
`
},
{
name:"Professional Services",
class:"expense",
description:`CPA, legal fees, consulting services.`
},
{
name:"Fuel",
class:"expense",
description:`Gas used for markets, supply pickups, or business travel.`
},
{
name:"Taxes & Licenses",
class:"expense",
description:`Business license fees and state filings (not income tax).`
},
{
name:"Interest Expense",
class:"expense",
description:`Credit card or business loan interest.`
},
  
{
name:"Needs Review",
class:"special",
description:`If unsure, temporarily park the transaction here.`
}
];
const categoryAliases = {

  // Software rename
  "Software": "Software & Subscriptions",

  // Advertising rename
  "Advertising": "Advertising & Marketing",

  // Gas rename
  "Gas": "Fuel",

  // Interest rename
  "Other Interest": "Interest Expense",

  // Office rename (choose correct destination)
  "Office / Admin": "Office Supplies",

  // Old spelling
  "COGS - Resell Inventory": "COGS - Resale Inventory",

  // Explicit no category
  "NO CATEGORY": "Needs Review",

  // Merchant rename
  "Merchant Processing Fees": "Commissions & Merchant Fees"

};
/* ================= SEARCH ================= */

function openSearchModal(){
modalTitle.innerText="Search Transactions";
modalContent.innerHTML=`
<input type="text" id="searchInput" placeholder="Search vendor or amount..." style="margin-bottom:10px;">
<div id="searchResults"></div>
`;
document.getElementById("searchInput").addEventListener("input",updateSearchResults);
openModal();
setTimeout(() => {
document.getElementById("searchInput").focus();
}, 50);
}

function populateYearFilter(){
  const years = new Set();

  data.forEach(d=>{
    if(!d.Date) return;

    const year = d.Date ? d.Date.toString().slice(0,4) : null;
    if(!isNaN(year)){
      years.add(year.toString());
    }
  });

  const select = document.getElementById("yearFilter");
  select.innerHTML = `<option value="">All Years</option>`;

  Array.from(years)
    .sort((a,b)=>b-a)
    .forEach(y=>{
      select.innerHTML += `<option value="${y}">${y}</option>`;
    });
}

function applyYearFilter(){
  const val = document.getElementById("yearFilter").value;
  activeYearFilter = val || null;
  activeSearchFilter = null;
document.getElementById("clearSearchBtn").style.display = "none";
  currentIndex = 0;
  updateTotals();
updateProgress();
showCard();
}

function updateSearchResults(){
const query=document.getElementById("searchInput").value.trim().toLowerCase();
const resultsDiv=document.getElementById("searchResults");
resultsDiv.innerHTML="";
if(!query) return;

const numeric=parseFloat(query);

getVisibleIndexes().forEach(i=>{
  const d = data[i];
let vendorMatch=d.Vendor && d.Vendor.toLowerCase().includes(query);
let amountMatch=!isNaN(numeric) && d.Amount===numeric;

if(vendorMatch || amountMatch){
resultsDiv.innerHTML+=`
<div class="modalItem" onclick="applySearchFilter(${i})">
${d.Vendor || d.Title} ‚Äî $${d.Amount.toFixed(2)}
</div>`;
}
});
}

function applySearchFilter(index){

  const visible = getVisibleIndexes();

  // If the clicked item is NOT inside the current filtered view,
  // do NOT jump to it.
  if(!visible.includes(index)){
    alert("This transaction is outside your current filter.");
    return;
  }

  currentIndex = index;

  closeModal();
  showCard();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function clearSearchFilter(){
activeSearchFilter=null;
document.getElementById("clearSearchBtn").style.display="none";
showCard();
}

/* ================= CREATE TRANSACTION ================= */

function openCreateTransactionModal(){

modalTitle.innerText = "Create Transaction";

modalContent.innerHTML = `
<div style="display:flex; flex-direction:column; gap:12px;">

<label>Vendor</label>
<input type="text" id="newVendor">

<label>Date</label>
<input type="date" id="newDate">

<label>Amount</label>
<input type="number" step="0.01" id="newAmount">

<button class="category-btn expense" onclick="saveNewTransaction()">
Save Transaction
</button>

</div>
`;

openModal();
}

async function saveNewTransaction(){

const vendor = document.getElementById("newVendor").value.trim();
const rawDate = document.getElementById("newDate").value;

let formattedDate = "";
if(rawDate){
const parts = rawDate.split("-");
formattedDate = rawDate; // store as YYYY-MM-DD
}
const amount = parseFloat(document.getElementById("newAmount").value);

if(!vendor || !formattedDate || isNaN(amount)){
alert("Please complete all fields.");
return;
}

const response = await fetch("https://xbayklklcdohewvnbglq.supabase.co/functions/v1/sync-transactions", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
  title: vendor,
  vendor: vendor,
  date: formattedDate,
  amount: amount,
  category: "",
  source: "manual"
})
});

const result = await response.json();

if (!response.ok) {
  console.error(result);
  alert("Error saving transaction");
  return;
}

// Add instantly to UI (optimistic update)
data.unshift({
  id: Date.now(), // temp id
  Title: vendor,
  Vendor: vendor,
  Date: formattedDate,
  Amount: amount,
  Category: "",
  Splits: [],
  receipt_url: null
});

closeModal();

updateTotals();
updateProgress();
showCard();

// THEN refresh quietly in background
loadTransactions();

// Jump to new transaction
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";

if(showOnlyUncategorized){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}

currentIndex = 0;
showCard();
}

async function deleteTransaction(){

if(!confirm("Are you sure you want to delete this transaction?")) return;

const id = data[currentIndex].id;

if (id) {
  await supabaseClient
    .from("transactions")
    .delete()
    .eq("id", id);
}

data.splice(currentIndex,1);


if(currentIndex >= data.length){
currentIndex = data.length - 1;
}

updateTotals();
updateProgress();

if(data.length === 0){
cardTitle.innerText = "No Transactions";
cardMeta.innerHTML = "";
splitSummary.innerHTML = "";
currentCategory.innerText = "";
return;
}

showCard();
}

  
/* CSV */

window.addEventListener("DOMContentLoaded", () => {

  const csvInput = document.getElementById("csvFile");
  if(!csvInput) return;

  csvInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async (res) => {

      const rowsToInsert = res.data.map(row => ({
        date: row.date,
        source: "csv",
        title: row.title,
        vendor: row.vendor,
        amount: parseFloat(row.amount) || 0,
        category: row.category || "",
        splits: []
      }));

      const { error } = await supabaseClient
        .from("transactions")
        .insert(rowsToInsert);

      if (error) {
        console.error(error);
        alert("CSV Import Error");
        return;
      }

      app.style.display = "block";
      await loadTransactions();
    }
  });
});

  });




/* Receipt */

async function attachReceipt(e){

const file = e.target.files[0];
if(!file) return;

const item = data[currentIndex];
if(!item.id){
  alert("Transaction must be saved before attaching receipt.");
  return;
}

const fileExt = file.name.split('.').pop();
const filePath = `receipts/${item.id}.${fileExt}`;

const { error: uploadError } = await supabaseClient
  .storage
  .from("receipts")
  .upload(filePath, file, {
    upsert: true
  });

if(uploadError){
  console.error("Upload error:", uploadError);
  alert("Error uploading receipt.");
  return;
}

const { data: publicUrlData } = supabaseClient
  .storage
  .from("receipts")
  .getPublicUrl(filePath);

const publicUrl = publicUrlData.publicUrl;

const { error: updateError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: filePath })
  .eq("id", item.id);

if(updateError){
  console.error("DB update error:", updateError);
  alert("Error saving receipt reference.");
  return;
}

item.receipt_url = filePath;

showCard(); // üî• THIS refreshes the UI

alert("Receipt saved successfully.");
}


function resetSplits(){
  const item = data[currentIndex];

  if(!item) return;

  item.Splits = [];
  item.Category = "";

  updateTotals();
  updateProgress();
  showCard();

  if(item.id){
    supabaseClient
      .from("transactions")
      .update({
        category: "",
        splits: []
      })
      .eq("id", item.id);
  }
}

async function viewReceipt(){

const item = data[currentIndex];
if(!item.id) return;

if(!item.receipt_url){
  alert("No receipt attached.");
  return;
}

const { data: signedData, error } = await supabaseClient
  .storage
  .from("receipts")
  .createSignedUrl(item.receipt_url, 60);

if(error){
  console.error(error);
  alert("Unable to load receipt.");
  return;
}

modalTitle.innerText = "Receipt Preview";

const url = signedData.signedUrl;
const isPDF = url.toLowerCase().includes(".pdf");

if(isPDF){
  modalContent.innerHTML = `
  <div class="receiptPreview">
    <iframe src="${url}"></iframe>
  </div>
  `;
} else {
  modalContent.innerHTML = `
  <div style="
    width:100%;
    height:100%;
    overflow:auto;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    background:#000;
  ">
    <img src="${url}" style="
      max-width:100%;
      height:auto;
      touch-action:manipulation;
    ">
  </div>
  `;
}



openModal();
}
async function removeReceipt(){

const item = data[currentIndex];
if(!item.id || !item.receipt_url) return;

const { error: storageError } = await supabaseClient
  .storage
  .from("receipts")
  .remove([item.receipt_url]);

if(storageError){
  console.error("Storage delete error:", storageError);
  alert("Error deleting file from storage.");
  return;
}

const { error: dbError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: null })
  .eq("id", item.id);

if(dbError){
  console.error("DB update error:", dbError);
  alert("Error clearing receipt reference.");
  return;
}

item.receipt_url = null;

showCard();
alert("Receipt removed successfully.");
}

/* Filter */

function toggleFilter(){
showOnlyUncategorized=!showOnlyUncategorized;
filterToggle.innerText=showOnlyUncategorized?"Show All Transactions":"Show Only Uncategorized";
updateProgress();
showCard();
}

function getVisibleIndexes(){

let baseList;

if(!showOnlyUncategorized){
baseList = data.map((_,i)=>i);
}else{
baseList = data.map((d,i)=>!d.Category?i:null).filter(i=>i!==null);
}

let filtered = baseList;

if(activeYearFilter){
  filtered = filtered.filter(i=>{
    const d = data[i];
    if(!d.Date) return false;

    const year = d.Date ? d.Date.toString().slice(0,4) : null;
    return year === activeYearFilter;
  });
}

if(!activeSearchFilter) return filtered;

return filtered.filter(i=>{
const d=data[i];

const vendorMatch =
activeSearchFilter.vendor &&
d.Vendor === activeSearchFilter.vendor;

const amountMatch =
activeSearchFilter.amount != null &&
d.Amount === activeSearchFilter.amount;

return vendorMatch || amountMatch;
});
}


/* Navigation */

function goNext(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos<visible.length-1){
currentIndex=visible[pos+1];
showCard();
}
}

function goBack(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos>0){
currentIndex=visible[pos-1];
showCard();
}
}

/* Category Buttons */

function renderCategories(){
const div=document.getElementById("categoryButtons");
div.innerHTML="";
categories.forEach(cat=>{
const btn=document.createElement("button");
btn.className="category-btn "+cat.class;
btn.innerHTML = `
<span>${cat.name}</span>
<span style="
margin-left:8px;
background:white;
color:black;
border-radius:50%;
width:18px;
height:18px;
display:inline-flex;
align-items:center;
justify-content:center;
font-size:12px;
font-weight:bold;
cursor:pointer;
" onclick="event.stopPropagation(); showCategoryInfo('${cat.name.replace(/'/g, "\\'")}')">
i
</span>
`;
btn.onclick=()=>categorize(cat.name);
div.appendChild(btn);
});
const splitBtn=document.createElement("button");
splitBtn.className="category-btn";
splitBtn.style.background="#ff9800";
splitBtn.innerText="Split Transaction";
splitBtn.onclick=openSplitModal;
div.appendChild(splitBtn);

const filterBtn=document.createElement("button");
filterBtn.id="filterToggle";
filterBtn.className="category-btn filterBtn";
filterBtn.innerText="Show Only Uncategorized";
filterBtn.onclick=toggleFilter;
div.appendChild(filterBtn);
}

function showCategoryInfo(name){

  const category = categories.find(c => c.name === name);
  if(!category) return;

  const modal = document.createElement("div");

  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.5)";
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";
  modal.style.zIndex = "100000"; // üëà above picker

  modal.innerHTML = `
    <div style="
      background:white;
      width:90%;
      max-width:500px;
      max-height:80vh;
      border-radius:16px;
      padding:16px;
      overflow:auto;
      box-sizing:border-box;
    ">
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">${category.name}</h3>
        <button onclick="closeCategoryInfo()" style="
          background:#c62828;
          color:white;
          border:none;
          padding:6px 10px;
          border-radius:8px;
        ">‚úï</button>
      </div>

      <div style="font-size:14px; line-height:1.5;">
        ${category.description || "No description available."}
      </div>

    </div>
  `;

  document.body.appendChild(modal);

  window.closeCategoryInfo = () => {
    document.body.removeChild(modal);
  };

}
  
async function categorize(name){

const item = data[currentIndex];

item.Category = name;
item.Splits = [];

updateTotals();
updateProgress();

if(item.id){
  const { error } = await supabaseClient
    .from("transactions")
    .update({
      category: name,
      splits: []
    })
    .eq("id", item.id);

  if(error){
    console.error("Category save error:", error);
    alert("Error saving category to database.");
    return;
  }
}

goNext();
}

/* ================= NEW SPLIT UI (REPLACEMENT) ================= */

async function openSplitModal(){

  const item = data[currentIndex];
  modalTitle.innerText = "Split Transaction";

  renderSplitUI();

  openModal();
}

function renderSplitUI(){

  const item = data[currentIndex];

  let total = 0;
  if(item.Splits){
    item.Splits.forEach(s => total += parseFloat(s.Amount));
    total = parseFloat(total.toFixed(2));
  }

  const remaining = parseFloat((item.Amount - total).toFixed(2));

  let html = `
    <div style="display:flex; flex-direction:column; gap:12px;">

      <div style="
        font-size:18px;
        font-weight:700;
        background:#f5f5f5;
        padding:12px;
        border-radius:10px;
      ">
        Remaining: $${remaining.toFixed(2)}
      </div>

      <div style="background:#fafafa; padding:10px; border-radius:10px;">
  `;

  if(item.Splits && item.Splits.length){
    item.Splits.forEach((s,i)=>{
      html += `
        <div style="
          display:flex;
          justify-content:space-between;
          padding:6px 0;
          border-bottom:1px solid #eee;
        ">
          <div>${s.Category}</div>
          <div>
            $${parseFloat(s.Amount).toFixed(2)}
            <button onclick="removeSplit(${i})" style="
              margin-left:8px;
              background:#c62828;
              color:white;
              border:none;
              border-radius:6px;
              padding:2px 6px;
            ">x</button>
          </div>
        </div>
      `;
    });
  } else {
    html += `<div style="color:#777;">No splits yet</div>`;
  }

  html += `</div><strong>Add Split</strong>`;

  categories.forEach(c=>{
    html += `
      <button class="category-btn ${c.class}" 
        onclick="addSplit('${c.name.replace(/'/g, "\\'")}')">
        ${c.name}
      </button>
    `;
  });

  html += `
    <button onclick="closeModal()" style="
      background:#2e7d32;
      color:white;
      padding:10px;
      border-radius:10px;
      margin-top:10px;
    ">
      Done
    </button>
  `;

  modalContent.innerHTML = html;
}

function addSplit(category){

  const item = data[currentIndex];

  let total = 0;
  if(item.Splits){
    item.Splits.forEach(s => total += parseFloat(s.Amount));
    total = parseFloat(total.toFixed(2));
  }

  const remaining = parseFloat((item.Amount - total).toFixed(2));

  const input = prompt(`Enter amount (Remaining: $${remaining.toFixed(2)})`);
  if(input === null) return;

  let amount = parseFloat(input);

  if(isNaN(amount) || amount <= 0){
    alert("Invalid amount");
    return;
  }

  if(amount > remaining + 0.01){
    alert("Amount exceeds remaining.");
    return;
  }

  if(Math.abs(amount - remaining) < 0.01){
    amount = remaining;
  }

  if(!item.Splits) item.Splits = [];

  item.Splits.push({
    Category: category,
    Amount: amount
  });

  item.Category = "SPLIT";

  updateTotals();
  updateProgress();
  renderSplitUI();

  if(item.id){
    const { error } = await supabaseClient
      .from("transactions")
      .update({
        category: "SPLIT",
        splits: item.Splits
      })
      .eq("id", item.id);

    if(error){
      console.error(error);
      alert("Error saving split.");
    }
  }
}

function removeSplit(index){
  const item = data[currentIndex];
  item.Splits.splice(index,1);
  renderSplitUI();
}




/* Category Breakdown Modal */

function showCategoryBreakdown(categoryName){

  modalTitle.innerText = categoryName + " Transactions";
  let html = "";

  const visible = getVisibleIndexes();

  visible.forEach(i => {

    const d = data[i];

    // Normalize main category
    let normalizedCategory = d.Category;
    if(categoryAliases[normalizedCategory]){
      normalizedCategory = categoryAliases[normalizedCategory];
    }

    if(normalizedCategory === categoryName){
      html += `
        <div class="modalItem" onclick="jumpToItem(${i})">
          ${d.Title} ‚Äî $${d.Amount.toFixed(2)}
        </div>
      `;
    }

    // Normalize splits
    if(d.Splits && d.Splits.length){
      d.Splits.forEach(s => {

        let splitCategory = s.Category;
        if(categoryAliases[splitCategory]){
          splitCategory = categoryAliases[splitCategory];
        }

        if(splitCategory === categoryName){
          html += `
            <div class="modalItem" onclick="jumpToItem(${i})">
              ${d.Title} (Split) ‚Äî $${parseFloat(s.Amount).toFixed(2)}
            </div>
          `;
        }

      });
    }

  });

  if(!html) html = "No transactions in this category.";

  modalContent.innerHTML = html;
  openModal();
}

function jumpToItem(index){

// Clear search filter so the item is visible
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";

// Ensure we are not restricted by Uncategorized filter
if(showOnlyUncategorized && data[index].Category){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}

currentIndex = index;
closeModal();
showCard();

// Scroll to top for clarity (optional but helpful UX)
window.scrollTo({ top: 0, behavior: "smooth" });
}


/* Modal Controls */

function openModal(){
modalOverlay.style.display="flex";
}

function closeModal(){
modalOverlay.style.display="none";
modalContent.innerHTML="";
}

modalOverlay.addEventListener("click",function(e){
if(e.target===modalOverlay) closeModal();
});

document.addEventListener("keydown",function(e){
if(e.key==="Escape") closeModal();
});

/* Show Card */

function showCard(){

  if(!data.length){
    cardTitle.innerText = "No Transactions";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    document.getElementById("positionIndicator").innerText = "";
    return;
  }

  const visible = getVisibleIndexes();

  if(visible.length === 0){
    cardTitle.innerText = "No Transactions Found";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    document.getElementById("positionIndicator").innerText = "";
    return;
  }

  if(!visible.includes(currentIndex)){
    currentIndex = visible[0];
  }

  const position = visible.indexOf(currentIndex) + 1;

  document.getElementById("positionIndicator").innerText =
    `Transaction ${position} of ${visible.length}`;

  const item = data[currentIndex];

  // Clean title
  cardTitle.innerText = item.Title || item.Vendor || "Untitled Transaction";

  cardMeta.innerHTML =
    (item.Vendor ? `Vendor: ${item.Vendor}<br>` : "") +
    (item.Date ? `Date: ${item.Date}<br>` : "") +
    `Amount: $${item.Amount.toFixed(2)}<br>` +
    (item.receipt_url ? 
      `üìé Receipt Attached<br>
       <button class="viewBtn" onclick="viewReceipt()">View Receipt</button>
       <button class="removeBtn" onclick="removeReceipt()">Remove Attachment</button><br>` 
      : ""
    ) +
    `<br>
     <input type="file" accept="image/*,.pdf" onchange="attachReceipt(event)">
     <br>
     <button class="removeBtn" onclick="deleteTransaction()">Delete Transaction</button>`;

  if(item.Splits && item.Splits.length){
    let splitHTML = "<strong>Split Allocation:</strong><br>";
    item.Splits.forEach(s=>{
      splitHTML += `${s.Category}: $${parseFloat(s.Amount).toFixed(2)}<br>`;
    });
    splitSummary.innerHTML = splitHTML;
  } else {
    splitSummary.innerHTML = "";
  }

  currentCategory.innerText = item.Splits && item.Splits.length
    ? "Split into multiple categories"
    : "Current: " + (item.Category || "‚Äî");
}

/* Totals */

function updateTotals(){

  let totalsObj = {};

  // Build totals object dynamically from categories
  categories.forEach(c => totalsObj[c.name] = 0);

  const visible = getVisibleIndexes();

  visible.forEach(i => {

    const d = data[i];

    const addAmount = (cat, amount) => {
      if(!cat || cat.trim() === ""){
  return; // skip uncategorized entirely
}

      if(categoryAliases[cat]){
        cat = categoryAliases[cat];
      }

      if(totalsObj[cat] != null){
        totalsObj[cat] += parseFloat(amount);
      } else {
  return; // don't track unknown categories
}
    };

    // Handle splits
    if(d.Splits && d.Splits.length){

      d.Splits.forEach(s => {
        addAmount(s.Category, s.Amount);
      });

    } else {

      addAmount(d.Category, d.Amount);

    }

  });

  // Render totals UI
  totals.innerHTML = "";

  Object.keys(totalsObj).forEach(k => {
    totals.innerHTML += `
      <div class="totalRow" onclick="showCategoryBreakdown('${k}')">
        <div>${k}</div>
        <div>$${totalsObj[k].toFixed(2)}</div>
      </div>
    `;
  });

}


/* Progress */

function updateProgress(){
const visible = getVisibleIndexes();
const total = visible.length;
const done = visible.filter(i => data[i].Category).length;
const percent=total?Math.round((done/total)*100):0;
progressBar.style.width=percent+"%";
progressText.innerText=`${done} of ${total} categorized (${percent}%)`;
}

/* Export */

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

async function connectBank() {

  const res = await fetch("https://xbayklklcdohewvnbglq.supabase.co/functions/v1/create-link-token", {
    method: "POST",
headers: {
  "Content-Type": "application/json"
}
  });

  const data = await res.json();

  if (!data.link_token) {
    alert("Failed to create link token");
    console.error(data);
    return;
  }

  const handler = Plaid.create({
    token: data.link_token,

    onSuccess: async (public_token, metadata) => {
      console.log("Connected!", public_token);

      const exchangeRes = await fetch("https://xbayklklcdohewvnbglq.supabase.co/functions/v1/exchange-token", {
        method: "POST",
      headers: {
  "Content-Type": "application/json"
},
        body: JSON.stringify({ public_token })
      });

      const exchangeData = await exchangeRes.json();
      console.log("Exchange result:", exchangeData);

      const syncRes = await fetch("https://xbayklklcdohewvnbglq.supabase.co/functions/v1/sync-plaid-transactions", {
        method: "POST",
   headers: {
  "Content-Type": "application/json"
}
      });

      const syncData = await syncRes.json();
      console.log("Sync result:", syncData);

      await loadTransactions();

      alert("Bank connected and transactions imported!");
    },

    onExit: function(err, metadata) {
      console.log("User exited Plaid", err);
    }
  });

  handler.open();
}

</script>
</body>
</html>
