34

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input[type="number"], input[type="text"] { padding:10px; border-radius:10px; border:1px solid #ddd;}
.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0;}
.toggleBtn { background:#777; color:white; width:100%; margin-bottom:8px;}
.toggleActive { background:#4caf50 !important;}
.splitBox { background:#fafafa; padding:10px; border-radius:10px; margin-top:10px;}
.clearBtn { background:#c62828; color:white; margin-top:8px; }

/* Modal */
#vendorModal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
}
#vendorModalContent {
  background:white;
  padding:20px;
  border-radius:12px;
  width:320px;
}
.vendor-option {
  padding:8px;
  border-radius:8px;
  margin-bottom:6px;
  background:#eee;
}
.vendor-option:hover {
  background:#ddd;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">

<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>

<div id="splitContainer"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">â¬… Back</button>
<button class="navBtn" onclick="goNext()">Next âž¡</button>
</div>

<h4>Choose Category</h4>
<div id="categoryButtons"></div>

</div>

<div class="panel">

<button id="uncatToggle" class="toggleBtn" onclick="toggleUncategorized()">Show: Not Categorized Only</button>
<button id="attachmentToggle" class="toggleBtn" onclick="toggleAttachment()">Show: Has Attachment Only</button>

<h4>Search Transaction</h4>
Vendor:<br>
<input type="text" id="searchVendor"><br><br>
Amount:<br>
<input type="number" id="searchAmount" step="0.01"><br><br>
<button onclick="searchTransaction()">Search</button>
<button class="clearBtn" onclick="clearSearch()">Clear Search</button>

</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>
<button onclick="clearProgress()" class="clearBtn">Reset Saved Progress</button>

</div>

<!-- Vendor Suggestion Modal -->
<div id="vendorModal">
  <div id="vendorModalContent">
    <h4>Select Vendor</h4>
    <div id="vendorOptions"></div>
    <button class="clearBtn" onclick="closeVendorModal()">Cancel</button>
  </div>
</div>

<script>

const STORAGE_KEY="bathhouse_categorizer_v25";

let rawRows=[],data=[],headers=[],currentIndex=0;
let filterUncategorized=false,filterAttachment=false;
let vendorFilterActive=false,vendorFilterText="",amountFilter=null;

const categories=[
{name:"COGS - Ingredients",class:"cogs"},
{name:"COGS - Packaging",class:"cogs"},
{name:"COGS - Resale Inventory",class:"cogs"},
{name:"COGS - Production Supplies",class:"cogs"},
{name:"COGS - Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Needs Review",class:"special"}
];

function normalize(str){
  return str.toLowerCase().replace(/[^a-z0-9]/g,"");
}

function getVendorSuggestions(input){
  const normInput=normalize(input);
  const vendorMap={};
  data.forEach(d=>{
    if(!d.Vendor) return;
    const normVendor=normalize(d.Vendor);
    if(normVendor.includes(normInput)){
      vendorMap[d.Vendor]=(vendorMap[d.Vendor]||0)+1;
    }
  });
  return Object.entries(vendorMap).sort((a,b)=>b[1]-a[1]);
}

function showVendorModal(options,amountVal){
  const modal=document.getElementById("vendorModal");
  const container=document.getElementById("vendorOptions");
  container.innerHTML="";
  options.forEach(([vendor,count])=>{
    const div=document.createElement("div");
    div.className="vendor-option";
    div.innerText=`${vendor} (${count} transactions)`;
    div.onclick=()=>{
      applyVendorFilter(vendor,amountVal);
      closeVendorModal();
    };
    container.appendChild(div);
  });
  modal.style.display="flex";
}

function closeVendorModal(){
  document.getElementById("vendorModal").style.display="none";
}

function applyVendorFilter(vendor,amountVal){
  vendorFilterActive=true;
  vendorFilterText=vendor.toLowerCase();
  amountFilter=amountVal?parseFloat(amountVal):null;
  currentIndex=0;
  const first=findNextIndex(0,1);
  if(first!==-1) currentIndex=first;
  showCard();
}

function searchTransaction(){
  const vendorInput=document.getElementById("searchVendor").value.trim();
  const amountVal=document.getElementById("searchAmount").value;

  if(vendorInput){
    const suggestions=getVendorSuggestions(vendorInput);
    if(suggestions.length===0){
      alert("No matching vendors found.");
      return;
    }
    if(suggestions.length===1){
      applyVendorFilter(suggestions[0][0],amountVal);
    } else {
      showVendorModal(suggestions,amountVal);
    }
    return;
  }

  if(amountVal){
    const amt=parseFloat(amountVal);
    const index=data.findIndex(d=>Math.abs(d.Amount-amt)<0.01);
    if(index!==-1){currentIndex=index;showCard();}
    return;
  }

  alert("Enter Vendor or Amount.");
}

function clearSearch(){
  vendorFilterActive=false;
  vendorFilterText="";
  amountFilter=null;
  document.getElementById("searchVendor").value="";
  document.getElementById("searchAmount").value="";
  currentIndex=0;
  showCard();
}

function passesFilters(item){
  if(filterUncategorized && item.Category) return false;
  if(filterAttachment && !item.Receipt) return false;
  if(vendorFilterActive){
    if(!item.Vendor.toLowerCase().includes(vendorFilterText)) return false;
    if(amountFilter!=null && Math.abs(item.Amount-amountFilter)>0.01) return false;
  }
  return true;
}

function findNextIndex(start,dir){
  let i=start;
  while(i>=0 && i<data.length){
    if(passesFilters(data[i])) return i;
    i+=dir;
  }
  return -1;
}

function goNext(){
  const next=findNextIndex(currentIndex+1,1);
  if(next!==-1){currentIndex=next;showCard();}
}

function goBack(){
  const prev=findNextIndex(currentIndex-1,-1);
  if(prev!==-1){currentIndex=prev;showCard();}
}

function categorize(name){
  data[currentIndex].Category=name;
  data[currentIndex].Splits=[];
  updateTotals();
  updateProgress();
  saveProgress();
  goNext();
}

function showSplitUI(){
  const item=data[currentIndex];
  let html=`<div class="splitBox">
  <strong>Total: $${item.Amount.toFixed(2)}</strong><br>
  <div id="remainingBalance">Remaining: $${item.Amount.toFixed(2)}</div>`;
  categories.forEach((c,i)=>{
    html+=`${c.name}<br>
    <input type="number" step="0.01" id="split_${i}" oninput="updateRemaining()"><br><br>`;
  });
  html+=`<button onclick="saveSplit()">Save Split</button></div>`;
  splitContainer.innerHTML=html;
}

function updateRemaining(){
  const item=data[currentIndex];
  let total=0;
  categories.forEach((c,i)=>{
    total+=parseFloat(document.getElementById("split_"+i).value)||0;
  });
  const remaining=item.Amount-total;
  const el=document.getElementById("remainingBalance");
  el.innerText="Remaining: $"+remaining.toFixed(2);
  el.style.color=Math.abs(remaining)<0.01?"green":remaining<0?"red":"orange";
}

function saveSplit(){
  const item=data[currentIndex];
  let total=0,splits=[];
  categories.forEach((c,i)=>{
    const val=parseFloat(document.getElementById("split_"+i).value)||0;
    if(val>0){splits.push({Category:c.name,Amount:val});total+=val;}
  });
  if(Math.abs(total-item.Amount)>0.01){alert("Split must equal total.");return;}
  item.Splits=splits;
  item.Category="SPLIT";
  updateTotals();
  updateProgress();
  saveProgress();
  goNext();
}

function attachReceipt(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    data[currentIndex].Receipt={name:file.name,data:ev.target.result};
    saveProgress();
    showCard();
  };
  reader.readAsDataURL(file);
}

function showCard(){
  if(!data.length)return;
  const item=data[currentIndex];
  cardTitle.innerText=item.Title;
  cardMeta.innerHTML=
    (item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
    (item.Date?`Date: ${item.Date}<br>`:"")+
    `Amount: $${item.Amount.toFixed(2)}<br>`+
    (item.Receipt?`ðŸ“Ž Receipt Attached<br>`:"")+
    `<br><input type="file" accept="image/*,.pdf" onchange="attachReceipt(event)">`;
  currentCategory.innerText=
    item.Splits.length?"Split into multiple categories":
    "Current: "+(item.Category||"â€”");
  splitContainer.innerHTML="";
}

function toggleUncategorized(){
  filterUncategorized=!filterUncategorized;
  uncatToggle.classList.toggle("toggleActive");
  currentIndex=0;
  const first=findNextIndex(0,1);
  if(first!==-1) currentIndex=first;
  showCard();
}

function toggleAttachment(){
  filterAttachment=!filterAttachment;
  attachmentToggle.classList.toggle("toggleActive");
  currentIndex=0;
  const first=findNextIndex(0,1);
  if(first!==-1) currentIndex=first;
  showCard();
}

function updateTotals(){
  let totalsObj={};
  categories.forEach(c=>totalsObj[c.name]=0);
  data.forEach(d=>{
    if(d.Splits.length){
      d.Splits.forEach(s=>totalsObj[s.Category]+=s.Amount);
    }else if(d.Category && totalsObj[d.Category]!=null){
      totalsObj[d.Category]+=d.Amount;
    }
  });
  totals.innerHTML="";
  Object.keys(totalsObj).forEach(k=>{
    totals.innerHTML+=`<div class="totalRow"><div>${k}</div><div>$${totalsObj[k].toFixed(2)}</div></div>`;
  });
}

function updateProgress(){
  const total=data.length;
  const done=data.filter(d=>d.Category).length;
  const percent=total?Math.round((done/total)*100):0;
  progressBar.style.width=percent+"%";
  progressText.innerText=`${done} of ${total} categorized (${percent}%)`;
}

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Categorized");
  XLSX.writeFile(wb,"Categorized.xlsx");
}

function saveProgress(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({
    data,currentIndex,filterUncategorized,filterAttachment
  }));
}

function loadProgress(){
  const saved=localStorage.getItem(STORAGE_KEY);
  if(!saved)return;
  const parsed=JSON.parse(saved);
  data=parsed.data||[];
  currentIndex=parsed.currentIndex||0;
  filterUncategorized=parsed.filterUncategorized||false;
  filterAttachment=parsed.filterAttachment||false;
  if(data.length){
    app.style.display="block";
    renderCategories();
    showCard();
    updateTotals();
    updateProgress();
  }
}

window.onload=loadProgress;

</script>
</body>
</html>
