45
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input, select { padding:10px; border-radius:10px; border:1px solid #ddd; width:100%;}
.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0;}
.splitBox { background:#fafafa; padding:10px; border-radius:10px; margin-top:10px;}
.viewBtn { background:#1565c0; color:white; margin-top:6px;}
.toggleBtn { background:#777; color:white; width:100%; margin-bottom:8px;}
.toggleActive { background:#4caf50 !important;}
.clearBtn { background:#c62828; color:white; margin-top:8px;}
.resetBtn { background:#444; color:white; margin-top:8px; width:100%;}
#vendorDropdown {
position:absolute;
background:white;
border:1px solid #ddd;
border-radius:10px;
box-shadow:0 6px 20px rgba(0,0,0,.1);
max-height:200px;
overflow:auto;
display:none;
z-index:999;
}
.vendor-option { padding:8px; cursor:pointer; }
.vendor-option:hover { background:#f0f0f0; }
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">
<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<div id="splitSummary"></div>
<div id="splitContainer"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">â¬… Back</button>
<button class="navBtn" onclick="goNext()">Next âž¡</button>
</div>

<h4>Choose Category</h4>
<div id="categoryButtons"></div>
</div>

<div class="panel">

<button id="uncatToggle" class="toggleBtn" onclick="toggleUncategorized()">Show: Not Categorized Only</button>
<button id="attachmentToggle" class="toggleBtn" onclick="toggleAttachment()">Show: Has Attachment Only</button>

<h4>Search Transaction</h4>

Vendor:<br>
<div style="position:relative;">
<input type="text" id="searchVendor" oninput="showVendorSuggestions()">
<div id="vendorDropdown"></div>
</div><br>

Amount:<br>
<input type="number" id="searchAmount" step="0.01"><br><br>

<button onclick="applySearch()">Search</button>
<button class="clearBtn" onclick="clearSearch()">Clear Search</button>
<button class="resetBtn" onclick="resetAllFilters()">Reset All Filters</button>

</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<script>

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;

let filterUncategorized=false;
let filterAttachment=false;
let vendorFilter="";
let amountFilter=null;

const categories=[
{name:"COGS - Ingredients",class:"cogs"},
{name:"COGS - Packaging",class:"cogs"},
{name:"COGS - Resale Inventory",class:"cogs"},
{name:"COGS - Production Supplies",class:"cogs"},
{name:"COGS - Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Needs Review",class:"special"}
];

document.getElementById("csvFile").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;

Papa.parse(file,{
header:false,
skipEmptyLines:true,
complete:res=>{
headers = res.data[0].map(h=>String(h).trim());
rawRows = res.data.slice(1);
showMapping();
}
});
});

function showMapping(){
mappingPanel.style.display="block";
mappingPanel.innerHTML=`
<h4>Map Columns</h4>
Title:<br>${dropdown("mapTitle")}<br><br>
Amount:<br>${dropdown("mapAmount")}<br><br>
Vendor:<br>${dropdown("mapVendor")}<br><br>
Date:<br>${dropdown("mapDate")}<br><br>
Existing Category (optional):<br>${dropdown("mapCategory",true)}<br><br>
<button onclick="confirmMapping()">Confirm Mapping</button>
`;
}

function dropdown(id,allowEmpty=false){
let html=`<select id="${id}">`;
if(allowEmpty) html+=`<option value="">--None--</option>`;
headers.forEach((h,i)=>{
html+=`<option value="${i}">${h}</option>`;
});
html+=`</select>`;
return html;
}

function confirmMapping(){

const t=parseInt(mapTitle.value);
const a=parseInt(mapAmount.value);
const v=parseInt(mapVendor.value);
const d=parseInt(mapDate.value);
const c=mapCategory.value !== "" ? parseInt(mapCategory.value) : null;

data = rawRows.map(row=>({
Title: row[t] || "",
Amount: parseFloat(String(row[a]||"").replace(/[$,]/g,"")) || 0,
Vendor: row[v] || "",
Date: row[d] || "",
Category: c !== null ? (row[c] || "") : "",
Splits: [],
Receipt: null
}));

mappingPanel.style.display="none";
app.style.display="block";

renderCategories();
resetToFirstMatch();
updateTotals();
updateProgress();
}

function passesFilters(item){
if(filterUncategorized && item.Category) return false;
if(filterAttachment && !item.Receipt) return false;
if(vendorFilter && !item.Vendor.toLowerCase().includes(vendorFilter)) return false;
if(amountFilter!==null && Math.abs(item.Amount-amountFilter)>0.01) return false;
return true;
}

function resetToFirstMatch(){
currentIndex=0;
let first=findNextIndex(0,1);
if(first!==-1) currentIndex=first;
showCard();
}

function findNextIndex(start,dir){
let i=start;
while(i>=0 && i<data.length){
if(passesFilters(data[i])) return i;
i+=dir;
}
return -1;
}

function toggleUncategorized(){
filterUncategorized=!filterUncategorized;
uncatToggle.classList.toggle("toggleActive");
resetToFirstMatch();
}

function toggleAttachment(){
filterAttachment=!filterAttachment;
attachmentToggle.classList.toggle("toggleActive");
resetToFirstMatch();
}

function applySearch(){
vendorFilter=document.getElementById("searchVendor").value.toLowerCase().trim();
amountFilter=parseFloat(document.getElementById("searchAmount").value);
if(isNaN(amountFilter)) amountFilter=null;
resetToFirstMatch();
}

function clearSearch(){
document.getElementById("searchVendor").value="";
document.getElementById("searchAmount").value="";
vendorFilter="";
amountFilter=null;
resetToFirstMatch();
}

function resetAllFilters(){
filterUncategorized=false;
filterAttachment=false;
vendorFilter="";
amountFilter=null;
document.getElementById("searchVendor").value="";
document.getElementById("searchAmount").value="";
uncatToggle.classList.remove("toggleActive");
attachmentToggle.classList.remove("toggleActive");
resetToFirstMatch();
}

function showVendorSuggestions(){
const input=document.getElementById("searchVendor").value.toLowerCase().trim();
const dropdown=document.getElementById("vendorDropdown");
if(!input){ dropdown.style.display="none"; return; }

const unique=[...new Set(data.map(d=>d.Vendor).filter(v=>v))];
const matches=unique.filter(v=>v.toLowerCase().includes(input)).slice(0,8);

if(!matches.length){ dropdown.style.display="none"; return; }

dropdown.innerHTML="";
matches.forEach(v=>{
const div=document.createElement("div");
div.className="vendor-option";
div.innerText=v;
div.onclick=()=>{
document.getElementById("searchVendor").value=v;
dropdown.style.display="none";
applySearch();
};
dropdown.appendChild(div);
});
dropdown.style.display="block";
}

function renderCategories(){
const div=document.getElementById("categoryButtons");
div.innerHTML="";
categories.forEach(cat=>{
const btn=document.createElement("button");
btn.className="category-btn "+cat.class;
btn.innerText=cat.name;
btn.onclick=()=>categorize(cat.name);
div.appendChild(btn);
});
const splitBtn=document.createElement("button");
splitBtn.className="category-btn";
splitBtn.style.background="#ff9800";
splitBtn.innerText="Split Transaction";
splitBtn.onclick=showSplitUI;
div.appendChild(splitBtn);
}

function categorize(name){
data[currentIndex].Category=name;
data[currentIndex].Splits=[];
updateTotals();
updateProgress();
goNext();
}

function showSplitUI(){
const item=data[currentIndex];
let html=`<div class="splitBox">
<strong>Total: $${item.Amount.toFixed(2)}</strong><br>
<div id="remainingBalance">Remaining: $${item.Amount.toFixed(2)}</div><br>`;
categories.forEach((c,i)=>{
html+=`${c.name}<br>
<input type="number" step="0.01" id="split_${i}" oninput="updateRemaining()"><br><br>`;
});
html+=`<button onclick="saveSplit()">Save Split</button></div>`;
splitContainer.innerHTML=html;
}

function updateRemaining(){
const item=data[currentIndex];
let total=0;
categories.forEach((c,i)=>{
total+=parseFloat(document.getElementById("split_"+i).value)||0;
});
const remaining=item.Amount-total;
const el=document.getElementById("remainingBalance");
el.innerText="Remaining: $"+remaining.toFixed(2);
el.style.color=Math.abs(remaining)<0.01?"green":remaining<0?"red":"orange";
}

function saveSplit(){
const item=data[currentIndex];
let total=0,splits=[];
categories.forEach((c,i)=>{
const val=parseFloat(document.getElementById("split_"+i).value)||0;
if(val>0){splits.push({Category:c.name,Amount:val});total+=val;}
});
if(Math.abs(total-item.Amount)>0.01){alert("Split must equal total.");return;}
item.Splits=splits;
item.Category="SPLIT";
updateTotals();
updateProgress();
goNext();
}

function attachReceipt(e){
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=function(ev){
data[currentIndex].Receipt={name:file.name,data:ev.target.result};
showCard();
};
reader.readAsDataURL(file);
}

function viewReceipt(){
const receipt=data[currentIndex].Receipt;
if(!receipt)return;
const byteString=atob(receipt.data.split(',')[1]);
const mimeString=receipt.data.split(',')[0].split(':')[1].split(';')[0];
const ab=new ArrayBuffer(byteString.length);
const ia=new Uint8Array(ab);
for(let i=0;i<byteString.length;i++) ia[i]=byteString.charCodeAt(i);
const blob=new Blob([ab],{type:mimeString});
window.open(URL.createObjectURL(blob));
}

function showCard(){
if(!data.length)return;
const item=data[currentIndex];
cardTitle.innerText=item.Title;
cardMeta.innerHTML=
(item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
(item.Date?`Date: ${item.Date}<br>`:"")+
`Amount: $${item.Amount.toFixed(2)}<br>`+
(item.Receipt?`ðŸ“Ž Receipt Attached<br>
<button class="viewBtn" onclick="viewReceipt()">View Receipt</button><br>`:"")+
`<br><input type="file" accept="image/*,.pdf" onchange="attachReceipt(event)">`;

if(item.Splits.length){
let splitHTML="<strong>Split Allocation:</strong><br>";
item.Splits.forEach(s=>{
splitHTML+=`${s.Category}: $${s.Amount.toFixed(2)}<br>`;
});
splitSummary.innerHTML=splitHTML;
}else{
splitSummary.innerHTML="";
}

currentCategory.innerText=item.Splits.length?"Split into multiple categories":"Current: "+(item.Category||"â€”");
splitContainer.innerHTML="";
}

function goNext(){ let next=findNextIndex(currentIndex+1,1); if(next!==-1){currentIndex=next;showCard();}}
function goBack(){ let prev=findNextIndex(currentIndex-1,-1); if(prev!==-1){currentIndex=prev;showCard();}}

function updateTotals(){
let totalsObj={};
categories.forEach(c=>totalsObj[c.name]=0);
data.forEach(d=>{
if(d.Splits.length){
d.Splits.forEach(s=>totalsObj[s.Category]+=s.Amount);
}else if(d.Category && totalsObj[d.Category]!=null){
totalsObj[d.Category]+=d.Amount;
}
});
totals.innerHTML="";
Object.keys(totalsObj).forEach(k=>{
totals.innerHTML+=`<div class="totalRow"><div>${k}</div><div>$${totalsObj[k].toFixed(2)}</div></div>`;
});
}

function updateProgress(){
const total=data.length;
const done=data.filter(d=>d.Category).length;
const percent=total?Math.round((done/total)*100):0;
progressBar.style.width=percent+"%";
progressText.innerText=`${done} of ${total} categorized (${percent}%)`;
}

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

</script>
</body>
</html>
