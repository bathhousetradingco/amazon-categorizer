latest 4

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:20px;
  background:#f4f4f4;
}

h2 { text-align:center; }

.panel {
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.08);
  margin-bottom:15px;
}

button {
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:12px;
  font-weight:600;
}

.navBtn {
  width:48%;
  background:#444;
  color:white;
}

.category-row {
  display:flex;
  align-items:center;
  margin-bottom:6px;
}

.category-btn {
  flex:1;
  color:white;
}

.info-btn {
  width:40px;
  margin-left:6px;
  background:#ddd;
  font-weight:bold;
}

.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}

.progress-bar-container {
  background:#eee;
  border-radius:999px;
  overflow:hidden;
  height:16px;
  margin-bottom:8px;
}

.progress-bar {
  height:100%;
  background:#2e7d32;
  width:0%;
}

.small { font-size:13px; color:#555; }

.totalRow {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:4px 0;
}

/* Modal */
.modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.6);
}

.modal-content {
  background:white;
  margin:10% auto;
  padding:20px;
  width:95%;
  max-width:700px;
  border-radius:14px;
  max-height:90vh;
  overflow:auto;
}

input[type="number"], select {
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

  <div class="panel">
    <div class="progress-bar-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <div id="progressText" class="small"></div>
  </div>

  <div class="panel">
    <div id="cardTitle">Upload CSV to begin</div>
    <div id="cardMeta" class="small"></div>
    <div id="currentCategory" class="small" style="margin-top:6px;"></div>

    <!-- suggestion box -->
    <div id="suggestionBox" class="small" style="margin-top:10px;"></div>

    <!-- ‚úÖ NEW: Receipt + Split Controls -->
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
      <input type="file" id="receiptUpload" accept="image/*" style="display:none;">
      <button onclick="triggerReceiptUpload()">üìé Upload Receipt</button>
      <button onclick="viewReceipt()">üëÅ View Receipt</button>
      <button onclick="openSplitEditor()">üßæ Split Transaction</button>
    </div>

    <hr>

    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
      <button class="navBtn" onclick="goBack()">‚¨Ö Back</button>
      <button class="navBtn" onclick="goNext()">Next ‚û°</button>
    </div>

    <div id="categoryButtons"></div>
  </div>

  <div class="panel">
    <h4>Totals</h4>
    <div id="totals"></div>
  </div>

  <button onclick="exportExcel()">Export to Excel</button>
  <button onclick="clearProgress()" style="background:#c62828;color:white;margin-top:10px;">Reset Saved Progress</button>

</div>

<!-- INFO MODAL -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
    <button onclick="closeModal()" style="margin-top:15px;background:#444;color:white;width:100%;">Close</button>
  </div>
</div>

<!-- ‚úÖ SPLIT MODAL -->
<div id="splitModal" class="modal">
  <div class="modal-content">
    <h3>Split Transaction</h3>
    <div id="splitHeader" class="small" style="margin-bottom:10px;"></div>

    <div id="splitList"></div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <input id="splitAmount" type="number" step="0.01" placeholder="Amount">
      <select id="splitCategory"></select>
      <button onclick="addSplit()">Add</button>
    </div>

    <div id="splitTotals" class="small" style="margin-top:12px;"></div>

    <div style="margin-top:15px;display:flex;gap:10px;">
      <button onclick="saveSplits()" style="background:#2e7d32;color:white;flex:1;">Save Splits</button>
      <button onclick="closeSplit()" style="background:#444;color:white;flex:1;">Cancel</button>
    </div>

    <button onclick="clearSplits()" style="background:#c62828;color:white;margin-top:10px;width:100%;">Clear Splits</button>
  </div>
</div>

<script>
const STORAGE_KEY = "bathhouse_categorizer_v7";

let rawRows=[], data=[], headers=[];
let currentIndex=0;

const categories = [
  {name:"COGS ‚Äì Ingredients", class:"cogs", info:`This includes all raw materials that physically go into your products.\n\nExamples for Bathhouse Trading Co:\n‚Ä¢ Oils (olive, coconut, castor)\n‚Ä¢ Butters (shea, mango)\n‚Ä¢ Lye\n‚Ä¢ Fragrance oils\n‚Ä¢ Essential oils\n‚Ä¢ Colorants, mica, oxides\n‚Ä¢ Extracts (green tea, birch, chamomile)\n‚Ä¢ Wax for melts\n‚Ä¢ Preservatives\n\nIf it becomes part of the product itself, it belongs here.`},
  {name:"COGS ‚Äì Packaging", class:"cogs", info:`This includes packaging that goes WITH the product or is used to ship customer orders.\n\nExamples:\n‚Ä¢ Soap boxes\n‚Ä¢ Lotion bottles & jars\n‚Ä¢ Lids, pumps, droppers\n‚Ä¢ Product labels\n‚Ä¢ Tissue paper in orders\n‚Ä¢ Shipping boxes\n‚Ä¢ Mailers\n‚Ä¢ Thank-you cards inside orders\n\nIf it‚Äôs used to package or ship finished goods, it belongs here.`},
  {name:"COGS ‚Äì Resale Inventory", class:"cogs", info:`Finished goods purchased and resold without modifying.\n\nExamples:\n‚Ä¢ Retail accessories bought wholesale\n‚Ä¢ Items purchased to resell at events\n‚Ä¢ Merchandise not manufactured by you`},
  {name:"COGS ‚Äì Production Supplies", class:"cogs", info:`Items used in production but not part of the final product.\n\nExamples:\n‚Ä¢ Gloves\n‚Ä¢ Paper towels in production\n‚Ä¢ Mold liners\n‚Ä¢ Disposable tools\n‚Ä¢ Alcohol for sanitizing equipment`},
  {name:"COGS ‚Äì Shipping from Suppliers", class:"cogs", info:`Freight or shipping costs paid to vendors.\n\nExamples:\n‚Ä¢ UPS charges from Bramble Berry\n‚Ä¢ Freight for pallet deliveries\n‚Ä¢ Shipping added to ingredient invoices`},
  {name:"Equipment", class:"expense", info:`Large or durable items used for business operations.\n\nExamples:\n‚Ä¢ Soap molds\n‚Ä¢ Mixers\n‚Ä¢ Shelving\n‚Ä¢ Display racks\n‚Ä¢ Label printers\n‚Ä¢ Production tables\n\nThese are NOT COGS ‚Äî they are business equipment.`},
  {name:"Advertising & Marketing", class:"expense", info:`Money spent to promote Bathhouse Trading Co.\n\nExamples:\n‚Ä¢ Facebook ads\n‚Ä¢ Event banners\n‚Ä¢ Printed flyers\n‚Ä¢ Promo giveaways\n‚Ä¢ Booth fees for markets`},
  {name:"Website & Software", class:"expense", info:`Digital tools and subscriptions.\n\nExamples:\n‚Ä¢ Shopify\n‚Ä¢ TaxJar\n‚Ä¢ Canva\n‚Ä¢ QuickBooks\n‚Ä¢ Email marketing software`},
  {name:"Merchant Processing Fees", class:"expense", info:`Payment processing fees.\n\nExamples:\n‚Ä¢ Shopify Payments fees\n‚Ä¢ Stripe fees\n‚Ä¢ Square fees`},
  {name:"Insurance", class:"expense", info:`Business insurance policies.\n\nExamples:\n‚Ä¢ Product liability insurance\n‚Ä¢ General liability\n‚Ä¢ Property insurance`},
  {name:"Utilities", class:"expense", info:`Operational utilities.\n\nExamples:\n‚Ä¢ Electricity\n‚Ä¢ Water\n‚Ä¢ Internet`},
  {name:"Professional Services", class:"expense", info:`Professional help.\n\nExamples:\n‚Ä¢ CPA\n‚Ä¢ Bookkeeper\n‚Ä¢ Legal services`},
  {name:"Needs Review", class:"special", info:`Unclear transactions.\n\nUse when:\n‚Ä¢ You‚Äôre unsure\n‚Ä¢ You want Steven‚Äôs input\n‚Ä¢ Something looks suspicious`}
];

/* ================= Suggestion logic (unchanged) ================= */

function normalize(text){
  return String(text||"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim();
}

function generateSuggestion(title, vendor){
  const text = normalize(title + " " + vendor);

  const rules = [
    {cat:"COGS ‚Äì Ingredients", words:["oil","butter","lye","fragrance","essential","mica","oxide","colorant","extract","wax","preservative","shea","mango","coconut","olive","castor"]},
    {cat:"COGS ‚Äì Packaging", words:["box","boxes","jar","jars","bottle","bottles","label","labels","mailer","mailers","tissue","lid","lids","pump","pumps","dropper","droppers","shrink","wrap","bag","bags"]},
    {cat:"COGS ‚Äì Production Supplies", words:["gloves","alcohol","isopropyl","paper towel","sanitizer","liner","liners","disposable","mask"]},
    {cat:"COGS ‚Äì Shipping from Suppliers", words:["shipping","freight","ups","fedex","dhl"]},
    {cat:"Website & Software", words:["shopify","taxjar","quickbooks","canva","subscription","domain","hosting","app fee"]},
    {cat:"Merchant Processing Fees", words:["processing","processor","stripe","square","shopify payments"]},
    {cat:"Advertising & Marketing", words:["ad","ads","facebook","instagram","banner","banners","flyer","flyers","booth","market fee","vendor fee","promo","promotion"]},
    {cat:"Utilities", words:["electric","electricity","water","internet","utility"]},
    {cat:"Insurance", words:["insurance","liability","policy"]},
    {cat:"Professional Services", words:["cpa","accountant","bookkeeper","legal","attorney","law"]},
    {cat:"Equipment", words:["mold","molds","mixer","shelving","shelf","printer","label printer","table","rack","scale","dehumidifier","heat gun"]}
  ];

  function whyNotOthers(chosen){
    const commonNot = [];
    if(chosen.startsWith("COGS")){
      commonNot.push(`‚Ä¢ Not "Equipment": COGS items are typically used up (or become part of a sold unit). Equipment is durable/reusable for months+.`);
    } else if(chosen === "Equipment"){
      commonNot.push(`‚Ä¢ Not "COGS": durable tools/machines aren‚Äôt consumed per unit sold; they support production over time.`);
    }
    if(chosen === "COGS ‚Äì Packaging"){
      commonNot.push(`‚Ä¢ Not "COGS ‚Äì Production Supplies": packaging goes with the product or ships the order; production supplies are used during making/cleanup and don‚Äôt leave with the customer.`);
    }
    if(chosen === "COGS ‚Äì Production Supplies"){
      commonNot.push(`‚Ä¢ Not "COGS ‚Äì Packaging": production supplies are used behind-the-scenes and don‚Äôt ship out with customer orders.`);
    }
    if(chosen.startsWith("COGS")){
      commonNot.push(`‚Ä¢ Not an operating expense (like Utilities/Insurance/Software): those keep the business running but don‚Äôt tie directly to producing/fulfilling a sellable item.`);
    } else {
      commonNot.push(`‚Ä¢ Not COGS: operating expenses support the business overall rather than being tied to a specific product or shipment.`);
    }
    if(chosen !== "Merchant Processing Fees"){
      commonNot.push(`‚Ä¢ Not "Merchant Processing Fees": those usually appear as Stripe/Square/Shopify Payments fee language rather than a product/material description.`);
    }
    return commonNot.join("\n");
  }

  for(const r of rules){
    for(const w of r.words){
      if(text.includes(w)){
        const confidence =
          (w.includes("shopify payments") || w.includes("label printer") || w.includes("isopropyl") || w.includes("taxjar"))
          ? "High"
          : (w.length >= 6 ? "Medium-High" : "Medium");

        return {
          category: r.cat,
          explanation:
`Matched keyword "${w}" in the title/vendor.

Why this category fits:
‚Ä¢ "${w}" is a strong clue this purchase is typically used as: ${r.cat}.
‚Ä¢ This suggestion is based on the description text (title/vendor), not the dollar amount.

Why it's NOT other categories:
${whyNotOthers(r.cat)}

Confidence: ${confidence}`
        };
      }
    }
  }

  return {
    category: "Needs Review",
    explanation:
`No strong keyword match was detected in the title/vendor.

Why this is "Needs Review":
‚Ä¢ The description doesn‚Äôt clearly indicate Ingredients vs Packaging vs Equipment vs an Operating Expense.
‚Ä¢ Some vendors (Amazon/Walmart) often contain mixed purchases that need a receipt to split correctly.

What to do next:
‚Ä¢ If you can, open the receipt/line-item detail.
‚Ä¢ If it‚Äôs clearly a material that goes into product ‚Üí Ingredients.
‚Ä¢ If it‚Äôs something customers receive (container/label/shipping supplies) ‚Üí Packaging.
‚Ä¢ If it‚Äôs durable/reusable (mixer, printer, shelving) ‚Üí Equipment.

Confidence: Low`
  };
}

function renderSuggestion(item){
  const box = document.getElementById("suggestionBox");
  if(!box) return;

  if(!item){
    box.innerHTML = "";
    return;
  }

  const s = generateSuggestion(item.Title, item.Vendor);

  box.innerHTML = `
    <div style="border:1px solid #ddd;padding:10px;border-radius:10px;">
      <b>Suggested:</b> ${s.category}
      <br><br>
      <button onclick="acceptSuggestion('${s.category.replace(/'/g,"&#39;")}')">Accept Suggestion</button>
      <button onclick="toggleExplanation()">‚ñ∂ Show detailed reasoning</button>
      <div id="explanationPanel" style="display:none;margin-top:10px;font-size:13px;line-height:1.35;">
        ${s.explanation.replace(/\n/g,"<br>")}
      </div>
    </div>
  `;
}

function toggleExplanation(){
  const p = document.getElementById("explanationPanel");
  if(!p) return;
  p.style.display = (p.style.display === "none" || !p.style.display) ? "block" : "none";
}

function acceptSuggestion(catName){
  if(!data.length) return;

  // If it was split, accepting a single category means you‚Äôre overriding splits.
  if(data[currentIndex].Splits && data[currentIndex].Splits.length){
    const ok = confirm("This transaction has splits. Accepting a single category will clear the splits. Continue?");
    if(!ok) return;
    data[currentIndex].Splits = [];
  }

  data[currentIndex].Category = catName;
  showCard();
  updateTotals();
  updateProgress();
  saveProgress();
}

/* ================= CSV Upload + Mapping (working) ================= */

document.getElementById("csvFile").addEventListener("change", function(e){
  localStorage.removeItem(STORAGE_KEY);
  const file = e.target.files[0];
  if(!file) return;

  Papa.parse(file, {
    header:true,
    skipEmptyLines:true,
    complete:function(res){
      rawRows = res.data;
      headers = Object.keys(rawRows[0] || {});
      showMapping();
    }
  });
});

function showMapping(){
  const panel = document.getElementById("mappingPanel");
  panel.style.display="block";

  panel.innerHTML=`
    <h4>Map Columns</h4>
    Title:<br>${dropdown("mapTitle")}<br><br>
    Amount:<br>${dropdown("mapAmount")}<br><br>
    Vendor (optional):<br>${dropdown("mapVendor",true)}<br><br>
    Date (optional):<br>${dropdown("mapDate",true)}<br><br>
    <button onclick="confirmMapping()">Confirm</button>
  `;
}

function dropdown(id, allowEmpty=false){
  let html = `<select id="${id}">`;
  if(allowEmpty) html += `<option value="">--None--</option>`;
  headers.forEach(h => html += `<option value="${h}">${h}</option>`);
  html += `</select>`;
  return html;
}

function confirmMapping(){
  const t=document.getElementById("mapTitle").value;
  const a=document.getElementById("mapAmount").value;
  const v=document.getElementById("mapVendor").value;
  const d=document.getElementById("mapDate").value;

  data = rawRows.map(r => ({
    Title: r[t] || "",
    Amount: parseFloat(String(r[a]).replace(/[$,]/g,"")) || 0,
    Vendor: v ? (r[v] || "") : "",
    Date: d ? (r[d] || "") : "",
    Category: "",
    Receipt: "",     // ‚úÖ new
    Splits: []       // ‚úÖ new
  }));

  document.getElementById("mappingPanel").style.display="none";
  document.getElementById("app").style.display="block";

  renderCategories();
  showCard();
  updateTotals();
  updateProgress();
  saveProgress();
}

/* ================= Category Buttons (working) ================= */

function renderCategories(){
  const div=document.getElementById("categoryButtons");
  div.innerHTML="";
  categories.forEach(c=>{
    const row=document.createElement("div");
    row.className="category-row";

    const btn=document.createElement("button");
    btn.className="category-btn "+c.class;
    btn.innerText=c.name;
    btn.onclick=()=>categorize(c.name);

    const info=document.createElement("button");
    info.className="info-btn";
    info.innerText="‚ìò";
    info.onclick=()=>showInfo(c);

    row.appendChild(btn);
    row.appendChild(info);
    div.appendChild(row);
  });
}

function showInfo(cat){
  document.getElementById("modalTitle").innerText=cat.name;
  document.getElementById("modalBody").innerText=cat.info;
  document.getElementById("infoModal").style.display="block";
}

function closeModal(){
  document.getElementById("infoModal").style.display="none";
}

/* ================= Receipt (NEW) ================= */

function triggerReceiptUpload(){
  if(!data.length) return;
  const input = document.getElementById("receiptUpload");
  input.value = "";
  input.click();
}

document.getElementById("receiptUpload").addEventListener("change", function(e){
  if(!data.length) return;
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement("canvas");
      const maxWidth = 1200;
      const scale = Math.min(1, maxWidth / img.width);

      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      data[currentIndex].Receipt = canvas.toDataURL("image/jpeg", 0.72);
      saveProgress();
      showCard();
      alert("Receipt saved to this transaction.");
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
});

function viewReceipt(){
  if(!data.length) return;
  const item = data[currentIndex];

  if(!item.Receipt){
    alert("No receipt uploaded for this transaction.");
    return;
  }

  document.getElementById("modalTitle").innerText = "Receipt";
  document.getElementById("modalBody").innerHTML = `
    <div style="text-align:center;">
      <img id="receiptImage"
           src="${item.Receipt}"
           style="max-width:100%;cursor:zoom-in;transition:transform .2s ease;">
      <div class="small" style="margin-top:8px;">Tap/click image to zoom in/out</div>
    </div>
  `;

  document.getElementById("infoModal").style.display="block";

  const img = document.getElementById("receiptImage");
  let zoom=false;
  img.onclick = function(){
    zoom = !zoom;
    img.style.transform = zoom ? "scale(2)" : "scale(1)";
    img.style.cursor = zoom ? "zoom-out" : "zoom-in";
  };
}

/* ================= Split Transactions (NEW) ================= */

function openSplitEditor(){
  if(!data.length) return;
  const item = data[currentIndex];

  // Ensure fields exist (for older saved progress)
  if(!item.Splits || !Array.isArray(item.Splits)) item.Splits = [];

  const sel = document.getElementById("splitCategory");
  sel.innerHTML = "";
  categories.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.innerText = c.name;
    sel.appendChild(opt);
  });

  document.getElementById("splitAmount").value = "";

  document.getElementById("splitHeader").innerHTML =
    `<b>${escapeHtml(item.Title)}</b><br>` +
    (item.Vendor ? `Vendor: ${escapeHtml(item.Vendor)}<br>` : "") +
    (item.Date ? `Date: ${escapeHtml(item.Date)}<br>` : "") +
    `Original Amount: $${Number(item.Amount||0).toFixed(2)}`;

  renderSplitList();
  document.getElementById("splitModal").style.display = "block";
}

function closeSplit(){
  document.getElementById("splitModal").style.display = "none";
}

function addSplit(){
  if(!data.length) return;
  const item = data[currentIndex];
  if(!item.Splits || !Array.isArray(item.Splits)) item.Splits = [];

  const amt = parseFloat(document.getElementById("splitAmount").value);
  const cat = document.getElementById("splitCategory").value;

  if(!amt || amt <= 0){
    alert("Enter a split amount greater than 0.");
    return;
  }

  item.Splits.push({ amount: amt, category: cat });
  document.getElementById("splitAmount").value = "";
  renderSplitList();
}

function removeSplit(i){
  const item = data[currentIndex];
  item.Splits.splice(i,1);
  renderSplitList();
}

function clearSplits(){
  if(!data.length) return;
  const item = data[currentIndex];
  if(confirm("Clear all splits for this transaction?")){
    item.Splits = [];
    saveProgress();
    renderSplitList();
    showCard();
    updateTotals();
    updateProgress();
  }
}

function renderSplitList(){
  const item = data[currentIndex];
  if(!item.Splits || !Array.isArray(item.Splits)) item.Splits = [];

  let html = "";
  let total = 0;

  item.Splits.forEach((s,i)=>{
    const amt = Number(s.amount||0);
    total += amt;
    html += `
      <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:6px 0;">
        <div>
          <div><b>${escapeHtml(s.category)}</b></div>
          <div class="small">$${amt.toFixed(2)}</div>
        </div>
        <button onclick="removeSplit(${i})" style="background:#c62828;color:white;">Remove</button>
      </div>
    `;
  });

  if(!html) html = `<div class="small">No splits yet. Add line items below.</div>`;

  const original = Number(item.Amount||0);
  const diff = total - original;
  const ok = Math.abs(diff) <= 0.01;

  document.getElementById("splitList").innerHTML = html;
  document.getElementById("splitTotals").innerHTML =
    `Split Total: <b>$${total.toFixed(2)}</b> &nbsp; | &nbsp; ` +
    `Original: <b>$${original.toFixed(2)}</b> &nbsp; | &nbsp; ` +
    (ok ? `<span style="color:#2e7d32;"><b>Balanced ‚úÖ</b></span>`
        : `<span style="color:#c62828;"><b>Not balanced ‚ùå</b> (Diff: $${diff.toFixed(2)})</span>`);
}

function saveSplits(){
  const item = data[currentIndex];
  const original = Number(item.Amount||0);
  const total = item.Splits.reduce((sum,s)=>sum+Number(s.amount||0),0);

  if(Math.abs(total-original) > 0.01){
    alert("Split total must equal original amount before saving.");
    return;
  }

  // If split exists, treat this row as ‚Äúdone‚Äù without forcing Category
  saveProgress();
  closeSplit();
  showCard();
  updateTotals();
  updateProgress();
}

/* ================= Core navigation + display (mostly original) ================= */

function categorize(name){
  const item = data[currentIndex];

  // If it is currently split, categorizing as single category will clear splits
  if(item.Splits && item.Splits.length){
    const ok = confirm("This transaction has splits. Assigning a single category will clear the splits. Continue?");
    if(!ok) return;
    item.Splits = [];
  }

  item.Category = name;

  if(currentIndex < data.length-1) currentIndex++;
  showCard();
  updateTotals();
  updateProgress();
  saveProgress();
}

function goBack(){
  if(currentIndex>0){
    currentIndex--;
    showCard();
    saveProgress();
  }
}

function goNext(){
  if(currentIndex<data.length-1){
    currentIndex++;
    showCard();
    saveProgress();
  }
}

function showCard(){
  if(!data.length){
    renderSuggestion(null);
    return;
  }

  const item = data[currentIndex];

  // normalize older data
  if(!("Receipt" in item)) item.Receipt = "";
  if(!("Splits" in item) || !Array.isArray(item.Splits)) item.Splits = [];

  const receiptBadge = item.Receipt ? " üìé" : "";
  const splitBadge = item.Splits.length ? " (SPLIT)" : "";

  document.getElementById("cardTitle").innerText = item.Title + receiptBadge + splitBadge;

  document.getElementById("cardMeta").innerHTML =
    (item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
    (item.Date?`Date: ${item.Date}<br>`:"")+
    `Amount: $${item.Amount.toFixed(2)}`;

  document.getElementById("currentCategory").innerText =
    item.Splits.length ? "Current: SPLIT" : ("Current: "+(item.Category||"‚Äî"));

  renderSuggestion(item);
}

/* ================= Totals + Progress updated for splits ================= */

function updateTotals(){
  let totals = {};
  categories.forEach(c=>totals[c.name]=0);

  data.forEach(d=>{
    if(d.Splits && d.Splits.length){
      d.Splits.forEach(s=>{
        if(totals[s.category] != null){
          totals[s.category] += Number(s.amount||0);
        }
      });
    } else if(d.Category){
      if(totals[d.Category] != null){
        totals[d.Category] += Number(d.Amount||0);
      }
    }
  });

  const div=document.getElementById("totals");
  div.innerHTML="";
  Object.keys(totals).forEach(k=>{
    div.innerHTML+=`<div class="totalRow"><div>${k}</div><div>$${totals[k].toFixed(2)}</div></div>`;
  });
}

function updateProgress(){
  const total = data.length;
  const done = data.filter(d => (d.Splits && d.Splits.length) || d.Category).length;
  const percent = total ? Math.round((done/total)*100) : 0;

  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressText").innerText =
    `${done} of ${total} categorized (${percent}%)`;
}

/* ================= Persistence ================= */

function saveProgress(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({data, currentIndex}));
}

function loadProgress(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if(!saved) return;

  const parsed = JSON.parse(saved);
  data = parsed.data || [];
  currentIndex = parsed.currentIndex || 0;

  // normalize older saves
  data.forEach(r=>{
    if(!("Receipt" in r)) r.Receipt = "";
    if(!("Splits" in r) || !Array.isArray(r.Splits)) r.Splits = [];
  });

  if(data.length){
    document.getElementById("app").style.display="block";
    renderCategories();
    showCard();
    updateTotals();
    updateProgress();
  }
}

function clearProgress(){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Categorized");
  XLSX.writeFile(wb, "Categorized.xlsx");
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

window.onload = loadProgress;
</script>
</body>
</html>