latest 20

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body {font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:20px;background:#f4f4f4;}
.panel {background:white;padding:16px;border-radius:14px;box-shadow:0 6px 25px rgba(0,0,0,.08);margin-bottom:15px;}
button {cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font-weight:600;}
.category-row {display:flex;margin-bottom:6px;}
.category-btn {flex:1;color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container {background:#eee;border-radius:999px;overflow:hidden;height:16px;margin-bottom:8px;}
.progress-bar {height:100%;background:#2e7d32;width:0%;}
.totalRow {display:flex;justify-content:space-between;font-size:13px;padding:4px 0;}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>
<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText"></div>
</div>

<div class="panel">
<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta"></div>
<div id="currentCategory"></div>
<hr>
<button onclick="goBack()">⬅ Back</button>
<button onclick="goNext()">Next ➡</button>
<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<script>

let rawRows=[], data=[], headers=[];
let currentIndex=0;

const categories = [
{name:"COGS – Ingredients",class:"cogs"},
{name:"COGS – Packaging",class:"cogs"},
{name:"COGS – Resale Inventory",class:"cogs"},
{name:"COGS – Production Supplies",class:"cogs"},
{name:"COGS – Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Needs Review",class:"special"}
];

/* ===========================
   CSV Upload
=========================== */

document.getElementById("csvFile").addEventListener("change",function(e){

  const file=e.target.files[0];
  if(!file)return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:function(res){

      rawRows = res.data.filter(row =>
        Object.values(row).some(v => v !== null && v !== "")
      );

      if(!rawRows.length){
        alert("No valid data found.");
        return;
      }

      headers = Object.keys(rawRows[0]);

      showMapping();
    }
  });
});

/* ===========================
   Mapping
=========================== */

function showMapping(){

  const panel=document.getElementById("mappingPanel");
  panel.style.display="block";

  const hasCategory=headers.some(h=>h.toLowerCase()==="category");

  panel.innerHTML=`
    <h4>Map Columns</h4>
    Title:<br>${dropdown("mapTitle")}<br><br>
    Amount:<br>${dropdown("mapAmount")}<br><br>
    Vendor:<br>${dropdown("mapVendor",true)}<br><br>
    Date:<br>${dropdown("mapDate",true)}<br><br>
    ${hasCategory?`Category:<br>${dropdown("mapCategory",true)}<br><br>`:""}
    <button onclick="confirmMapping()">Confirm</button>
  `;

  if(hasCategory){
    const actual=headers.find(h=>h.toLowerCase()==="category");
    document.getElementById("mapCategory").value=actual;
  }
}

function dropdown(id,allowEmpty=false){
  let html=`<select id="${id}">`;
  if(allowEmpty) html+=`<option value="">--None--</option>`;
  headers.forEach(h=>html+=`<option value="${h}">${h}</option>`);
  return html+="</select>";
}

function confirmMapping(){

  const t=document.getElementById("mapTitle").value;
  const a=document.getElementById("mapAmount").value;
  const v=document.getElementById("mapVendor").value;
  const d=document.getElementById("mapDate").value;
  const cSelect=document.getElementById("mapCategory");
  const c=cSelect?cSelect.value:"";

  data = rawRows.map(r=>{

    let categoryValue="";
    if(c){
      const value=r[c]||"";
      const valid=categories.find(cat=>cat.name===value);
      if(valid) categoryValue=value;
    }

    return{
      Title:r[t]||"",
      Amount:parseFloat(String(r[a]).replace(/[$,]/g,""))||0,
      Vendor:v?r[v]||"":"",
      Date:d?r[d]||"",
      Category:categoryValue
    };
  });

  document.getElementById("mappingPanel").style.display="none";
  document.getElementById("app").style.display="block";

  renderCategories();
  showCard();
  updateTotals();
  updateProgress();
}

/* ===========================
   Core App
=========================== */

function renderCategories(){
  const div=document.getElementById("categoryButtons");
  div.innerHTML="";
  categories.forEach(c=>{
    const row=document.createElement("div");
    row.className="category-row";
    const btn=document.createElement("button");
    btn.className="category-btn "+c.class;
    btn.innerText=c.name;
    btn.onclick=()=>categorize(c.name);
    row.appendChild(btn);
    div.appendChild(row);
  });
}

function categorize(name){
  data[currentIndex].Category=name;
  if(currentIndex<data.length-1) currentIndex++;
  showCard();
  updateTotals();
  updateProgress();
}

function goBack(){
  if(currentIndex>0){currentIndex--;showCard();}
}

function goNext(){
  if(currentIndex<data.length-1){currentIndex++;showCard();}
}

function showCard(){
  if(!data.length)return;
  const item=data[currentIndex];
  document.getElementById("cardTitle").innerText=item.Title;
  document.getElementById("cardMeta").innerHTML=
    (item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
    (item.Date?`Date: ${item.Date}<br>`:"")+
    `Amount: $${item.Amount.toFixed(2)}`;
  document.getElementById("currentCategory").innerText=
    "Current: "+(item.Category||"—");
}

function updateTotals(){
  let totals={};
  categories.forEach(c=>totals[c.name]=0);
  data.forEach(d=>{
    if(d.Category && totals[d.Category]!=null){
      totals[d.Category]+=d.Amount;
    }
  });
  const div=document.getElementById("totals");
  div.innerHTML="";
  Object.keys(totals).forEach(k=>{
    div.innerHTML+=`<div class="totalRow"><div>${k}</div><div>$${totals[k].toFixed(2)}</div></div>`;
  });
}

function updateProgress(){
  const total=data.length;
  const done=data.filter(d=>d.Category).length;
  const percent=total?Math.round((done/total)*100):0;
  document.getElementById("progressBar").style.width=percent+"%";
  document.getElementById("progressText").innerText=
    `${done} of ${total} categorized (${percent}%)`;
}

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Categorized");
  XLSX.writeFile(wb,"Categorized.xlsx");
}

</script>
</body>
</html>
