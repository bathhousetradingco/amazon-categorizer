<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg: #f3f6fb;
  --panel: #ffffff;
  --panel-alt: #f9fbff;
  --text: #172033;
  --text-soft: #55627a;
  --border: #dce3ef;
  --shadow: 0 10px 30px rgba(23, 32, 51, 0.08);
  --radius: 16px;
}

* { box-sizing: border-box; }

body {
  font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin: 0;
  background: linear-gradient(180deg, #eef3ff 0%, var(--bg) 220px);
  color: var(--text);
}

.appShell {
  width: min(100%, 980px);
  margin: 0 auto;
  padding: 14px;
}

h2 {
  text-align: center;
  margin: 8px 0 16px;
  letter-spacing: 0.2px;
}

.panel {
  background: var(--panel);
  padding: 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin-bottom: 12px;
}

button {
  cursor: pointer;
  border: none;
  border-radius: 12px;
  padding: 12px;
  font-weight: 600;
  transition: transform .12s ease, filter .12s ease;
}

button:hover { filter: brightness(1.04); }
button:active { transform: translateY(1px); }

input, select {
padding:12px;
border-radius:12px;
border:1px solid var(--border);
background:#fff;
width:100%;
font-size:16px;
}

.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:var(--text-soft);}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:6px 0; cursor:pointer; border-bottom:1px solid #eee;}
.totalRow:hover { background:#f5f5f5; }
.splitBox { background:var(--panel-alt); padding:10px; border-radius:10px; border:1px solid var(--border);}
.viewBtn { background:#1565c0; color:white; margin-top:6px;}
.removeBtn { background:#c62828; color:white; margin-top:6px;}
.appGrid { display: grid; gap: 12px; }
.mainColumn {
  display: grid;
  gap: 0;
}
.integratedCard {
  border-radius: 0;
  margin-bottom: 0;
  box-shadow: none;
}
.integratedCard:first-child {
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
}
.integratedCard:last-child {
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: var(--radius);
  border-top: none;
}
.receiptUploadLabel {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px dashed #1565c0;
  color: #1565c0;
  font-weight: 600;
  background: #eff6ff;
  cursor: pointer;
  margin-top: 8px;
}
.receiptUploadInput { display: none; }
.lineItemsPanel {
  margin-top: 10px;
  background: var(--panel-alt);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
}
.lineItemsPanel h4 { margin: 0 0 8px; }
.currentCategoryBadge {
  display: inline-block;
  margin-top: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  background: #1e3a8a;
  color: #fff;
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 0.2px;
}
.fileInput { margin-bottom: 12px; background: #fff; }
.appCard { padding: 12px; }
.topControls { margin-bottom: 10px; }
.totalsPanel { margin-bottom: 14px; }
.exportBtn { width: 100%; background: #111827; color: #fff; }
.authTitle, .panel h4 { margin-top: 0; }

.modalOverlay {
position:fixed;
top:0; left:0;
width:100%; height:100%;
background:rgba(0,0,0,.6);
display:none;
justify-content:center;
align-items:center;
z-index:100000; /* üëà increased */
overflow:auto;
padding: 8px;
}

.modalBox {
  background:white;
  width:98%;
  max-width:1100px;   /* üëà BIGGER */
  height:90vh;        /* üëà FULL HEIGHT */
  border-radius:16px;
  display:flex;
  flex-direction:column;
  overflow: hidden;
  transform: translateY(12px) scale(.99);
  opacity: 0;
  transition: transform .24s ease, opacity .2s ease;
  will-change: transform, opacity;
}

.modalDragHandle {
  width: 44px;
  height: 5px;
  border-radius: 999px;
  background: #d1d5db;
  margin: 10px auto 4px;
  flex: 0 0 auto;
}

.modalOverlay.isOpen .modalBox {
  transform: translateY(0) scale(1);
  opacity: 1;
}

#modalContent {
  flex:1;
  overflow:auto;
  padding:10px;
}

.modalClose {
background:#c62828;
color:white;
margin-top:10px;
width:100%;
}

.modalItem {
padding:8px;
border-bottom:1px solid #eee;
cursor:pointer;
}
.modalItem:hover { background:#f5f5f5; }

.filterBtn {
background:#ff9800;
color:white;
margin-top:8px;
}

.menuToggleBtn {
  width:100%;
  background:#37474f;
  color:white;
  margin-bottom:8px;
}

.quickActionsMenu {
  display:none;
  background:#eef2f5;
  border-radius:10px;
  padding:8px;
  margin-bottom:8px;
}

.quickActionsMenu.open {
  display:block;
}

/* RECEIPT VIEW */
.receiptPreview iframe {
  width:100%;
  height:85vh;
  border:none;
  border-radius:10px;
}

.receiptPreview img {
  width:100%;
  max-height:85vh;
  object-fit:contain;
}

/* SPLIT LAYOUT */
.splitModalLayout { display:grid; grid-template-rows:auto minmax(0,1fr) auto; height:100%; gap:12px; padding: 0 4px 8px; }
.splitHeaderRow { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.splitHeaderTitle { margin: 0; font-size: 18px; }
.splitHeaderExit { background:#c62828; color:#fff; min-height:40px; min-width:40px; padding:8px 12px; }
.splitTotalsCard {
  position: sticky;
  bottom: 0;
  z-index: 3;
  background: rgba(255,255,255,.96);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:10px;
  box-shadow: 0 -10px 24px rgba(23,32,51,.12);
  transition: box-shadow .2s ease, border-color .2s ease, transform .18s ease;
}
.splitMetric { font-size:12px; color:var(--text-soft); }
.splitMetric strong { display:block; margin-top:3px; font-size:18px; color:var(--text); }
.splitMetric.remaining strong { transition: color .2s ease, transform .2s ease; }
.splitMetric.remaining.nearDone strong { color:#c47f00; }
.splitMetric.remaining.done strong { color:#2e7d32; transform: scale(1.04); }
.splitMetric.remaining.zeroFlash strong { animation: remainingCelebrate .32s ease; }
@keyframes remainingCelebrate { 0%{ transform:scale(1);} 45%{transform:scale(1.08);} 100%{transform:scale(1.04);} }
.splitBody {
  min-height: 0;
  display:grid;
  grid-template-columns:minmax(0,1fr);
  gap:12px;
  overflow: hidden;
}
.receiptCard {
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  padding:10px;
  box-shadow: 0 4px 16px rgba(23,32,51,.08);
}
.receiptControls { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
.receiptViewport {
  width:100%;
  max-height: 240px;
  overflow:auto;
  border-radius:10px;
  background:#0f172a;
  touch-action: pan-y pinch-zoom;
}
.receiptViewport.expanded { max-height: 66vh; }
.receiptViewport img, .receiptViewport iframe { width:100%; height:auto; display:block; border:none; object-fit:contain; }
.lineItemsScroller {
  min-height: 0;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background: var(--panel-alt);
  display:grid;
  gap:10px;
}
.splitItemRow {
  display:grid;
  gap:10px;
  padding:12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
  transition: background-color .25s ease, border-color .25s ease;
}
.splitItemMeta { display:flex; align-items:center; justify-content:space-between; gap:10px; }
.splitItemActions { display:flex; flex-wrap:wrap; gap:8px; }
.splitItemActions .touchButton { flex:1 1 calc(50% - 4px); }
.splitItemRow.justAdded { animation: splitPulse .45s ease; border-color:#2e7d32; background:#f1fbf2; }
@keyframes splitPulse { 0%{transform:scale(.99)} 60%{transform:scale(1.01)} 100%{transform:scale(1)} }
.splitFooterSticky {
  position: sticky;
  bottom: 0;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 14px;
  padding:12px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  box-shadow: 0 -6px 18px rgba(23,32,51,.1);
}
.touchButton { min-height:44px; }
.touchButton.tapPulse { transform: scale(.98); filter: brightness(.98); }

.keypadOverlay { position: fixed; inset: 0; background: rgba(15, 23, 42, .45); z-index: 100100; display:none; align-items:flex-end; justify-content:center; }
.keypadOverlay.open { display:flex; }
.keypadSheet { width:min(100%, 520px); background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; padding:12px; box-shadow: 0 -12px 30px rgba(0,0,0,.22); transform: translateY(18px); opacity:0; transition: transform .2s ease, opacity .2s ease; }
.keypadOverlay.open .keypadSheet { transform: translateY(0); opacity:1; }
.keypadDisplay { border:1px solid var(--border); border-radius:12px; padding:12px; font-size:26px; text-align:right; margin-bottom:10px; }
.keypadGrid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; }
.keypadKey { background:#f3f6fb; color:#172033; min-height:54px; font-size:18px; }
.keypadKey.action { background:#1e3a8a; color:#fff; }
.keypadKey.warn { background:#c62828; color:#fff; }
.keypadHint { min-height:18px; margin:6px 0 0; font-size:12px; color:#b45309; }

@media (max-width: 620px) {
  .modalOverlay { padding: 0; align-items: flex-end; }
  .modalBox { width:100%; height:96vh; border-bottom-left-radius:0; border-bottom-right-radius:0; }
  .splitTotalsCard { grid-template-columns: 1fr; gap:6px; }
}


.workflowHeader h3 { margin: 0 0 10px; }
.workflowSteps {
  display:grid;
  gap:8px;
  grid-template-columns: repeat(auto-fit, minmax(170px,1fr));
}
.workflowStep {
  background: linear-gradient(135deg, #f7f9ff, #edf3ff);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px;
  font-size: 14px;
  color: var(--text-soft);
  display:flex;
  align-items:center;
  gap:8px;
}
.workflowStep span {
  width: 24px;
  height: 24px;
  border-radius: 999px;
  background: #1565c0;
  color: white;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  font-weight:700;
  font-size:12px;
}
.controlsCard h3 { margin-top: 0; }
.filterGrid {
  display:grid;
  gap:8px;
  grid-template-columns: 1fr;
  margin-top: 8px;
}
.filterGrid label {
  font-size: 13px;
  color: var(--text-soft);
  display:flex;
  flex-direction:column;
  gap:4px;
}

.categoryPickerCompact {
  display: grid;
  gap: 8px;
}

.categoryPickerRow {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}

.categoryPickerActions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.inlineHint {
  font-size: 12px;
  color: var(--text-soft);
}


@media (min-width: 700px) {
  .filterGrid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .categoryPickerRow {
    grid-template-columns: minmax(0, 1fr) auto;
    align-items: center;
  }
}

@media (min-width: 900px) {
  .appGrid {
    grid-template-columns: minmax(0, 1.7fr) minmax(280px, 1fr);
    align-items: start;
  }

  .stickyColumn {
    position: sticky;
    top: 14px;
  }
}

</style>
</head>

<body>
<main class="appShell">
<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" class="fileInput" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>
<div id="authPanel" class="panel">
  <h3>Login</h3>

  <input type="email" id="loginEmail" placeholder="Email" style="margin-bottom:8px;">
  <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom:8px;">

  <button onclick="login()" style="background:#2e7d32; color:white; width:100%;">
    Login
  </button>
</div>
  
<div id="app" style="display:none;">
<div class="appGrid">
<div class="mainColumn">
<div class="panel appCard controlsCard integratedCard">
  <h3>Transaction Navigator</h3>

  <button id="searchBtn" class="category-btn" style="background:#ff9800; margin-bottom:8px;" onclick="openSearchModal()">üîé Search</button>
  <button id="clearSearchBtn" class="category-btn" style="background:#c62828; margin-bottom:8px; display:none;" onclick="clearSearchFilter()">Clear Search Filter</button>

  <button id="quickActionsToggleBtn" class="menuToggleBtn" onclick="toggleQuickActionsMenu()">
  ‚ò∞ Quick Actions
  </button>

  <div id="quickActionsMenu" class="quickActionsMenu">
    <button id="createTransactionBtn" class="category-btn" style="background:#1565c0; margin-bottom:8px;" onclick="openCreateTransactionModal()">
    ‚ûï Create Transaction
    </button>
    <button class="category-btn" style="background:#2e7d32; margin-bottom:8px;" onclick="connectBank()">üè¶ Connect Bank</button>
    <button class="category-btn" style="background:#000; margin-bottom:0;" onclick="forcePlaidSync()">üîÑ Sync Bank Now</button>
  </div>

  <div class="filterGrid">
    <label>
      Year
      <select id="yearFilter" onchange="applyYearFilter()">
        <option value="">All Years</option>
      </select>
    </label>
    <label>
      Transaction Date
      <input type="date" id="dateFilter" onchange="applyDateFilter()">
    </label>
  </div>
  <button id="clearDateBtn" class="category-btn" style="background:#6b7280; margin-top:8px; display:none;" onclick="clearDateFilter()">Clear Date Filter</button>

  <div class="progress-bar-container">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  <div id="positionIndicator" class="small" style="margin-top:4px;"></div>
  <div id="progressText" class="small"></div>
</div>

<div class="panel appCard integratedCard">
  <h3 id="cardTitle"></h3>
  <div id="cardMeta" class="small"></div>
  <div id="currentCategory" class="small"></div>
  <div id="splitSummary" class="lineItemsPanel"></div>

  <button onclick="resetSplits()" style="background:#c62828; color:white; padding:10px 14px; border-radius:10px; margin-top:10px; width:100%;">
    Reset Splits
  </button>

  <hr>

  <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
    <button class="navBtn" onclick="goBack()">‚¨Ö Back</button>
    <button class="navBtn" onclick="goNext()">Next ‚û°</button>
  </div>

  <h4>Choose Category</h4>
  <div id="categoryButtons"></div>
</div>
</div>

<div class="panel totalsPanel stickyColumn">
  <h4>Totals & Planning</h4>
  <div id="totals"></div>
  <button onclick="exportExcel()" class="exportBtn">Export to Excel</button>
</div>

</div>
</div>

<div id="modalOverlay" class="modalOverlay">
<div class="modalBox">
<div class="modalDragHandle" aria-hidden="true"></div>
<h3 id="modalTitle"></h3>
<div id="modalContent"></div>
<button id="modalCloseBtn" class="modalClose" onclick="closeModal()">Close</button>
</div>
</div>
<div id="keypadOverlay" class="keypadOverlay" onclick="handleKeypadBackdrop(event)">
  <div class="keypadSheet" role="dialog" aria-label="Amount keypad">
    <div id="keypadTitle" class="small" style="margin-bottom:8px;font-weight:700;color:#172033;">Enter amount</div>
    <div id="keypadDisplay" class="keypadDisplay">$0.00</div>
    <div class="keypadGrid" id="keypadGrid"></div>
    <div id="keypadHint" class="keypadHint"></div>
  </div>
</div>
</main>

<script>

const app = document.getElementById("app");
const modalOverlay = document.getElementById("modalOverlay");
const modalContent = document.getElementById("modalContent");
const modalTitle = document.getElementById("modalTitle");
const cardTitle = document.getElementById("cardTitle");
const cardMeta = document.getElementById("cardMeta");
const splitSummary = document.getElementById("splitSummary");
const currentCategory = document.getElementById("currentCategory");
const totals = document.getElementById("totals");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const modalCloseBtn = document.getElementById("modalCloseBtn");
const keypadOverlay = document.getElementById("keypadOverlay");
const keypadGrid = document.getElementById("keypadGrid");
const keypadDisplay = document.getElementById("keypadDisplay");
const keypadHint = document.getElementById("keypadHint");
const keypadTitle = document.getElementById("keypadTitle");

// UI COMPONENTS
const UIComponents = {
  updateHTML(el, html){ if(el) el.innerHTML = html; },
  setText(el, text){ if(el) el.innerText = text; }
};

function initTouchFeedback(){
  document.addEventListener("pointerdown", (event) => {
    const button = event.target.closest("button");
    if(!button) return;
    button.classList.add("tapPulse");
    window.setTimeout(() => button.classList.remove("tapPulse"), 140);
  });
}

initTouchFeedback();

// STATE MANAGEMENT
const AppState = {
  get currentItem(){ return data[currentIndex]; },
  get isModalOpen(){ return modalOverlay.style.display === "flex"; }
};

// API LAYER
const Api = {
  async updateTransaction(id, payload){
    if(!id) return { error: null };
    return supabaseClient.from("transactions").update(payload).eq("id", id);
  }
};

// UTILITIES
const Utils = {
  cents(value){ return Math.round(parseFloat(value || 0) * 100); },
  money(value){ return `$${parseFloat(value || 0).toFixed(2)}`; }
};

function toggleQuickActionsMenu() {
  const menu = document.getElementById("quickActionsMenu");
  menu.classList.toggle("open");
}

/* ALL YOUR ORIGINAL JS REMAINS UNCHANGED BELOW */

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;
let showOnlyUncategorized=false;
let activeSearchFilter=null;
let splitMode = false;
let activeYearFilter = null;
let activeDateFilter = null;
let aiContext = null; 
// null = normal transaction
// { type: "receipt", index: X } = receipt item mode
/* ================= LOAD FROM SUPABASE ================= */

async function loadTransactions() {
  const { data: rows, error } = await supabaseClient
    .from("transactions")
    .select("*")
    .order("date", { ascending: true }); // safer than created_at

  if (error) {
    console.error("Load error:", error);
    return;
  }

  console.log("Rows from Supabase:", rows);

  data = rows.map(r => ({
  id: r.id,

  // üî• FIXED MAPPING
  Title: r.name || r.merchant_name || r.title || "",
  Vendor: r.merchant_name || r.vendor || r.name || "",

  Date: r.date,
  Amount: r.amount,

  Category: r.category || "",
  Splits: r.splits || [],

  receipt_url: r.receipt_url,

  Institution: r.institution_name || r.institution || ""
}));

  app.style.display = "block";

  renderCategories();
  populateYearFilter();
  updateTotals();
  updateProgress();

  if (data.length > 0) {
    showCard();
  }
}


/* ================= SUPABASE ================= */

/* ================= SUPABASE ================= */

const SUPABASE_URL = "https://xbayklklcdohewvnbglq.supabase.co";

const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhiYXlrbGtsY2RvaGV3dm5iZ2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjQ0ODYsImV4cCI6MjA4NzEwMDQ4Nn0.ZPfwZfGGfziSw5CzehkW1S3m40Gf1FOPXeG7Je3Cp7Q";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* üîê ADD THIS RIGHT HERE */
async function getAuthHeaders() {
  const { data: { session } } = await supabaseClient.auth.getSession();

  if (!session) {
    alert("You must be logged in.");
    throw new Error("No session");
  }

  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${session.access_token}`
  };
}
  async function login() {

  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert(error.message);
    return;
  }

  document.getElementById("authPanel").style.display = "none";
  app.style.display = "block";

  await loadTransactions();
}

async function checkSession() {

  const { data: { session } } = await supabaseClient.auth.getSession();

  if (session) {
    document.getElementById("authPanel").style.display = "none";
    app.style.display = "block";
    await loadTransactions();
  } else {
    document.getElementById("authPanel").style.display = "block";
    app.style.display = "none";
  }
}

window.addEventListener("DOMContentLoaded", checkSession);

const categories=[
{
name:"COGS - Ingredients",
class:"cogs",
description:`
<strong>Definition:</strong><br>
Raw materials that physically become part of a finished Bathhouse product.<br><br>

<strong>Examples:</strong><br>
‚Ä¢ Olive oil, coconut oil, shea butter<br>
‚Ä¢ Grass-fed tallow<br>
‚Ä¢ Essential oils & phthalate-free fragrance oils<br>
‚Ä¢ Lye<br>
‚Ä¢ Mica, titanium dioxide (in product)<br>
‚Ä¢ Goat milk<br>
‚Ä¢ Aloe juice (in soap/lotion)<br><br>

<strong>Does NOT Include:</strong><br>
‚Ä¢ Cleaning chemicals<br>
‚Ä¢ Soap nuts for cleaning<br>
‚Ä¢ Store hand soap<br><br>

Ask yourself: Does this physically go inside the product being sold?
`
},
{
name:"COGS - Packaging",
class:"cogs",
description:`
<strong>Definition:</strong><br>
Packaging that becomes part of the product at time of sale.<br><br>

<strong>Examples:</strong><br>
‚Ä¢ Soap boxes<br>
‚Ä¢ Shrink wrap<br>
‚Ä¢ Product labels<br>
‚Ä¢ Ingredient labels<br>
‚Ä¢ Jars & pump tops<br>
‚Ä¢ Lip balm tubes<br>
‚Ä¢ Deodorant tubes<br>
‚Ä¢ Inserts inside retail packaging<br><br>

<strong>Does NOT Include:</strong><br>
‚Ä¢ Shipping boxes<br>
‚Ä¢ Tissue paper in shipments<br>
‚Ä¢ Packing tape<br>
‚Ä¢ Shipping labels<br><br>

Rule: If it stays attached to the product itself ‚Üí Packaging.
`
},
{
name:"COGS - Resale Inventory",
class:"cogs",
description:`
Items purchased finished and resold without modification.<br><br>

Examples:<br>
‚Ä¢ Pumice stones sold as-is<br>
‚Ä¢ Sleep masks<br>
‚Ä¢ Wholesale accessories<br>
`
},
{
name:"COGS - Production Supplies",
class:"cogs",
description:`
Consumables used during production but not in final product.<br><br>

Examples:<br>
‚Ä¢ Gloves<br>
‚Ä¢ Mixing sticks<br>
‚Ä¢ Alcohol for sanitizing<br>
‚Ä¢ Paper towels used in production<br>
‚Ä¢ Mold liners<br>
`
},
{
name:"COGS - Shipping from Suppliers",
class:"cogs",
description:`
Freight-in paid to receive ingredients or inventory.<br><br>

Examples:<br>
‚Ä¢ Shipping from Wholesale Supplies Plus<br>
‚Ä¢ Freight charges on jars<br>
‚Ä¢ UPS cost from ingredient vendors<br>
`
},
{
name:"Shipping Supplies",
class:"expense",
description:`
Materials used to ship orders to customers.<br><br>

Examples:<br>
‚Ä¢ Shipping boxes<br>
‚Ä¢ Tissue paper in shipping box<br>
‚Ä¢ Bubble wrap<br>
‚Ä¢ Packing tape<br>
‚Ä¢ Order stickers<br>
‚Ä¢ Shipping label paper<br><br>

This is NOT COGS.
`
},
{
name:"Shipping to Customers",
class:"expense",
description:`
Postage or shipping labels purchased to send orders.<br><br>

Examples:<br>
‚Ä¢ USPS postage<br>
‚Ä¢ UPS postage<br>
‚Ä¢ Shopify shipping labels<br>
`
},
{
name:"Advertising & Marketing",
class:"expense",
description:`
Promotional spending to generate sales.<br><br>

Examples:<br>
‚Ä¢ Facebook ads<br>
‚Ä¢ Google Ads<br>
‚Ä¢ Newspaper ads<br>
‚Ä¢ Loofah Fest signage<br>
‚Ä¢ Canva Pro (if marketing related)<br>
`
},
{
name:"Commissions & Merchant Fees",
class:"expense",
description:`
Transaction fees charged by payment processors.<br><br>

Examples:<br>
‚Ä¢ Shopify processing fees<br>
‚Ä¢ Square fees<br>
‚Ä¢ Faire commission fees<br>
`
},
{
name:"Software & Subscriptions",
class:"expense",
description:`
Recurring digital tools used to run Bathhouse.<br><br>

Examples:<br>
‚Ä¢ Shopify subscription<br>
‚Ä¢ QuickBooks<br>
‚Ä¢ Supabase<br>
‚Ä¢ Plaid<br>
`
},
{
name:"Insurance",
class:"expense",
description:`Business or product liability insurance.`
},
{
name:"Utilities",
class:"expense",
description:`Electric, water, internet used for business.`
},
  {
  name:"Office Supplies",
  class:"expense",
  description:`
Office consumables used to operate Bathhouse Trading Company.

Examples:
‚Ä¢ Printer paper
‚Ä¢ Receipt paper
‚Ä¢ Pens
‚Ä¢ File folders
‚Ä¢ Storage bins
‚Ä¢ Desk organizers

Does NOT include:
‚Ä¢ Product packaging
‚Ä¢ Shipping supplies
‚Ä¢ Equipment over $2,500 (capital asset)
`
},
  {
name:"Equipment",
class:"expense",
description:`
Business equipment purchases under IRS capitalization threshold.

Examples:
‚Ä¢ Label printer
‚Ä¢ Small shelving
‚Ä¢ Storage racks
‚Ä¢ Small tools
‚Ä¢ Washer/dryer (if expensed, not depreciated)

Note: Larger capital assets may require depreciation.
`
},
  {
name:"Meals",
class:"expense",
description:`
Business meals related to operations.

Examples:
‚Ä¢ Vendor meetings
‚Ä¢ Market event meals
‚Ä¢ Business planning lunches

Note: Typically 50% deductible.
`
},
{
name:"Professional Services",
class:"expense",
description:`CPA, legal fees, consulting services.`
},
{
name:"Fuel",
class:"expense",
description:`Gas used for markets, supply pickups, or business travel.`
},
{
name:"Taxes & Licenses",
class:"expense",
description:`Business license fees and state filings (not income tax).`
},
{
  name:"Sales Tax Paid",
  class:"expense",
  description:`
Sales tax paid on business purchases.

Examples:
‚Ä¢ Sales tax on ingredient purchases
‚Ä¢ Sales tax on packaging
‚Ä¢ Sales tax on equipment

This is NOT income tax.
`
},
{
name:"Interest Expense",
class:"expense",
description:`Credit card or business loan interest.`
},
  
{
name:"Needs Review",
class:"special",
description:`If unsure, temporarily park the transaction here.`
}
];
const categoryAliases = {

  // Software rename
  "Software": "Software & Subscriptions",

  // Advertising rename
  "Advertising": "Advertising & Marketing",

  // Gas rename
  "Gas": "Fuel",

  // Interest rename
  "Other Interest": "Interest Expense",

  // Office rename (choose correct destination)
  "Office / Admin": "Office Supplies",

  // Old spelling
  "COGS - Resell Inventory": "COGS - Resale Inventory",

  // Explicit no category
  "NO CATEGORY": "Needs Review",

  // Merchant rename
  "Merchant Processing Fees": "Commissions & Merchant Fees"

};
/* ================= SEARCH ================= */

function openSearchModal(){
modalTitle.innerText="Search Transactions";
modalContent.innerHTML=`
<input type="text" id="searchInput" placeholder="Search vendor or amount..." style="margin-bottom:10px;">
<div id="searchResults"></div>
`;
document.getElementById("searchInput").addEventListener("input",updateSearchResults);
openModal();
setTimeout(() => {
document.getElementById("searchInput").focus();
}, 50);
}

function populateYearFilter(){
  const years = new Set();

  data.forEach(d=>{
    if(!d.Date) return;

    const year = d.Date ? d.Date.toString().slice(0,4) : null;
    if(!isNaN(year)){
      years.add(year.toString());
    }
  });

  const select = document.getElementById("yearFilter");
  select.innerHTML = `<option value="">All Years</option>`;

  const sortedYears = Array.from(years)
    .sort((a,b)=>b-a);

  sortedYears
    .forEach(y=>{
      select.innerHTML += `<option value="${y}">${y}</option>`;
    });

  if (sortedYears.length === 0) {
    activeYearFilter = null;
    select.value = "";
    return;
  }

  const shouldKeepCurrentYear =
    activeYearFilter && sortedYears.includes(activeYearFilter);

  activeYearFilter = shouldKeepCurrentYear ? activeYearFilter : sortedYears[0];
  select.value = activeYearFilter;
}
async function forcePlaidSync(){

  try {

    const { data: { session } } = await supabaseClient.auth.getSession();

    if(!session){
      alert("Not logged in");
      return;
    }

    const res = await fetch(
      "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/sync-plaid-transactions",
      {
        method: "POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({
          user_id: session.user.id
        })
      }
    );

    const result = await res.json();

    if(!res.ok){
      console.error(result);
      alert("Transaction sync failed");
      return;
    }

    await loadTransactions();

    alert("Transactions synced!");

  } catch(err){
    console.error(err);
    alert("Sync error");
  }

}
function applyYearFilter(){
  const val = document.getElementById("yearFilter").value;
  activeYearFilter = val || null;
  activeSearchFilter = null;
document.getElementById("clearSearchBtn").style.display = "none";
  currentIndex = 0;
  updateTotals();
updateProgress();
showCard();
}


function applyDateFilter(){
  const val = document.getElementById("dateFilter").value;
  activeDateFilter = val || null;
  currentIndex = 0;
  document.getElementById("clearDateBtn").style.display = activeDateFilter ? "block" : "none";
  updateTotals();
  updateProgress();
  showCard();
}

function clearDateFilter(){
  activeDateFilter = null;
  const dateInput = document.getElementById("dateFilter");
  if(dateInput) dateInput.value = "";
  document.getElementById("clearDateBtn").style.display = "none";
  currentIndex = 0;
  updateTotals();
  updateProgress();
  showCard();
}

function updateSearchResults(){
const query=document.getElementById("searchInput").value.trim().toLowerCase();
const resultsDiv=document.getElementById("searchResults");
resultsDiv.innerHTML="";
if(!query) return;

const numeric=parseFloat(query);

getVisibleIndexes().forEach(i=>{
  const d = data[i];
let vendorMatch=d.Vendor && d.Vendor.toLowerCase().includes(query);
let amountMatch=!isNaN(numeric) && d.Amount===numeric;

if(vendorMatch || amountMatch){
resultsDiv.innerHTML+=`
<div class="modalItem" onclick="applySearchFilter(${i})">
${d.Vendor || d.Title} ‚Äî $${d.Amount.toFixed(2)}
</div>`;
}
});
}

function applySearchFilter(index){

  const visible = getVisibleIndexes();

  // If the clicked item is NOT inside the current filtered view,
  // do NOT jump to it.
  if(!visible.includes(index)){
    alert("This transaction is outside your current filter.");
    return;
  }

  currentIndex = index;

  closeModal();
  showCard();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function clearSearchFilter(){
activeSearchFilter=null;
document.getElementById("clearSearchBtn").style.display="none";
showCard();
}

/* ================= CREATE TRANSACTION ================= */

function openCreateTransactionModal(){

modalTitle.innerText = "Create Transaction";

modalContent.innerHTML = `
<div style="display:flex; flex-direction:column; gap:12px;">

<label>Vendor</label>
<input type="text" id="newVendor">

<label>Date</label>
<input type="date" id="newDate">

<label>Amount</label>
<input type="number" step="0.01" id="newAmount">

<button class="category-btn expense" onclick="saveNewTransaction()">
Save Transaction
</button>

</div>
`;

openModal();
}

async function saveNewTransaction(){

const vendor = document.getElementById("newVendor").value.trim();
const rawDate = document.getElementById("newDate").value;

let formattedDate = "";
if(rawDate){
const parts = rawDate.split("-");
formattedDate = rawDate; // store as YYYY-MM-DD
}
const amount = parseFloat(document.getElementById("newAmount").value);

if(!vendor || !formattedDate || isNaN(amount)){
alert("Please complete all fields.");
return;
}

const { data: { session } } = await supabaseClient.auth.getSession();
if (!session) {
  alert("You must be logged in.");
  return;
}

const { data: insertedRows, error } = await supabaseClient
  .from("transactions")
  .insert({
    user_id: session.user.id,
    date: formattedDate,
    name: vendor,
    merchant_name: vendor,
    amount,
    category: "",
    splits: []
  })
  .select("id, date, name, merchant_name, amount, category, splits, receipt_url")
  .single();

if (error) {
  console.error("Create transaction error:", error);
  alert("Error saving transaction");
  return;
}

// Add instantly to UI (optimistic update)
data.unshift({
  id: insertedRows.id,
  Title: insertedRows.name || insertedRows.merchant_name || "",
  Vendor: insertedRows.merchant_name || insertedRows.name || "",
  Date: insertedRows.date,
  Amount: insertedRows.amount,
  Category: insertedRows.category || "",
  Splits: insertedRows.splits || [],
  receipt_url: insertedRows.receipt_url || null
});

closeModal();

updateTotals();
updateProgress();
showCard();

// THEN refresh quietly in background
loadTransactions();

// Jump to new transaction
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";

if(showOnlyUncategorized){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}

currentIndex = 0;
showCard();
}

async function deleteTransaction(){

if(!confirm("Are you sure you want to delete this transaction?")) return;

const id = data[currentIndex].id;

if (id) {
  await supabaseClient
    .from("transactions")
    .delete()
    .eq("id", id);
}

data.splice(currentIndex,1);


if(currentIndex >= data.length){
currentIndex = data.length - 1;
}

updateTotals();
updateProgress();

if(data.length === 0){
cardTitle.innerText = "No Transactions";
cardMeta.innerHTML = "";
splitSummary.innerHTML = "";
currentCategory.innerText = "";
return;
}

showCard();
}

  
/* CSV */

document.getElementById("csvFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
complete: async (res) => {

  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) {
    alert("You must be logged in.");
    return;
  }

  const userId = session.user.id;

const rowsToInsert = res.data.map(row => ({
  user_id: userId,
  date: row.date,
  name: row.title,
  merchant_name: row.vendor || row.Vendor || row.VENDOR || "",
  amount: parseFloat(row.amount) || 0,
  category: row.category || "",
  splits: []
}));

  const { error } = await supabaseClient
    .from("transactions")
    .insert(rowsToInsert);

  if (error) {
    console.error(error);
    alert("CSV Import Error");
    return;
  }

  app.style.display = "block";
  await loadTransactions();
}
  });
});




/* Receipt */

async function attachReceipt(e){

const file = e.target.files[0];
if(!file) return;

const item = data[currentIndex];
if(!item.id){
  alert("Transaction must be saved before attaching receipt.");
  return;
}

const fileExt = file.name.split('.').pop();
const filePath = `receipts/${item.id}.${fileExt}`;

const { error: uploadError } = await supabaseClient
  .storage
  .from("receipts")
  .upload(filePath, file, {
    upsert: true
  });

if(uploadError){
  console.error("Upload error:", uploadError);
  alert("Error uploading receipt.");
  return;
}

const { data: publicUrlData } = supabaseClient
  .storage
  .from("receipts")
  .getPublicUrl(filePath);

const publicUrl = publicUrlData.publicUrl;

const { error: updateError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: filePath })
  .eq("id", item.id);

if(updateError){
  console.error("DB update error:", updateError);
  alert("Error saving receipt reference.");
  return;
}

item.receipt_url = filePath;

showCard(); // üî• THIS refreshes the UI

alert("Receipt saved successfully.");
}

async function viewReceipt(){

const item = data[currentIndex];
if(!item.id) return;

if(!item.receipt_url){
  alert("No receipt attached.");
  return;
}

const { data: signedData, error } = await supabaseClient
  .storage
  .from("receipts")
  .createSignedUrl(item.receipt_url, 60);

if(error){
  console.error(error);
  alert("Unable to load receipt.");
  return;
}

modalTitle.innerText = "Receipt Preview";

const url = signedData.signedUrl;
const isPDF = url.toLowerCase().includes(".pdf");

modalContent.innerHTML = `
  <div style="height:100%;display:grid;grid-template-rows:minmax(0,1fr) auto;gap:10px;">
    <div class="receiptViewport" style="max-height:100%;">
      ${isPDF ? `<iframe src="${url}" title="Receipt PDF"></iframe>` : `<img src="${url}" alt="Receipt image">`}
    </div>
    <button class="touchButton" style="background:#111827;color:white;" onclick="openReceiptFullscreen('${url}')">Expand Fullscreen</button>
  </div>
`;

openModal();
}

async function removeReceipt(){

const item = data[currentIndex];
if(!item.id || !item.receipt_url) return;

const { error: storageError } = await supabaseClient
  .storage
  .from("receipts")
  .remove([item.receipt_url]);

if(storageError){
  console.error("Storage delete error:", storageError);
  alert("Error deleting file from storage.");
  return;
}

const { error: dbError } = await supabaseClient
  .from("transactions")
  .update({ receipt_url: null })
  .eq("id", item.id);

if(dbError){
  console.error("DB update error:", dbError);
  alert("Error clearing receipt reference.");
  return;
}

item.receipt_url = null;

showCard();
alert("Receipt removed successfully.");
}

/* Filter */

function toggleFilter(){
  showOnlyUncategorized = !showOnlyUncategorized;

  const btn = document.getElementById("filterToggle");
  if(btn){
    btn.innerText = showOnlyUncategorized
      ? "Show All Transactions"
      : "Show Only Uncategorized";
  }

  updateProgress();
  showCard();
}

function getVisibleIndexes(){

let baseList;

if(!showOnlyUncategorized){
baseList = data.map((_,i)=>i);
}else{
baseList = data.map((d,i)=>!d.Category?i:null).filter(i=>i!==null);
}

let filtered = baseList;

if(activeYearFilter){
  filtered = filtered.filter(i=>{
    const d = data[i];
    if(!d.Date) return false;

    const year = d.Date ? d.Date.toString().slice(0,4) : null;
    return year === activeYearFilter;
  });
}

if(activeDateFilter){
  filtered = filtered.filter(i=>{
    const d = data[i];
    if(!d.Date) return false;
    const normalized = d.Date.toString().slice(0,10);
    return normalized === activeDateFilter;
  });
}

if(!activeSearchFilter) return filtered;

return filtered.filter(i=>{
const d=data[i];

const vendorMatch =
activeSearchFilter.vendor &&
d.Vendor === activeSearchFilter.vendor;

const amountMatch =
activeSearchFilter.amount != null &&
d.Amount === activeSearchFilter.amount;

return vendorMatch || amountMatch;
});
}


/* Navigation */

function goNext(){
  const visible = getVisibleIndexes();

  let pos = visible.indexOf(currentIndex);

  // üî• FIX: if index not found, don't reset to 0
  if(pos === -1){
    // try to move forward based on raw index instead
    const next = visible.find(i => i > currentIndex);

    if(next !== undefined){
      currentIndex = next;
      showCard();
    }
    return;
  }

  if(pos < visible.length - 1){
    currentIndex = visible[pos + 1];
    showCard();
  }
}

function goBack(){
  const visible = getVisibleIndexes();

  let pos = visible.indexOf(currentIndex);

  if(pos === -1){
    const prev = [...visible].reverse().find(i => i < currentIndex);

    if(prev !== undefined){
      currentIndex = prev;
      showCard();
    }
    return;
  }

  if(pos > 0){
    currentIndex = visible[pos - 1];
    showCard();
  }
}

/* Category Buttons */

function renderCategories(){
const div=document.getElementById("categoryButtons");
div.innerHTML="";

div.innerHTML = `
  <div class="categoryPickerCompact">
    <div class="categoryPickerActions">
      <button class="category-btn" style="background:#1e3a8a;" onclick="openCategoryModal()">Choose Category</button>
      <button class="category-btn" style="background:#ff9800;" onclick="openSplitModal()">Split Transaction</button>
    </div>
    <div class="inlineHint">All categories are still available in the chooser, now in a compact list.</div>
    <button id="filterToggle" class="category-btn filterBtn" onclick="toggleFilter()">Show Only Uncategorized</button>
  </div>
`;
}

function generateCategoryButtons(){
  return `
    <div style="padding:10px; display:flex; flex-direction:column; gap:8px;">
      ${categories.map(c => `
        <div class="categoryPickerRow">
          <button class="category-btn ${c.class}"
            style="width:100%; text-align:left; padding:12px; border-radius:12px;"
            onclick="selectCategory('${c.name.replace(/'/g,"\\'")}')">
            ${c.name}
          </button>
          <button onclick="showCategoryInfo('${c.name.replace(/'/g, "\\'")}')" style="
            width:36px;
            height:36px;
            border-radius:50%;
            border:none;
            background:#eee;
            font-weight:bold;
          ">i</button>
        </div>
      `).join("")}
    </div>
  `;
}

function openCategoryModal(){
  aiContext = null;
  modalTitle.innerText = "Choose Category";
  modalContent.innerHTML = generateCategoryButtons();
  openModal(100000);
}


function showCategoryInfo(name){

  const category = categories.find(c => c.name === name);
  if(!category) return;

  const modal = document.createElement("div");

  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.5)";
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";
  modal.style.zIndex = "100000"; // üëà above picker

  modal.innerHTML = `
    <div style="
      background:white;
      width:90%;
      max-width:500px;
      max-height:80vh;
      border-radius:16px;
      padding:16px;
      overflow:auto;
      box-sizing:border-box;
    ">
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">${category.name}</h3>
        <button onclick="closeCategoryInfo()" style="
          background:#c62828;
          color:white;
          border:none;
          padding:6px 10px;
          border-radius:8px;
        ">‚úï</button>
      </div>

      <div style="font-size:14px; line-height:1.5;">
        ${category.description || "No description available."}
      </div>

    </div>
  `;

  document.body.appendChild(modal);

  window.closeCategoryInfo = () => {
    document.body.removeChild(modal);
  };

}
  
async function categorize(name){

  const item = data[currentIndex];

  item.Category = name;
  item.Splits = [];

  updateTotals();
  updateProgress();

  if(item.id){
    const { error } = await Api.updateTransaction(item.id, {
      category: name,
      splits: []
    });

    if(error){
      console.error("Category save error:", error);
      alert("Error saving category to database.");
      return;
    }
  }

  // üî• slight delay prevents UI race condition
  setTimeout(() => {
    goNext();
  }, 0);
}

const SplitState = {
  manualAmount: 0,
  manualCategory: null,
  highlightedIndex: null,
  receiptExpanded: false,
  keypad: {
    value: "",
    max: Infinity,
    onChange: null,
    onConfirm: null,
    onCancel: null
  }
};

function calculateSplitStats(item){
  const allocated = (item.Splits || []).reduce((sum, s) => sum + Math.round(parseFloat(s.Amount || 0) * 100), 0) / 100;
  const remaining = parseFloat((item.Amount - allocated).toFixed(2));
  return { allocated, remaining };
}

function renderSplitTotals(item){
  const { allocated, remaining } = calculateSplitStats(item);
  const remainingClass = Math.abs(remaining) < 0.01 ? "done zeroFlash" : remaining <= item.Amount * 0.2 ? "nearDone" : "";
  return `
    <div id="remainingBar" class="splitTotalsCard">
      <div class="splitMetric">Total<strong>$${item.Amount.toFixed(2)}</strong></div>
      <div class="splitMetric">Allocated<strong>$${allocated.toFixed(2)}</strong></div>
      <div class="splitMetric remaining ${remainingClass}">Remaining<strong>$${remaining.toFixed(2)}</strong></div>
    </div>
  `;
}

function renderSplitItems(item){
  if(!(item.Splits || []).length){
    return `<div class="small">No line items assigned yet. Add your first split below.</div>`;
  }

  return item.Splits.map((s, i) => {
    const canEdit = !item.receipt_url;
    return `
      <div class="splitItemRow ${SplitState.highlightedIndex === i ? "justAdded" : ""}">
        <div class="splitItemMeta">
          <strong>${s.Category || "Uncategorized"}</strong>
          <div class="small">$${parseFloat(s.Amount || 0).toFixed(2)}</div>
        </div>
        <div class="splitItemActions">
          ${canEdit ? `<button class="touchButton" style="background:#1e3a8a;color:#fff;" onclick="editSplitAmount(${i})">Edit Amount</button>` : ""}
          <button class="touchButton" style="background:#c62828;color:#fff;" onclick="removeSplitAtIndex(${i})">Remove</button>
        </div>
      </div>
    `;
  }).join("");
}

function setModalCloseButtonVisibility(show){
  if(!modalCloseBtn) return;
  modalCloseBtn.style.display = show ? "block" : "none";
}

async function openSplitModal(){
  splitMode = false;
  SplitState.receiptExpanded = false;
  const item = data[currentIndex];
  if(!item) return;

  modalTitle.innerText = "Split Transaction";
  setModalCloseButtonVisibility(false);

  modalContent.innerHTML = `
    <div id="splitModalSheet" class="splitModalLayout">
      <div class="splitHeaderRow">
        <h3 class="splitHeaderTitle">Split Transaction</h3>
        <button class="splitHeaderExit" onclick="closeModal()" aria-label="Close split transaction">‚úï</button>
      </div>
      <div class="splitBody">
        <div class="receiptCard">
          <div class="receiptControls">
            <button class="touchButton" onclick="openManualSplitModal()" style="background:#1e3a8a;color:#fff;flex:1;">Add Split</button>
            ${item.receipt_url ? `<button class="touchButton" onclick="viewReceipt()" style="background:#1565c0;color:#fff;flex:1;">View Receipt</button>` : ""}
            ${item.receipt_url ? `<button type="button" class="touchButton" onclick="toggleReceiptViewport()" style="background:#37474f;color:#fff;flex:1;">Expand Receipt</button>` : ""}
          </div>
          ${item.receipt_url ? `<button id="analyzeBtn" class="touchButton" onclick="analyzeReceipt(data[currentIndex])" style="background:#000;color:#fff;width:100%;margin-bottom:10px;">ü§ñ Analyze Receipt</button>` : `<div class="small" style="margin-bottom:8px;">No receipt attached. Use keypad-first split entry for fast mobile input.</div>`}
          <div id="splitReceiptPreview" class="receiptViewport"></div>
        </div>
        <div id="splitItemsScroller" class="lineItemsScroller">${renderSplitItems(item)}</div>
      </div>
      <div id="splitFooterSticky" class="splitFooterSticky">
        <div id="splitCompletionText" class="small">Assign all line items to complete this transaction.</div>
        <button id="splitDoneBtn" class="touchButton" style="background:#2e7d32;color:#fff;" onclick="completeSplitWorkflow()">Done</button>
      </div>
      ${renderSplitTotals(item)}
    </div>
  `;

  hydrateReceiptPreview(item);
  updateSplitProgressState();
  openModal();
}

function openManualSplitModal(){
  SplitState.manualAmount = 0;
  SplitState.manualCategory = null;
  const item = data[currentIndex];
  if(!item) return;

  modalTitle.innerText = "Manual Split";
  setModalCloseButtonVisibility(false);
  modalContent.innerHTML = `
    <div class="splitModalLayout" style="padding:6px;">
      <div class="splitHeaderRow">
        <h3 class="splitHeaderTitle">Manual Split</h3>
        <button class="splitHeaderExit" onclick="openSplitModal()" aria-label="Back to split">‚Üê</button>
      </div>
      <div class="lineItemsScroller" style="display:grid;gap:10px;">
        <label class="small" for="manualSplitAmount">Split Amount</label>
        <input id="manualSplitAmount" type="text" inputmode="decimal" readonly placeholder="0.00" onclick="openManualAmountKeypad()">
        <button class="touchButton" onclick="openManualAmountKeypad()" style="background:#1565c0;color:white;">Enter Amount</button>
        <button class="touchButton" onclick="openManualSplitCategorySelector()" style="background:#1e3a8a;color:white;">Choose Category</button>
        <div id="manualSplitCategory" class="small">No category selected.</div>
      </div>
      <div class="splitFooterSticky">
        <button class="touchButton" onclick="openSplitModal()" style="background:#6b7280;color:#fff;">‚Üê Back</button>
        <button class="touchButton" onclick="submitManualSplit()" style="background:#2e7d32;color:#fff;">Add Split</button>
      </div>
      ${renderSplitTotals(item)}
    </div>
  `;
}

function openManualAmountKeypad(){
  const item = data[currentIndex];
  if(!item) return;
  const { remaining } = calculateSplitStats(item);
  openNumericKeypad({
    title: "Enter split amount",
    initial: SplitState.manualAmount || remaining,
    max: Math.max(remaining, 0),
    onChange: (value) => {
      SplitState.manualAmount = value;
      const field = document.getElementById("manualSplitAmount");
      if(field) field.value = value ? value.toFixed(2) : "";
    },
    onConfirm: (value) => {
      SplitState.manualAmount = value;
      const field = document.getElementById("manualSplitAmount");
      if(field) field.value = value.toFixed(2);
    }
  });
}

function captureManualAmount(){
  SplitState.manualAmount = parseFloat(document.getElementById("manualSplitAmount")?.value || 0);
}

function openManualSplitCategorySelector(){
  captureManualAmount();
  if(!SplitState.manualAmount || SplitState.manualAmount <= 0){
    alert("Enter a valid split amount first.");
    return;
  }

  pickCategory(SplitState.manualAmount).then(category => {
    if(!category) return;
    SplitState.manualCategory = category;
    const label = document.getElementById("manualSplitCategory");
    if(label) label.innerText = `Selected: ${category}`;
  });
}

async function submitManualSplit(){
  captureManualAmount();

  if(!SplitState.manualCategory){
    alert("Please choose a category.");
    return;
  }

  if(!SplitState.manualAmount || SplitState.manualAmount <= 0){
    alert("Enter a valid split amount.");
    return;
  }

  const success = await applySplit(SplitState.manualCategory, SplitState.manualAmount);
  if(success){
    openSplitModal();
    showCard();
  }
}

function removeSplitAtIndex(index){
  const item = data[currentIndex];
  if(!item || !item.Splits || !item.Splits[index]) return;
  item.Splits.splice(index, 1);
  if(!item.Splits.length) item.Category = "";
  persistSplitItem(item);
}

function editSplitAmount(index){
  const item = data[currentIndex];
  if(!item?.Splits?.[index]) return;
  const original = parseFloat(item.Splits[index].Amount || 0);
  const { remaining } = calculateSplitStats(item);
  const editableMax = Math.max(original + remaining, 0);

  openNumericKeypad({
    title: `Edit ${item.Splits[index].Category || "line item"}`,
    initial: original,
    max: editableMax,
    onChange: (value) => {
      item.Splits[index].Amount = parseFloat((value || 0).toFixed(2));
      updateRemainingUI();
    },
    onCancel: () => {
      item.Splits[index].Amount = original;
      updateRemainingUI();
    },
    onConfirm: () => persistSplitItem(item)
  });
}

function toggleReceiptViewport(){
  const node = document.getElementById("splitReceiptPreview");
  if(!node) return;
  SplitState.receiptExpanded = !SplitState.receiptExpanded;
  node.classList.toggle("expanded", SplitState.receiptExpanded);
}

function hydrateReceiptPreview(item){
  const receiptHost = document.getElementById("splitReceiptPreview");
  if(!receiptHost) return;
  if(!item.receipt_url){
    receiptHost.innerHTML = `<div class="small" style="padding:12px; color:#d1d5db;">No receipt attached.</div>`;
    return;
  }

  supabaseClient.storage.from("receipts").createSignedUrl(item.receipt_url, 60).then(({ data: signedData }) => {
    if(!signedData?.signedUrl) return;
    const url = signedData.signedUrl;
    const isPDF = url.toLowerCase().includes(".pdf");
    receiptHost.innerHTML = isPDF
      ? `<iframe src="${url}" title="Receipt PDF"></iframe>`
      : `<img src="${url}" alt="Receipt image" onclick="openReceiptFullscreen('${url}')">`;
  });
}

function openReceiptFullscreen(url){
  modalTitle.innerText = "Receipt Viewer";
  modalContent.innerHTML = `<div class="receiptViewport" style="max-height:100%;height:100%;"><img src="${url}" alt="Receipt expanded"></div>`;
  openModal();
}

function updateSplitProgressState(){
  const item = data[currentIndex];
  if(!item) return;
  const { remaining } = calculateSplitStats(item);
  const done = Math.abs(remaining) < 0.01;
  const txt = document.getElementById("splitCompletionText");
  const btn = document.getElementById("splitDoneBtn");
  const remainingNode = document.querySelector(".splitMetric.remaining");
  const footer = document.getElementById("splitFooterSticky");

  if(txt) txt.innerText = done ? "‚úÖ Split complete ‚Äî ready to finish." : `Remaining to assign: $${remaining.toFixed(2)}`;
  if(btn) {
    btn.disabled = !done;
    btn.style.opacity = done ? "1" : ".65";
  }
  if(footer) footer.style.borderColor = done ? "#2e7d32" : "var(--border)";
  if(remainingNode){
    remainingNode.classList.toggle("done", done);
    remainingNode.classList.toggle("nearDone", !done && remaining <= item.Amount * 0.2);
    remainingNode.classList.toggle("zeroFlash", done);
  }
}

function completeSplitWorkflow(){
  const item = data[currentIndex];
  if(!item) return;
  const { remaining } = calculateSplitStats(item);
  if(Math.abs(remaining) >= 0.01){
    alert("Allocate remaining balance before finishing.");
    return;
  }
  const footer = document.querySelector(".splitFooterSticky");
  if(footer) footer.style.animation = "splitPulse .45s ease";
  setTimeout(() => {
    closeModal();
    showCard();
  }, 220);
}

function initTapToSplit(){

  const container = document.getElementById("tapSplitContainer");
if(!container || container.dataset.listenerAttached) return;

container.dataset.listenerAttached = "true";

  let touchStartX = 0;
  let touchStartY = 0;

  container.addEventListener("touchstart", (e)=>{
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  });

  container.addEventListener("touchend", (e)=>{
if(!splitMode) return;
  const dx = Math.abs(e.changedTouches[0].clientX - touchStartX);
  const dy = Math.abs(e.changedTouches[0].clientY - touchStartY);

  // If finger moved ‚Üí it's a scroll
  if(dx > 10 || dy > 10) return;

  // Slight delay = better UX
  setTimeout(async () => {

    const item = data[currentIndex];

let total = 0;
item.Splits.forEach(s => total += parseFloat(s.Amount));
total = parseFloat(total.toFixed(2));

const remaining = parseFloat((item.Amount - total).toFixed(2));
// üö® FIX BAD DATA STATE
if(remaining <= 0){
  alert("No more money to split.");
  return;
}
const tapX = e.changedTouches[0].clientX;
const tapY = e.changedTouches[0].clientY;

const amount = await showAmountInput(tapX, tapY, remaining);
if(amount === null) return;

const parsed = parseFloat(amount);
    if(isNaN(parsed)){
      alert("Invalid amount");
      return;
    }

    const category = await pickCategory(parsed);
    if(!category) return;

    applySplit(category, parsed);

  }, 50);

});
}

function enableSplitMode(){
  splitMode = !splitMode;

  const btn = document.querySelector("#tapSplitContainer button[onclick='enableSplitMode()']");
  const container = document.getElementById("tapSplitContainer");

  if(splitMode){
    btn.innerText = "Exit Split Mode";
    btn.style.background = "#2e7d32";
    if(container) container.style.outline = "3px solid #2e7d32";
  } else {
    btn.innerText = "Enable Split Mode";
    btn.style.background = "#ff9800";
    if(container) container.style.outline = "none";
  }
}

async function resetSplits(){

  if(!confirm("Reset all splits?")) return;

  const item = data[currentIndex];

  item.Splits = [];
  item.Category = "";

  updateRemainingUI();

// Force UI refresh if modal is open
setTimeout(() => {
  updateRemainingUI();
}, 50);
  updateTotals();
  updateProgress();
showCard();
  // Save to Supabase
  if(item.id){
    const { error } = await supabaseClient
      .from("transactions")
      .update({
        category: "",
        splits: []
      })
      .eq("id", item.id);

    if(error){
      console.error("Reset error:", error);
      alert("Error resetting splits.");
    }
  }

  // Reset remaining bar UI
  const el = document.getElementById("remainingBar");
  if(el){
    el.innerText = "Remaining: $" + item.Amount.toFixed(2);
    el.style.color = "orange";
  }
}

function chooseCategoryForReceipt(index){

  aiContext = { type: "receipt", index };

  modalTitle.innerText = "Choose Category";
  modalContent.innerHTML = generateCategoryButtons();

  openModal(1000000);
}

function initKeypad(){
  if(!keypadGrid || keypadGrid.dataset.ready) return;
  keypadGrid.dataset.ready = "true";
  const keys = ["1","2","3","4","5","6","7","8","9",".","0","‚å´"];
  keypadGrid.innerHTML = `${keys.map((k) => `<button class="keypadKey" type="button" onclick="pressKeypadKey('${k}')">${k}</button>`).join("")}
    <button class="keypadKey warn" type="button" onclick="cancelNumericKeypad()">Cancel</button>
    <button class="keypadKey" type="button" onclick="clearNumericKeypad()">Clear</button>
    <button class="keypadKey action" type="button" onclick="confirmNumericKeypad()">Done</button>`;
}

function openNumericKeypad({ title = "Enter amount", initial = 0, max = Infinity, onChange, onConfirm, onCancel } = {}){
  initKeypad();
  SplitState.keypad.value = initial > 0 ? Number(initial).toFixed(2) : "";
  SplitState.keypad.max = max;
  SplitState.keypad.onChange = onChange || null;
  SplitState.keypad.onConfirm = onConfirm || null;
  SplitState.keypad.onCancel = onCancel || null;
  if(keypadTitle) keypadTitle.innerText = title;
  if(keypadOverlay) keypadOverlay.classList.add("open");
  updateKeypadDisplay();
}

function closeNumericKeypad(silent = false){
  if(!silent && typeof SplitState.keypad.onCancel === "function") SplitState.keypad.onCancel();
  if(keypadOverlay) keypadOverlay.classList.remove("open");
  SplitState.keypad.onChange = null;
  SplitState.keypad.onConfirm = null;
  SplitState.keypad.onCancel = null;
  if(keypadHint) keypadHint.innerText = "";
}

function handleKeypadBackdrop(event){
  if(event.target === keypadOverlay) cancelNumericKeypad();
}

function pressKeypadKey(key){
  let val = SplitState.keypad.value || "";
  if(key === "‚å´"){
    val = val.slice(0, -1);
  } else if(key === "."){
    if(!val.includes(".")) val = val ? `${val}.` : "0.";
  } else {
    val = `${val}${key}`;
  }
  SplitState.keypad.value = val;
  updateKeypadDisplay();
}

function clearNumericKeypad(){
  SplitState.keypad.value = "";
  updateKeypadDisplay();
}

function keypadNumericValue(){
  const parsed = parseFloat(SplitState.keypad.value || 0);
  return Number.isFinite(parsed) ? parseFloat(parsed.toFixed(2)) : 0;
}

function updateKeypadDisplay(){
  const value = keypadNumericValue();
  if(keypadDisplay) keypadDisplay.innerText = `$${value.toFixed(2)}`;
  const over = value > SplitState.keypad.max + 0.009;
  if(keypadHint) keypadHint.innerText = over ? `Amount exceeds remaining ($${SplitState.keypad.max.toFixed(2)} max).` : "";
  if(typeof SplitState.keypad.onChange === "function"){
    SplitState.keypad.onChange(Math.min(value, SplitState.keypad.max));
  }
}

function confirmNumericKeypad(){
  const value = keypadNumericValue();
  if(value <= 0){
    if(keypadHint) keypadHint.innerText = "Enter an amount greater than $0.00.";
    return;
  }
  if(value > SplitState.keypad.max + 0.009){
    if(keypadHint) keypadHint.innerText = `Amount exceeds remaining ($${SplitState.keypad.max.toFixed(2)} max).`;
    return;
  }
  if(typeof SplitState.keypad.onConfirm === "function") SplitState.keypad.onConfirm(value);
  closeNumericKeypad(true);
}

function cancelNumericKeypad(){
  closeNumericKeypad(false);
}

function showAmountInput(x, y, remaining){
  return new Promise(resolve => {
    openNumericKeypad({
      title: "Split amount",
      initial: remaining,
      max: remaining,
      onConfirm: (value) => resolve(value),
      onCancel: () => resolve(null)
    });
  });
}

let receiptSuggestions = [];
let currentSuggestionIndex = 0;
async function analyzeReceipt(item){

  const btn = document.getElementById("analyzeBtn");

  // üö´ Prevent double click
  if(btn && btn.dataset.loading === "true"){
    console.log("Blocked duplicate analyze");
    return;
  }

  // üîí Lock button
  if(btn){
    btn.dataset.loading = "true";
    btn.disabled = true;
    btn.innerText = "‚è≥ Analyzing...";
    btn.style.opacity = "0.6";
  }

  try {

    openModal();

    modalContent.innerHTML = `
      <div style="padding:40px; text-align:center;">
        <div style="font-size:18px;">ü§ñ Analyzing Receipt...</div>
        <div style="margin-top:10px; font-size:14px; opacity:.6;">
          Extracting clean line items...
        </div>
      </div>
    `;

    // ‚úÖ SESSION (correct client)
    const { data: { session } } = await supabaseClient.auth.getSession();

    if(!session){
      throw new Error("No session found");
    }

    const payload = {
      filePath: item.receipt_url,
      categories: categories.map(c => c.name)
    };

    console.log("üì§ Sending to edge:", payload);

    const res = await fetch(
      "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/analyze-receipt",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify(payload)
      }
    );

    // üî• CRITICAL FIX ‚Äî read as text first
    const rawText = await res.text();
    console.log("üì• RAW EDGE RESPONSE:", rawText);

    let result;

    try {
      result = JSON.parse(rawText);
    } catch (parseErr) {
      console.error("‚ùå JSON PARSE FAILED:", rawText);
      throw new Error("Edge function returned invalid JSON");
    }

    if(!res.ok){
      throw new Error(result.error || "Analyze failed");
    }

    console.log("‚úÖ Parsed result:", result);

    // ‚úÖ Normalize expected structure
    const lineItems = result.line_items || result.items || [];
    const taxAmount = result.tax_amount ?? result.tax ?? 0;

    // üö´ Prevent empty results
    if(lineItems.length === 0){
      throw new Error("No valid line items detected");
    }

    // ‚úÖ Store result
    item.receipt_analysis = {
      items: lineItems,
      tax_amount: taxAmount
    };

    // ‚úÖ Apply tax
    await ensureSalesTaxApplied(taxAmount);

    // ‚úÖ Render UI
    renderReceiptSuggestions(item, lineItems);

  } catch (err) {
    console.error("‚ùå Analyze error:", err);

    modalContent.innerHTML = `
      <div style="padding:40px; text-align:center; color:red;">
        ‚ùå ${err.message}
      </div>
    `;

  } finally {

    // üîì Always unlock button
    if(btn){
      btn.dataset.loading = "false";
      btn.disabled = false;
      btn.innerText = "ü§ñ Analyze Receipt";
      btn.style.opacity = "1";
    }

  }
}

  function resetButton(){
  const btn = document.getElementById("analyzeBtn");
  if(btn){
    btn.dataset.loading = "false";
    btn.disabled = false;
    btn.innerText = "ü§ñ Analyze Receipt";
  }
}

  function extractProductCode(line){
    const match = line.match(/\b\d{5,15}\b/);
    if(!match) return null;

    const raw = match[0];
    const normalized = raw.replace(/^0+/, "") || raw;

    return { raw, normalized };
  }

  

 async function acceptSuggestion(itemId, index){

  const item = data.find(d => d.id === itemId);
  if(!item) return;

  const suggestion = item.receipt_analysis.items[index];

  if(!item.Splits) item.Splits = [];

  // üö´ prevent duplicate clicks
  const exists = item.Splits.find(s => s.item_index === index);
  if(exists) return;

  // =============================
  // ‚úÖ APPLY SPLIT
  // =============================
  item.Splits.push({
    item_index: index,
    Category: suggestion.suggested_category || "Needs Review",
    Amount: parseFloat(suggestion.amount || 0)
  });

  suggestion._accepted = true;

  // =============================
  // üß† SAVE TO MEMORY (NEW)
  // =============================
  try {

    // Extract product code if available
    const codeMatch = suggestion.raw_description?.match(/\b\d{5,15}\b/);

    if(codeMatch){

      const rawCode = codeMatch[0];
      const normalizedCode = rawCode.replace(/^0+/, "") || rawCode;

      const productName =
        suggestion.normalized_description ||
        suggestion.raw_description;

      await supabaseClient
        .from("product_match_memory")
        .upsert({
          product_code: normalizedCode,
          product_name: productName
        }, {
          onConflict: "product_code"
        });

      console.log("‚úÖ Learned product:", normalizedCode, productName);
    }

  } catch(e){
    console.warn("Memory save failed:", e);
  }

  // =============================
  // üîÑ UI UPDATES
  // =============================
  updateRemainingUI();
  updateSplitSummaryUI();
  updateTotals();

  renderReceiptSuggestions(item, item.receipt_analysis.items);
}


function calculateReceiptRemaining(){

  const item = data[currentIndex];

  let total = 0;

  // ‚úÖ ONLY count actual splits
  item.Splits.forEach(s => {
    total += Math.round(parseFloat(s.Amount) * 100);
  });

  total = total / 100;

  return parseFloat((item.Amount - total).toFixed(2));
}

async function ensureSalesTaxApplied(taxAmount){

  const item = data[currentIndex];
  if(!item || !taxAmount) return;

  const tax = parseFloat(taxAmount);
  if(isNaN(tax) || tax <= 0) return;

  // Prevent duplicate
  const already = (item.Splits || []).some(
    s => s.Category === "Sales Tax Paid"
  );

  if(already) return;

  // Apply tax as split
  await applySplit("Sales Tax Paid", tax);

  // Mark tax line as accepted (SAFE FIX)
  (item.receipt_analysis?.items || []).forEach(s=>{
    if(
      s.normalized_description?.toLowerCase().includes("tax") ||
      s.raw_description?.toLowerCase().includes("tax")
    ){
      s._accepted = true;
      s._locked = true;
    }
  });
}

function moveToNextSuggestion(){

  currentSuggestionIndex++;

  if(currentSuggestionIndex >= receiptSuggestions.length){
    alert("All receipt items processed.");
    closeReceiptSuggestions();
    return;
  }

  highlightCurrentSuggestion();
}

function renderReceiptSuggestions(item, suggestions){

  receiptSuggestions = suggestions;

  const total = parseFloat(item.Amount || 0);

  let allocated = 0;
  (item.Splits || []).forEach(s=>{
    allocated += parseFloat(s.Amount || 0);
  });

  allocated = parseFloat(allocated.toFixed(2));
  const remaining = parseFloat((total - allocated).toFixed(2));

  modalTitle.innerText = "Review Receipt";
  setModalCloseButtonVisibility(false);

  modalContent.innerHTML = `
    <div class="splitModalLayout" style="padding-top:4px;">
      <div class="splitHeaderRow">
        <h3 class="splitHeaderTitle">Review Receipt</h3>
        <button class="splitHeaderExit" onclick="openSplitModal()" aria-label="Close receipt review">‚úï</button>
      </div>
      <div class="splitBody">
        <div class="receiptCard">
          <div class="receiptViewport expanded" style="max-height:280px;">
            ${item.receipt_url ? `<img id="receiptImage" style="width:100%; height:auto; object-fit:contain;">` : `<div style="color:white; display:flex; align-items:center; justify-content:center; height:100%;">No Receipt</div>`}
          </div>
        </div>
        <div class="lineItemsScroller">
          ${suggestions.map((s, i)=>{
            const existing = (item.Splits || []).find(sp => sp.item_index === i);
            const isAccepted = !!existing;
            const category = existing ? existing.Category : s.suggested_category;
            const amount = parseFloat(s.amount || 0);
            return `
              <div id="suggestion_${i}" class="splitItemRow" style="border:${isAccepted ? "2px solid #2e7d32" : "1px solid #dce3ef"}; opacity:${isAccepted ? "0.7" : "1"};">
                <div><strong>${s.normalized_description || s.raw_description}</strong></div>
                <div class="splitItemMeta">
                  <span>$${amount.toFixed(2)}</span>
                  <strong>${category || "Needs Review"}</strong>
                </div>
                <div class="splitItemActions">
                  ${!isAccepted ? `<button class="touchButton" onclick="acceptSuggestion('${item.id}', ${i})" style="background:#2e7d32; color:white;">Accept</button>` : ``}
                  <button class="touchButton" onclick="changeCategory('${item.id}', ${i})" style="background:#1565c0; color:white;">Change</button>
                  <button class="touchButton" onclick="askAIForReceiptItem(${i})" style="background:#000; color:white;">Ask AI</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
      <div id="remainingBar" class="splitTotalsCard">
        <div class="splitMetric">Total<strong>$${total.toFixed(2)}</strong></div>
        <div class="splitMetric">Allocated<strong>$${allocated.toFixed(2)}</strong></div>
        <div class="splitMetric remaining ${Math.abs(remaining) < 0.01 ? "done" : remaining < 0 ? "nearDone" : ""}">Remaining<strong>$${remaining.toFixed(2)}</strong></div>
      </div>
    </div>
  `;

  // load image
  if(item.receipt_url){
    supabaseClient
      .storage
      .from("receipts")
      .createSignedUrl(item.receipt_url, 60)
      .then(({ data })=>{
        if(data?.signedUrl){
          const img = document.getElementById("receiptImage");
          if(img) img.src = data.signedUrl;
        }
      });
  }
}

function highlightCurrentSuggestion(){

  receiptSuggestions.forEach((_, i)=>{
    const el = document.getElementById(`suggestion_${i}`);
    if(!el) return;

    el.style.background =
      i === currentSuggestionIndex
        ? "#f5f5f5"
        : "white";
  });

  const activeEl = document.getElementById(
    `suggestion_${currentSuggestionIndex}`
  );

  if(activeEl){
    activeEl.scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
  }
}

function closeReceiptSuggestions(){
  // üî• DO NOTHING ‚Äî preserve state
  return;
}

function openReceiptCategorySelector(index){

  aiContext = { type: "receipt", index };

  modalTitle.innerText = "Choose Category";
  modalContent.innerHTML = generateCategoryButtons();

  openModal(100000);
}

function askAIForReceiptItem(index){

  aiContext = { type: "receipt", index };

  // Clear modal
  modalTitle.innerText = "ü§ñ AI Categorization";
  modalContent.innerHTML = `
    <div style="padding:10px;">
      <div style="margin-bottom:10px;">
        <strong>How will this item be used?</strong>
      </div>

      <textarea id="aiUserInput" style="
        width:100%;
        height:120px;
        padding:12px;
        border-radius:12px;
        border:1px solid #ddd;
        margin-bottom:12px;
        font-size:16px;
      "></textarea>

      <button onclick="submitReceiptAI()" style="
        background:#000;
        color:white;
        padding:14px;
        border-radius:12px;
        width:100%;
        font-size:16px;
      ">
        Ask AI
      </button>
    </div>
  `;

  openModal(1000000);
}

async function submitReceiptAI(){

  const input = document.getElementById("aiUserInput").value.trim();
  if(!input) return alert("Please describe how this item will be used.");

  modalContent.innerHTML = `
    <div style="padding:40px;text-align:center;">
      ü§ñ Thinking...
    </div>
  `;

  try {

    const response = await fetch(
      "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/ask-ai",
      {
        method: "POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({
          userInput: input,
          categories: categories.map(c => c.name)
        })
      }
    );

    const result = await response.json();
    if(!response.ok) throw new Error(result.error);

    modalContent.innerHTML = `
      <div style="padding:10px;">

        <div style="font-size:16px; margin-bottom:10px;">
          <strong>Suggested Category:</strong><br>
          <span style="color:#2e7d32; font-size:18px;">
            ${result.category}
          </span>
        </div>

        <div style="margin-bottom:15px;">
          <strong>Reasoning:</strong><br>
          ${result.reasoning}<br><br>
          Confidence: <strong>${result.confidence}</strong>
        </div>

        <button onclick="applyAISuggestion('${result.category.replace(/'/g,"\\'")}')" style="
          background:#2e7d32;
          color:white;
          padding:12px;
          border-radius:10px;
          width:100%;
          margin-bottom:8px;
        ">
          ‚úÖ Accept Suggestion
        </button>

        <button onclick="askAIForReceiptItem(${aiContext.index})" style="
          background:#ccc;
          padding:12px;
          border-radius:10px;
          width:100%;
        ">
          Try Again
        </button>

      </div>
    `;

  } catch(err){
    alert("AI failed.");
    closeModal();
  }
}

function updateRemainingUI(){

  const item = data[currentIndex];
  if(!item) return;

  requestAnimationFrame(() => {
    const el = document.getElementById("remainingBar");
    if(!el) return;
    el.outerHTML = renderSplitTotals(item);
    updateSplitProgressState();
  });
}

function buildSplitSummaryHTML(item){

  if(!item.Splits || !item.Splits.length){
    return `
      <h4>Line Items</h4>
      <div class="small">No split line items yet.</div>
    `;
  }

  const bucketTotals = {};

  item.Splits.forEach(s => {
    const category = s.Category || "Uncategorized";
    const cents = Math.round(parseFloat(s.Amount || 0) * 100);
    bucketTotals[category] = (bucketTotals[category] || 0) + cents;
  });

  let html = `<h4>Line Items</h4>`;

  Object.keys(bucketTotals).forEach(category => {
    html += `
      <div class="totalRow" style="cursor:default; border-bottom:1px solid var(--border);">
        <div>${category}</div>
        <div>$${(bucketTotals[category] / 100).toFixed(2)}</div>
      </div>
    `;
  });

  return html;
}

function updateSplitSummaryUI(){

  const item = data[currentIndex];
  const el = document.getElementById("splitSummary");

  if(!el || !item) return;

  el.innerHTML = buildSplitSummaryHTML(item);
}

async function persistSplitItem(item){
  updateRemainingUI();
  updateSplitSummaryUI();
  updateTotals();
  updateProgress();

  if(document.getElementById("splitItemsScroller")){
    document.getElementById("splitItemsScroller").innerHTML = renderSplitItems(item);
  }
  if(document.getElementById("remainingBar")){
    document.getElementById("remainingBar").outerHTML = renderSplitTotals(item);
  }
  updateSplitProgressState();

  if(item.id){
    const { error } = await Api.updateTransaction(item.id, { category: item.Splits?.length ? "SPLIT" : "", splits: item.Splits || [] });

    if(error){
      console.error("Split save error:", error);
      alert("Error saving split.");
    }
  }
}

async function applySplit(category, amount){
  const item = data[currentIndex];
  if (!item.Splits) item.Splits = [];

  let total = item.Splits.reduce((sum, s) => sum + Math.round(parseFloat(s.Amount) * 100), 0) / 100;
  const remaining = parseFloat((item.Amount - total).toFixed(2));

  if(amount > remaining + 0.01){
    alert("Amount exceeds remaining balance.");
    return false;
  }

  if(Math.abs(amount - remaining) < 0.01) amount = remaining;
  if(amount <= 0){
    alert("Enter a valid amount.");
    return false;
  }

  item.Splits.push({ Category: category, Amount: amount });
  item.Category = "SPLIT";
  SplitState.highlightedIndex = item.Splits.length - 1;

  await persistSplitItem(item);
  setTimeout(() => { SplitState.highlightedIndex = null; }, 420);

  return true;
}

function pickCategory(amount){

  return new Promise(resolve => {

    const overlay = document.createElement("div");

    overlay.style.position = "fixed";
    overlay.style.borderTop = "1px solid #eee";
overlay.style.backdropFilter = "blur(6px)";
    overlay.style.bottom = "0";
    overlay.style.left = "0";
    overlay.style.width = "100%";
    overlay.style.maxHeight = "50vh"; // üëà less aggressive
overlay.style.padding = "12px 12px 20px 12px"; // üëà bottom breathing room
overlay.style.boxSizing = "border-box";
overlay.style.paddingBottom = "env(safe-area-inset-bottom, 20px)";
    overlay.style.background = "white";
    overlay.style.borderTopLeftRadius = "16px";
    overlay.style.borderTopRightRadius = "16px";
    overlay.style.boxShadow = "0 -4px 20px rgba(0,0,0,.2)";
    
    overlay.style.overflowY = "auto";
  overlay.style.zIndex = "400000"; // üëà ALWAYS on top

    let html = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">Select Category</h3>
        <button onclick="closeCategoryPicker()" style="
          background:#c62828;
          color:white;
          border:none;
          padding:6px 10px;
          border-radius:8px;
        ">‚Üê Back</button>
      </div>

      <div style="margin-bottom:10px; font-size:14px;">
        <strong>Amount:</strong> $${amount.toFixed(2)}
      </div>
    `;

    categories.forEach(c=>{
      html += `
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
  
  <button class="category-btn ${c.class}" 
    style="flex:1; min-width:0;"
    onclick="selectCategory('${c.name}')">
    ${c.name}
  </button>

  <button onclick="showCategoryInfo('${c.name.replace(/'/g, "\\'")}')" style="
    flex-shrink:0;
    width:36px;
    height:36px;
    border-radius:50%;
    border:none;
    background:#eee;
    font-weight:bold;
  ">i</button>

</div>
      `;
    });

    overlay.innerHTML = html;
    document.body.appendChild(overlay);

    window.selectCategory = (name)=>{
      document.body.removeChild(overlay);
      resolve(name);
    };

    window.closeCategoryPicker = ()=>{
      document.body.removeChild(overlay);
      resolve(null); // ‚Üê THIS IS THE FIX (escape hatch)
    };

  });

}

function updateRemaining(){
const item=data[currentIndex];
let total=0;
categories.forEach((c,i)=>{
total+=parseFloat(document.getElementById("split_"+i).value)||0;
});
const remaining=item.Amount-total;
const el=document.getElementById("remainingBalance");
el.innerText="Remaining: $"+remaining.toFixed(2);
el.style.color=Math.abs(remaining)<0.01?"green":remaining<0?"red":"orange";
}

async function saveSplit(){

const item = data[currentIndex];

let total = 0;
let splits = [];

categories.forEach((c,i)=>{
  const val = parseFloat(document.getElementById("split_"+i).value) || 0;
  if(val > 0){
    splits.push({Category: c.name, Amount: val});
    total += val;
  }
});

if(Math.abs(total - item.Amount) > 0.01){
  alert("Split must equal total.");
  return;
}

item.Splits = splits;
item.Category = "SPLIT";

updateTotals();
updateProgress();

if(item.id){
  const { error } = await supabaseClient
    .from("transactions")
    .update({
      category: "SPLIT",
      splits: splits
    })
    .eq("id", item.id);

  if(error){
    console.error("Split save error:", error);
    alert("Error saving split to database.");
    return;
  }
}

closeModal();
goNext();
}


/* Category Breakdown Modal */

function showCategoryBreakdown(categoryName){

  modalTitle.innerText = categoryName + " Transactions";
  let html = "";

  const visible = getVisibleIndexes();

  visible.forEach(i => {

    const d = data[i];

    // Normalize main category
    let normalizedCategory = d.Category;
    if(categoryAliases[normalizedCategory]){
      normalizedCategory = categoryAliases[normalizedCategory];
    }

    if(normalizedCategory === categoryName){
      html += `
        <div class="modalItem" onclick="jumpToItem(${i})">
          ${d.Title} ‚Äî $${d.Amount.toFixed(2)}
        </div>
      `;
    }

    // Normalize splits
    if(d.Splits && d.Splits.length){
      d.Splits.forEach(s => {

        let splitCategory = s.Category;
        if(categoryAliases[splitCategory]){
          splitCategory = categoryAliases[splitCategory];
        }

        if(splitCategory === categoryName){
          html += `
            <div class="modalItem" onclick="jumpToItem(${i})">
              ${d.Title} (Split) ‚Äî $${parseFloat(s.Amount).toFixed(2)}
            </div>
          `;
        }

      });
    }

  });

  if(!html) html = "No transactions in this category.";

  modalContent.innerHTML = html;
  openModal();
}

function jumpToItem(index){

// Clear search filter so the item is visible
activeSearchFilter = null;
const clearBtn = document.getElementById("clearSearchBtn");
if(clearBtn) clearBtn.style.display = "none";

// Ensure we are not restricted by Uncategorized filter
if(showOnlyUncategorized && data[index].Category){
showOnlyUncategorized = false;
const toggleBtn = document.getElementById("filterToggle");
if(toggleBtn) toggleBtn.innerText = "Show Only Uncategorized";
}

currentIndex = index;
closeModal();
showCard();

// Scroll to top for clarity (optional but helpful UX)
window.scrollTo({ top: 0, behavior: "smooth" });
}


/* Modal Controls */

const modalSwipeState = {
  startY: 0,
  startX: 0,
  startTime: 0,
  lastY: 0,
  lastTime: 0,
  dragY: 0,
  tracking: false,
  lockedToScroll: false,
  activeScroller: null
};

const MODAL_SWIPE_DISTANCE_PX = 96;
const MODAL_SWIPE_VELOCITY_PX_PER_MS = 0.65;
const MODAL_SWIPE_MIN_DRAG_PX = 10;
const MODAL_SWIPE_RESISTANCE = 0.42;

function getScrollableParent(target, limitEl){
  let node = target;
  while(node && node !== limitEl){
    if(node.scrollHeight > node.clientHeight){
      const style = window.getComputedStyle(node);
      if(style.overflowY === 'auto' || style.overflowY === 'scroll') return node;
    }
    node = node.parentElement;
  }
  return modalContent;
}

function resetModalSheetStyles(sheet){
  sheet.style.transition = '';
  sheet.style.transform = '';
  sheet.style.opacity = '';
}

function animateModalSnapBack(sheet){
  sheet.style.transition = 'transform 280ms cubic-bezier(.22,.61,.36,1), opacity 220ms ease';
  sheet.style.transform = 'translateY(0) scale(1)';
  sheet.style.opacity = '1';
  window.setTimeout(() => {
    if(modalOverlay.classList.contains('isOpen')) resetModalSheetStyles(sheet);
  }, 300);
}

function animateModalCloseFromSwipe(sheet){
  const fromY = Math.max(modalSwipeState.dragY, 0);
  const endY = Math.max(window.innerHeight, sheet.getBoundingClientRect().height + 120);
  sheet.style.transition = 'transform 220ms cubic-bezier(.2,.8,.2,1), opacity 200ms ease';
  sheet.style.transform = `translateY(${fromY}px) scale(1)`;
  sheet.style.opacity = String(Math.max(0.55, 1 - (fromY / 500)));
  requestAnimationFrame(() => {
    sheet.style.transform = `translateY(${endY}px) scale(1)`;
    sheet.style.opacity = '0';
  });
  window.setTimeout(() => {
    resetModalSheetStyles(sheet);
    closeModal();
  }, 220);
}

function openModal(zIndex = 9999){
  modalOverlay.style.display = "flex";
  modalOverlay.style.zIndex = zIndex;
  modalOverlay.classList.add("isOpen");
  document.body.style.overflow = "hidden";
  initModalSwipeClose();
}

function closeModal(){
  modalOverlay.classList.remove("isOpen");
  modalOverlay.style.display = "none";
  modalOverlay.style.zIndex = 9999; // reset to default
  modalContent.innerHTML = "";
  document.body.style.overflow = "";
  setModalCloseButtonVisibility(true);
  closeNumericKeypad(true);
  const sheet = document.querySelector('.modalBox');
  if(sheet) resetModalSheetStyles(sheet);
}

function initModalSwipeClose(){
  const sheet = document.querySelector('.modalBox');
  if(!sheet || sheet.dataset.swipeBound) return;
  sheet.dataset.swipeBound = 'true';

  sheet.addEventListener('touchstart', (e) => {
    if(e.touches.length !== 1) return;
    const t = e.touches[0];
    modalSwipeState.startY = t.clientY;
    modalSwipeState.startX = t.clientX;
    modalSwipeState.startTime = performance.now();
    modalSwipeState.lastY = t.clientY;
    modalSwipeState.lastTime = modalSwipeState.startTime;
    modalSwipeState.dragY = 0;
    modalSwipeState.tracking = true;
    modalSwipeState.activeScroller = getScrollableParent(e.target, sheet);
    modalSwipeState.lockedToScroll = (modalSwipeState.activeScroller?.scrollTop || 0) > 0;
  }, { passive: true });

  sheet.addEventListener('touchmove', (e) => {
    if(!modalSwipeState.tracking || e.touches.length !== 1) return;

    const t = e.touches[0];
    const dy = t.clientY - modalSwipeState.startY;
    const dx = Math.abs(t.clientX - modalSwipeState.startX);

    modalSwipeState.lastY = t.clientY;
    modalSwipeState.lastTime = performance.now();

    if(dx > Math.abs(dy)) return;
    if(dy <= 0) return;

    const scrollerTop = (modalSwipeState.activeScroller?.scrollTop || 0) <= 0;
    if(modalSwipeState.lockedToScroll || !scrollerTop) return;

    if(dy < MODAL_SWIPE_MIN_DRAG_PX) return;

    e.preventDefault();
    modalSwipeState.dragY = dy * MODAL_SWIPE_RESISTANCE;
    sheet.style.transition = 'none';
    sheet.style.transform = `translateY(${modalSwipeState.dragY}px) scale(1)`;
    sheet.style.opacity = String(Math.max(0.78, 1 - (modalSwipeState.dragY / 700)));
  }, { passive: false });

  sheet.addEventListener('touchend', () => {
    if(!modalSwipeState.tracking) return;

    const totalDy = modalSwipeState.lastY - modalSwipeState.startY;
    const totalDt = Math.max(modalSwipeState.lastTime - modalSwipeState.startTime, 1);
    const velocityY = totalDy / totalDt;

    const shouldClose =
      modalSwipeState.dragY >= MODAL_SWIPE_DISTANCE_PX ||
      (totalDy >= MODAL_SWIPE_MIN_DRAG_PX && velocityY >= MODAL_SWIPE_VELOCITY_PX_PER_MS);

    if(shouldClose){
      animateModalCloseFromSwipe(sheet);
    } else if(modalSwipeState.dragY > 0){
      animateModalSnapBack(sheet);
    }

    modalSwipeState.tracking = false;
    modalSwipeState.lockedToScroll = false;
    modalSwipeState.activeScroller = null;
    modalSwipeState.dragY = 0;
  }, { passive: true });

  sheet.addEventListener('touchcancel', () => {
    if(modalSwipeState.dragY > 0) animateModalSnapBack(sheet);
    modalSwipeState.tracking = false;
    modalSwipeState.lockedToScroll = false;
    modalSwipeState.activeScroller = null;
    modalSwipeState.dragY = 0;
  }, { passive: true });
}

modalOverlay.addEventListener("click",function(e){
if(e.target===modalOverlay) closeModal();
});

document.addEventListener("keydown",function(e){
if(e.key==="Escape") closeModal();
});

/* Show Card */

function showCard(){

  if(!data.length){
    cardTitle.innerText = "No Transactions";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    document.getElementById("positionIndicator").innerText = "";
    return;
  }

  const visible = getVisibleIndexes();

  if(visible.length === 0){
    cardTitle.innerText = "No Transactions Found";
    cardMeta.innerHTML = "";
    splitSummary.innerHTML = "";
    currentCategory.innerText = "";
    document.getElementById("positionIndicator").innerText = "";
    return;
  }

  if(!visible.includes(currentIndex)){
    currentIndex = visible[0];
  }

  const position = visible.indexOf(currentIndex) + 1;

  document.getElementById("positionIndicator").innerText =
    `Transaction ${position} of ${visible.length}`;

  const item = data[currentIndex];

  // Clean title
  cardTitle.innerText = item.Title || item.Vendor || "Untitled Transaction";

  cardMeta.innerHTML =
  (item.Vendor ? `Vendor: ${item.Vendor}<br>` : "") +
  (item.Institution ? `Account: ${item.Institution}<br>` : "") +
  (item.Date ? `Date: ${item.Date}<br>` : "") +
  `Amount: $${item.Amount.toFixed(2)}<br>` +
  (item.receipt_url ? 
    `üìé Receipt Attached<br>
     <button class="viewBtn" onclick="viewReceipt()">View Receipt</button>
     <button class="removeBtn" onclick="removeReceipt()">Remove Attachment</button><br>` 
    : ""
  ) +
  `<label class="receiptUploadLabel" for="receiptUploadInput">üìé Upload / Replace Receipt</label>
  <input id="receiptUploadInput" class="receiptUploadInput" type="file" accept="image/*,.pdf" onchange="attachReceipt(event)">

  <button onclick="askAI()" style="
    background:#000;
    color:white;
    padding:10px;
    border-radius:10px;
    margin-top:8px;
    width:100%;
  ">
    ü§ñ Ask AI
  </button>

  <button class="removeBtn" onclick="deleteTransaction()">Delete Transaction</button>
  `;

  splitSummary.innerHTML = buildSplitSummaryHTML(item);

  const categoryLabel = item.Splits && item.Splits.length
    ? "Split transaction"
    : (item.Category || "Uncategorized");

  currentCategory.innerHTML = `<span class="currentCategoryBadge">Current Category: ${categoryLabel}</span>`;
}

/* Totals */

function updateTotals(){

  let totalsObj = {};

  // Build totals object dynamically from categories (stored in cents)
  categories.forEach(c => totalsObj[c.name] = 0);

  const visible = getVisibleIndexes();

  visible.forEach(i => {

    const d = data[i];

    const addAmount = (cat, amount) => {
      if(!cat || cat.trim() === ""){
        return; // skip uncategorized entirely
      }

      if(categoryAliases[cat]){
        cat = categoryAliases[cat];
      }

      const cents = Math.round(parseFloat(amount || 0) * 100);

      if(totalsObj[cat] != null){
        totalsObj[cat] += cents;
      }
    };

    // Handle splits
    if(d.Splits && d.Splits.length){

      d.Splits.forEach(s => {
        addAmount(s.Category, s.Amount);
      });

    } else {

      addAmount(d.Category, d.Amount);

    }

  });

  // Render totals UI
  totals.innerHTML = "";

  Object.keys(totalsObj).forEach(k => {
    totals.innerHTML += `
      <div class="totalRow" onclick="showCategoryBreakdown('${k}')">
        <div>${k}</div>
        <div>$${(totalsObj[k] / 100).toFixed(2)}</div>
      </div>
    `;
  });

}


/* Progress */

function updateProgress(){
const visible = getVisibleIndexes();
const total = visible.length;
const done = visible.filter(i => data[i].Category).length;
const percent=total?Math.round((done/total)*100):0;
progressBar.style.width=percent+"%";
progressText.innerText=`${done} of ${total} categorized (${percent}%)`;
}

/* Export */

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Categorized");
XLSX.writeFile(wb,"Categorized.xlsx");
}

async function connectBank() {

  const res = await fetch(
    "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/create-link-token",
    {
      method: "POST",
      headers: await getAuthHeaders()
    }
  );

  const linkData = await res.json();

  if (!linkData.link_token) {
    alert("Failed to create link token");
    console.error(linkData);
    return;
  }

  const handler = Plaid.create({
    token: linkData.link_token,

    onSuccess: async (public_token) => {

      // Exchange token
      const exchangeRes = await fetch(
        "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/exchange-token",
        {
          method: "POST",
          headers: await getAuthHeaders(),
          body: JSON.stringify({ public_token })
        }
      );

      const exchangeData = await exchangeRes.json();

      if (!exchangeRes.ok) {
        console.error(exchangeData);
        alert("Token exchange failed");
        return;
      }

// Sync transactions
const { data: { session } } = await supabaseClient.auth.getSession();

const syncRes = await fetch(
  "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/sync-plaid-transactions",
  {
    method: "POST",
    headers: await getAuthHeaders(),
    body: JSON.stringify({
      user_id: session.user.id
    })
  }
);

      const syncData = await syncRes.json();

      if (!syncRes.ok) {
        console.error(syncData);
        alert("Transaction sync failed");
        return;
      }

      await loadTransactions();

      alert("Bank connected and transactions imported!");
    },

    onExit: function(err) {
      if (err) console.log("Plaid exit error:", err);
    }
  });

  handler.open();
}

async function askAI(){

  const item = data[currentIndex];

  // STEP 1: Ask user for context FIRST
  modalTitle.innerText = "ü§ñ AI Categorization";

  modalContent.innerHTML = `
    <div style="padding:10px;">

      <div style="margin-bottom:10px;">
        <strong>What was this purchase for?</strong>
      </div>

      <textarea id="aiUserInput" placeholder="Example: we bought keys for the shop, packaging supplies, resale items..." style="
        width:100%;
        height:100px;
        padding:10px;
        border-radius:10px;
        border:1px solid #ddd;
        margin-bottom:12px;
        font-size:14px;
      "></textarea>

      <button onclick="submitAIRequest()" style="
        background:#000;
        color:white;
        padding:12px;
        border-radius:10px;
        width:100%;
      ">
        Ask AI
      </button>

    </div>
  `;

  openModal();
}

async function submitAIRequest(){

  const item = data[currentIndex];
  const userInput = document.getElementById("aiUserInput").value;

  if(!userInput.trim()){
    alert("Please enter a quick description.");
    return;
  }

  modalContent.innerHTML = `
    <div style="padding:10px;">
      <strong>Analyzing transaction...</strong>
    </div>
  `;

  try {

    const response = await fetch(
      "https://xbayklklcdohewvnbglq.supabase.co/functions/v1/ask-ai",
      {
        method: "POST",
        headers: await getAuthHeaders(),
 body: JSON.stringify({
  userInput: userInput,
  categories: categories.map(c => c.name)
})
      }
    );

    const result = await response.json();

    if(!response.ok){
      throw new Error(result.error || "AI request failed");
    }

    modalContent.innerHTML = `
      <div style="padding:10px;">

        <div style="font-size:16px; margin-bottom:10px;">
          <strong>Suggested Category:</strong><br>
          <span style="color:#2e7d32; font-size:18px;">
            ${result.category}
          </span>
        </div>

        <div style="margin-bottom:15px;">
          <strong>Reasoning:</strong><br>
         ${result.reasoning}
<br><br>
Confidence: <strong>${result.confidence}</strong>
        </div>

        <button onclick="applyAISuggestion('${result.category}')" style="
  background:#2e7d32;
  color:white;
  padding:12px;
  border-radius:10px;
  width:100%;
  margin-bottom:8px;
">
  ‚úÖ Accept Suggestion
</button>

        <button onclick="askAI()" style="
          background:#ccc;
          padding:12px;
          border-radius:10px;
          width:100%;
        ">
          Try Again
        </button>

      </div>
    `;

  } catch(err){
    console.error(err);

    modalContent.innerHTML = `
      <div style="padding:10px; color:red;">
        Error getting AI suggestion
      </div>
    `;
  }
}

function applyAISuggestion(category){

  // ‚úÖ RECEIPT MODE
  if(aiContext && aiContext.type === "receipt"){

    const item = data[currentIndex];
    const index = aiContext.index;
    const suggestion = item.receipt_analysis.items[index];

    if(!item.Splits) item.Splits = [];

    let existing = item.Splits.find(s => s.item_index === index);

    if(existing){
      existing.Category = category;
    } else {
      item.Splits.push({
        item_index: index,
        Category: category,
        Amount: parseFloat(suggestion.amount || 0)
      });
    }

    suggestion._accepted = true;

    // ‚úÖ CLOSE ONLY AI SCREEN
    closeModal();

    // ‚úÖ RETURN TO RECEIPT REVIEW
    renderReceiptSuggestions(item, item.receipt_analysis.items);

    updateRemainingUI();
    updateSplitSummaryUI();
    updateTotals();

    aiContext = null;
    return;
  }

  // NORMAL FLOW
  const item = data[currentIndex];

  item.Category = category;
  item.Splits = [];

  updateTotals();
  updateProgress();

  if(item.id){
    supabaseClient
      .from("transactions")
      .update({
        category: category,
        splits: []
      })
      .eq("id", item.id);
  }

  closeModal();
  goNext();
}

function changeCategory(itemId, index){

  aiContext = {
    type: "receipt",
    index: index,
    itemId: itemId,
    mode: "change"
  };

  // üî• IMPORTANT: do NOT close modal
  openReceiptCategorySelector(index);
}

function selectCategory(category){

  // ‚úÖ RECEIPT MODE (Change OR Accept)
  if(aiContext && aiContext.type === "receipt"){

    const item = data[currentIndex];
    const index = aiContext.index;
    const suggestion = item.receipt_analysis.items[index];

    if(!item.Splits) item.Splits = [];

    let existing = item.Splits.find(s => s.item_index === index);

    if(existing){
      existing.Category = category; // update only
    } else {
      item.Splits.push({
        item_index: index,
        Category: category,
        Amount: parseFloat(suggestion.amount || 0)
      });
    }

    suggestion._accepted = true;

    // ‚úÖ DO NOT close full modal
    // ‚úÖ Just re-render inside it
    renderReceiptSuggestions(item, item.receipt_analysis.items);

    updateRemainingUI();
    updateSplitSummaryUI();
    updateTotals();

    aiContext = null;
    return;
  }

  // NORMAL FLOW (unchanged)
  categorize(category);
  closeModal();
}

</script>
</body>
</html>
