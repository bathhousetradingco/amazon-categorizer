62
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:20px; background:#f4f4f4;}
h2 { text-align:center; }
.panel { background:white; padding:16px; border-radius:14px; box-shadow:0 6px 25px rgba(0,0,0,.08); margin-bottom:15px;}
button { cursor:pointer; border:none; border-radius:10px; padding:12px; font-weight:600;}
input, select { padding:10px; border-radius:10px; border:1px solid #ddd; width:100%;}
.navBtn { width:48%; background:#444; color:white;}
.category-btn { width:100%; margin-bottom:6px; color:white;}
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.searchBtn { background:#000; color:white; margin-bottom:8px; }
.clearFilterBtn { background:#c62828; color:white; margin-bottom:8px; display:none; }
.progress-bar-container { background:#eee; border-radius:999px; overflow:hidden; height:16px; margin-bottom:8px;}
.progress-bar { height:100%; background:#2e7d32; width:0%;}
.small { font-size:13px; color:#555;}
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:6px 0; cursor:pointer; border-bottom:1px solid #eee;}
.totalRow:hover { background:#f5f5f5; }
.splitBox { background:#fafafa; padding:10px; border-radius:10px;}
.viewBtn { background:#1565c0; color:white; margin-top:6px;}
.removeBtn { background:#c62828; color:white; margin-top:6px;}
.modalOverlay {
position:fixed;
top:0; left:0;
width:100%; height:100%;
background:rgba(0,0,0,.6);
display:none;
justify-content:center;
align-items:center;
z-index:9999;
}
.modalBox {
background:white;
width:95%;
max-width:1100px;
max-height:90%;
overflow:auto;
border-radius:14px;
padding:20px;
}
.modalClose {
background:#c62828;
color:white;
margin-top:10px;
width:100%;
}
.modalItem {
padding:8px;
border-bottom:1px solid #eee;
cursor:pointer;
}
.modalItem:hover { background:#f5f5f5; }
.filterBtn {
background:#ff9800;
color:white;
margin-top:8px;
}
.receiptPreview img { max-width:100%; height:auto; }
.receiptPreview iframe { width:100%; height:75vh; border:none; }
.splitSideBySide { display:flex; gap:20px; }
.splitLeft { flex:1; border-right:1px solid #eee; padding-right:10px; }
.splitRight { flex:1; }
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<button class="searchBtn" onclick="openSearch()">ðŸ”Ž Search Vendor or Amount</button>
<button id="clearFilterBtn" class="clearFilterBtn" onclick="clearSearchFilter()">Clear Search Filter</button>

<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">
<h3 id="cardTitle"></h3>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>
<div id="splitSummary"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">â¬… Back</button>
<button class="navBtn" onclick="goNext()">Next âž¡</button>
</div>

<h4>Choose Category</h4>
<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>

</div>

<div id="modalOverlay" class="modalOverlay">
<div class="modalBox">
<h3 id="modalTitle"></h3>
<div id="modalContent"></div>
<button class="modalClose" onclick="closeModal()">Close</button>
</div>
</div>

<script>

let rawRows=[];
let headers=[];
let data=[];
let currentIndex=0;
let showOnlyUncategorized=false;
let activeSearchFilter=null;

const categories=[
{name:"COGS - Ingredients",class:"cogs"},
{name:"COGS - Packaging",class:"cogs"},
{name:"COGS - Resale Inventory",class:"cogs"},
{name:"COGS - Production Supplies",class:"cogs"},
{name:"COGS - Shipping from Suppliers",class:"cogs"},
{name:"Equipment",class:"expense"},
{name:"Advertising & Marketing",class:"expense"},
{name:"Website & Software",class:"expense"},
{name:"Merchant Processing Fees",class:"expense"},
{name:"Insurance",class:"expense"},
{name:"Utilities",class:"expense"},
{name:"Professional Services",class:"expense"},
{name:"Needs Review",class:"special"}
];

/* CSV */
document.getElementById("csvFile").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;
Papa.parse(file,{
header:false,
skipEmptyLines:true,
complete:res=>{
headers=res.data[0].map(h=>String(h).trim());
rawRows=res.data.slice(1);
showMapping();
}
});
});

/* Search */

function openSearch(){
modalTitle.innerText="Search Vendor or Amount";
modalContent.innerHTML=`
<input type="text" id="searchInput" placeholder="Type vendor or amount..." oninput="renderSearchResults()">
<div id="searchResults"></div>
`;
openModal();
}

function renderSearchResults(){
const query=document.getElementById("searchInput").value.toLowerCase().trim();
const results=document.getElementById("searchResults");
results.innerHTML="";
if(!query) return;

data.forEach((d,i)=>{
const vendorMatch=d.Vendor && d.Vendor.toLowerCase().includes(query);
const amountMatch=d.Amount.toFixed(2).includes(query);
if(vendorMatch || amountMatch){
results.innerHTML+=`
<div class="modalItem" onclick="applySearchFilter('${d.Vendor||""}', ${d.Amount})">
${d.Vendor||"Unknown"} â€” $${d.Amount.toFixed(2)}
</div>`;
}
});
}

function applySearchFilter(vendor, amount){
activeSearchFilter={vendor,amount};
document.getElementById("clearFilterBtn").style.display="block";
closeModal();
let visible=getVisibleIndexes();
currentIndex=visible.length?visible[0]:0;
showCard();
}

function clearSearchFilter(){
activeSearchFilter=null;
document.getElementById("clearFilterBtn").style.display="none";
currentIndex=0;
showCard();
}

/* Filter */

function toggleFilter(){
showOnlyUncategorized=!showOnlyUncategorized;
filterToggle.innerText=showOnlyUncategorized?"Show All Transactions":"Show Only Uncategorized";
updateProgress();
showCard();
}

function getVisibleIndexes(){
let indexes=data.map((_,i)=>i);
if(showOnlyUncategorized){
indexes=indexes.filter(i=>!data[i].Category);
}
if(activeSearchFilter){
indexes=indexes.filter(i=>{
let match=true;
if(activeSearchFilter.vendor)
match=match && data[i].Vendor===activeSearchFilter.vendor;
if(activeSearchFilter.amount)
match=match && data[i].Amount===activeSearchFilter.amount;
return match;
});
}
return indexes;
}

/* Navigation */

function goNext(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos<visible.length-1){
currentIndex=visible[pos+1];
showCard();
}
}

function goBack(){
const visible=getVisibleIndexes();
let pos=visible.indexOf(currentIndex);
if(pos>0){
currentIndex=visible[pos-1];
showCard();
}
}
