<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:20px;
  background:#f4f4f4;
}
h2 { text-align:center; }
.panel {
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.08);
  margin-bottom:15px;
}
button {
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  font-weight:600;
}
.navBtn { width:48%; background:#444; color:white; }
.category-row { display:flex; align-items:center; margin-bottom:6px; }
.category-btn { flex:1; color:white; }
.info-btn { width:40px; margin-left:6px; background:#ddd; font-weight:bold; }
.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}
.progress-bar-container {
  background:#eee; border-radius:999px; overflow:hidden;
  height:16px; margin-bottom:8px;
}
.progress-bar { height:100%; background:#2e7d32; width:0%; }
.small { font-size:13px; color:#555; }
.totalRow { display:flex; justify-content:space-between; font-size:13px; padding:4px 0; }
.modal {
  display:none; position:fixed; z-index:1000;
  left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,.6);
}
.modal-content {
  background:white; margin:15% auto;
  padding:20px; width:90%; max-width:500px;
  border-radius:14px;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>
<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>

<div id="app" style="display:none;">

<div class="panel">
<div class="progress-bar-container">
<div id="progressBar" class="progress-bar"></div>
</div>
<div id="progressText" class="small"></div>
</div>

<div class="panel">

<div id="cardTitle">Upload CSV to begin</div>
<div id="cardMeta" class="small"></div>
<div id="currentCategory" class="small" style="margin-top:6px;"></div>

<div id="suggestionBox" class="small" style="margin-top:10px;"></div>

<hr>

<div style="display:flex; justify-content:space-between; margin-bottom:12px;">
<button class="navBtn" onclick="goBack()">⬅ Back</button>
<button class="navBtn" onclick="goNext()">Next ➡</button>
</div>

<div id="categoryButtons"></div>
</div>

<div class="panel">
<h4>Totals</h4>
<div id="totals"></div>
</div>

<button onclick="exportExcel()">Export to Excel</button>
<button onclick="clearProgress()" style="background:#c62828;color:white;margin-top:10px;">Reset Saved Progress</button>

</div>

<script>

const STORAGE_KEY = "bathhouse_categorizer_v7";
const LEARN_KEY = "bathhouse_learning_v1";

let rawRows=[], data=[], headers=[];
let currentIndex=0;
let learning = JSON.parse(localStorage.getItem(LEARN_KEY)) || { keywords:{} };

/* ---------------- CATEGORY LOGIC ---------------- */

const categoryDefinitions = {
  "COGS – Ingredients": {
    businessLogic:
      "This item appears to be a raw material used in manufacturing finished goods such as soaps, skincare, or home products.",
    taxLogic:
      "Ingredients are classified as Cost of Goods Sold because they physically become part of the inventory that is sold to customers.",
    keywords:["oil","butter","lye","fragrance","essential","mica","extract","wax","preservative"]
  },
  "COGS – Packaging": {
    businessLogic:
      "This item appears to be packaging used to contain or present finished goods to customers.",
    taxLogic:
      "Packaging that accompanies finished goods is classified as Cost of Goods Sold because it is directly associated with inventory sold.",
    keywords:["box","bottle","jar","lid","label","mailer","tissue","shipping","pump"]
  },
  "COGS – Production Supplies": {
    businessLogic:
      "This appears to be a consumable supply used during production but not part of the finished product.",
    taxLogic:
      "Production supplies are included in COGS because they are directly tied to the manufacturing process.",
    keywords:["gloves","alcohol","liner","paper towel","sanitizer"]
  },
  "Equipment": {
    businessLogic:
      "This item appears to be a durable tool or asset used repeatedly in production or operations.",
    taxLogic:
      "Equipment is not COGS because it does not become part of the finished product and typically has a useful life beyond one production cycle.",
    keywords:["mold","mixer","printer","shelving","table","rack","machine"]
  },
  "Website & Software": {
    businessLogic:
      "This appears to be a digital tool or subscription used to operate the business.",
    taxLogic:
      "Software and subscriptions are operating expenses rather than inventory costs.",
    keywords:["shopify","quickbooks","canva","taxjar","subscription"]
  }
};

/* ---------------- UTILITIES ---------------- */

function normalize(text){
  return text.toLowerCase().replace(/[^\w\s]/g,"");
}

/* ---------------- SUGGESTION ENGINE ---------------- */

function generateSuggestion(title,vendor){

  const text = normalize(title + " " + vendor);
  let scores = {};
  let reasons = [];

  Object.keys(categoryDefinitions).forEach(cat=>{
    scores[cat]=0;
    categoryDefinitions[cat].keywords.forEach(k=>{
      if(text.includes(k)){
        scores[cat]+=15;
        reasons.push(`Matched keyword "${k}" linked to ${cat}.`);
      }
    });
  });

  Object.keys(learning.keywords).forEach(k=>{
    if(text.includes(k)){
      scores[learning.keywords[k]]+=30;
      reasons.push(`Previously categorized similar item containing "${k}".`);
    }
  });

  let best = Object.keys(scores).reduce((a,b)=>scores[a]>scores[b]?a:b);
  let confidence = scores[best];
  let level = confidence>=70?"High":confidence>=40?"Medium":"Low";

  if(confidence===0) best="Needs Review";

  return { category:best, confidence, level, reasons };
}

/* ---------------- APPLY SUGGESTIONS ---------------- */

function applySuggestions(){
  data.forEach(d=>{
    d.Suggestion = generateSuggestion(d.Title,d.Vendor);
  });
}

/* ---------------- LEARNING ---------------- */

function learnFromOverride(title,category){
  const words = normalize(title).split(" ");
  words.forEach(w=>{
    if(w.length>4){
      learning.keywords[w]=category;
    }
  });
  localStorage.setItem(LEARN_KEY,JSON.stringify(learning));
}

/* ---------------- UI ---------------- */

function renderSuggestion(item){

  const s = item.Suggestion;
  if(!s) return;

  const def = categoryDefinitions[s.category];

  let explanation = def ?
    `<b>Why this fits:</b><br><br>
     ${def.businessLogic}<br><br>
     ${def.taxLogic}<br><br>
     <b>Pattern reasoning:</b><br>${s.reasons.join("<br>")}`
    :
    "No strong pattern detected. Manual review recommended.";

  document.getElementById("suggestionBox").innerHTML = `
    <div style="padding:10px;border:1px solid #ddd;border-radius:10px;">
      <b>Suggested Category:</b> ${s.category} (${s.level} Confidence)
      <br><br>
      <button onclick="acceptSuggestion()">Accept Suggestion</button>
      <button onclick="toggleExplanation()">▶ Show detailed reasoning</button>
      <div id="explanationPanel" style="display:none;margin-top:10px;font-size:13px;">
        ${explanation}
      </div>
    </div>
  `;
}

function toggleExplanation(){
  const panel=document.getElementById("explanationPanel");
  panel.style.display = panel.style.display==="none"?"block":"none";
}

function acceptSuggestion(){
  const item=data[currentIndex];
  item.Category=item.Suggestion.category;
  updateTotals();
  updateProgress();
  showCard();
  saveProgress();
}

function categorize(name){
  const item=data[currentIndex];
  if(item.Suggestion && item.Suggestion.category!==name){
    learnFromOverride(item.Title,name);
  }
  item.Category=name;
  if(currentIndex<data.length-1) currentIndex++;
  showCard();
  updateTotals();
  updateProgress();
  saveProgress();
}

function showCard(){
  if(!data.length)return;
  const item=data[currentIndex];
  document.getElementById("cardTitle").innerText=item.Title;
  document.getElementById("cardMeta").innerHTML=
    (item.Vendor?`Vendor: ${item.Vendor}<br>`:"")+
    (item.Date?`Date: ${item.Date}<br>`:"")+
    `Amount: $${item.Amount.toFixed(2)}`;
  document.getElementById("currentCategory").innerText=
    "Current: "+(item.Category||"—");
  renderSuggestion(item);
}

/* --------- Remaining original functions unchanged --------- */

function goBack(){ if(currentIndex>0){ currentIndex--; showCard(); } }
function goNext(){ if(currentIndex<data.length-1){ currentIndex++; showCard(); } }
function updateTotals(){
  let totals={};
  data.forEach(d=>{
    if(d.Category){
      totals[d.Category]=(totals[d.Category]||0)+d.Amount;
    }
  });
  const div=document.getElementById("totals");
  div.innerHTML="";
  Object.keys(totals).forEach(k=>{
    div.innerHTML+=`<div class="totalRow"><div>${k}</div><div>$${totals[k].toFixed(2)}</div></div>`;
  });
}
function updateProgress(){
  const done=data.filter(d=>d.Category).length;
  const total=data.length;
  const percent=total?Math.round((done/total)*100):0;
  document.getElementById("progressBar").style.width=percent+"%";
  document.getElementById("progressText").innerText=
    `${done} of ${total} categorized (${percent}%)`;
}
function saveProgress(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({data,currentIndex}));
}
function loadProgress(){
  const saved=localStorage.getItem(STORAGE_KEY);
  if(!saved)return;
  const parsed=JSON.parse(saved);
  data=parsed.data||[];
  currentIndex=parsed.currentIndex||0;
  if(data.length){
    document.getElementById("app").style.display="block";
    showCard();
    updateTotals();
    updateProgress();
  }
}
function clearProgress(){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Categorized");
  XLSX.writeFile(wb,"Categorized.xlsx");
}

window.onload=loadProgress;

</script>
</body>
</html>