latest 16

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bathhouse Categorizer</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:20px;
  background:#f4f4f4;
}

h2 { text-align:center; }

.panel {
  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 25px rgba(0,0,0,.08);
  margin-bottom:15px;
}

button {
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:12px;
  font-weight:600;
}

.navBtn {
  width:48%;
  background:#444;
  color:white;
}

.category-row {
  display:flex;
  align-items:center;
  margin-bottom:6px;
}

.category-btn {
  flex:1;
  color:white;
}

.cogs{background:#2e7d32;}
.expense{background:#1565c0;}
.special{background:#8e24aa;}

.progress-bar-container {
  background:#eee;
  border-radius:999px;
  overflow:hidden;
  height:16px;
  margin-bottom:8px;
}

.progress-bar {
  height:100%;
  background:#2e7d32;
  width:0%;
}

.small { font-size:13px; color:#555; }

.totalRow {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:4px 0;
}
</style>
</head>

<body>

<h2>Bathhouse Categorizer</h2>

<input type="file" id="csvFile" accept=".csv">

<div id="mappingPanel" class="panel" style="display:none;"></div>
<div id="app" style="display:none;"></div>

<script>

const STORAGE_KEY = "bathhouse_categorizer_v13";

let rawRows=[], data=[], headers=[];
let currentIndex=0;

/* ================= CSV Upload (HARDENED) ================= */

document.getElementById("csvFile").addEventListener("change", function(e){

  const file = e.target.files[0];
  if(!file) return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    dynamicTyping:false,
    complete:function(results){

      if(results.errors && results.errors.length){
        console.error("CSV Parse Errors:", results.errors);
        alert("There was an issue reading this CSV file.");
        return;
      }

      if(!results.data || !results.data.length){
        alert("CSV file appears empty or improperly formatted.");
        return;
      }

      rawRows = results.data;

      // Safely extract headers from first non-empty row
      const firstValidRow = rawRows.find(r => r && Object.keys(r).length);
      if(!firstValidRow){
        alert("Unable to detect CSV headers.");
        return;
      }

      headers = Object.keys(firstValidRow).filter(h => h && h.trim() !== "");

      if(!headers.length){
        alert("No valid column headers detected.");
        return;
      }

      showMapping();
    }
  });

});

/* ================= Mapping UI ================= */

function showMapping(){
  const panel=document.getElementById("mappingPanel");
  panel.style.display="block";

  panel.innerHTML=`
    <h4>Map Columns</h4>
    Title:<br>${dropdown("mapTitle")}<br><br>
    Amount:<br>${dropdown("mapAmount")}<br><br>
    Vendor (optional):<br>${dropdown("mapVendor",true)}<br><br>
    Date (optional):<br>${dropdown("mapDate",true)}<br><br>
    Existing Category (optional):<br>${dropdown("mapExistingCategory",true)}<br><br>
    <button onclick="confirmMapping()">Confirm</button>
  `;
}

function dropdown(id,allowEmpty=false){
  let html=`<select id="${id}">`;
  if(allowEmpty) html+=`<option value="">--None--</option>`;
  headers.forEach(h=>{
    html+=`<option value="${h}">${h}</option>`;
  });
  html+="</select>";
  return html;
}

/* ================= Confirm Mapping ================= */

function confirmMapping(){

  const t=document.getElementById("mapTitle").value;
  const a=document.getElementById("mapAmount").value;
  const v=document.getElementById("mapVendor").value;
  const d=document.getElementById("mapDate").value;
  const c=document.getElementById("mapExistingCategory").value;

  if(!t || !a){
    alert("Title and Amount are required.");
    return;
  }

  data = rawRows.map(r=>({
    Title:r[t]||"",
    Amount:parseFloat(String(r[a]).replace(/[$,]/g,""))||0,
    Vendor:v?r[v]||"":"",
    Date:d?r[d]||"",
    Category:c?(r[c]||""):""
  }));

  document.getElementById("mappingPanel").style.display="none";
  alert("CSV loaded successfully. Ready to categorize.");
}

</script>
</body>
</html>
